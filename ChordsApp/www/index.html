<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>aChordim | The Faith Sound</title>

    <link rel="icon" type="image/svg+xml" href="achordim-icon-app.svg">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="aChordim">

    <link rel="stylesheet" href="styles-bw.css?v=1">
    <!-- PayPal SDK is loaded dynamically in paypal-subscription.js based on environment -->

    <!-- PDF.js for PDF preview -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- html2canvas for Save as Image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- QRCode.js for session QR codes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Localization -->
    <script src="js/translations.js"></script>
    <script src="js/localization.js"></script>

    <!-- Web Logger (localhost only - sends console logs to server for debugging) -->
    <script src="js/web-logger.js"></script>
</head>

<body>
    <header class="app-header">
        <div class="header-container">
            <div style="display: flex; align-items: center; gap: 10px;">
                <button id="sideMenuToggle" class="hamburger-btn" title="Open Menu"
                    style="padding: 4px 0; border: none; background: transparent; cursor: pointer; color: var(--text); line-height: 1; display: flex; flex-direction: column; gap: 5px;">
                    <span style="width: 22px; height: 2px; background: var(--text);"></span>
                    <span style="width: 22px; height: 2px; background: var(--text);"></span>
                    <span style="width: 22px; height: 2px; background: var(--text);"></span>
                </button>
                <a href="https://www.thefaithsound.com/ChordsApp/www/" class="header-brand"
                    style="text-decoration: none; display: flex; flex-direction: column; line-height: 1.15; justify-content: center;">
                    <span class="header-brand-name" style="font-weight: 700; font-size: 1.2rem; color: var(--text);">א/aChordim</span>
                    <span class="header-brand-url" style="font-size: 0.6rem; color: var(--text-muted); opacity: 0.7;">www.thefaith<span
                            style="color: var(--text); opacity: 1;">sound</span>.com</span>
                </a>
            </div>
            <div class="header-actions">

                <div style="position: relative;">
                    <button class="ghost-button" id="signInButton" type="button" data-i18n="nav.signin">Sign In</button>
                    <div id="profileMenu"
                        style="display: none; position: absolute; top: 45px; right: 0; background: var(--surface); border: 1px solid var(--border); padding: 8px; min-width: 150px; z-index: 1000;">
                        <button id="mySubscriptionBtn" data-i18n="nav.profile.subscription"
                            style="width: 100%; padding: 8px 12px; background: transparent; color: var(--text); border: none; text-align: left; cursor: pointer; transition: background 0.2s;">My
                            Subscription</button>
                        <button id="signOutBtn" data-i18n="nav.signout"
                            style="width: 100%; padding: 8px 12px; background: transparent; color: var(--text); border: none; text-align: left; cursor: pointer; transition: background 0.2s;">Sign
                            Out</button>
                    </div>
                </div>
                <button id="themeToggle" type="button" title="Toggle theme">Light</button>
            </div>
        </div>
    </header>

    <!-- Navigation Tab Bar -->
    <nav id="appNavBar" class="app-nav-bar">
        <div class="nav-bar-container">
            <button class="nav-tab active" data-tab="scanner">
                <span class="nav-tab-label" data-i18n="nav.tab.scanner">Scanner</span>
            </button>
            <button class="nav-tab" data-tab="songbook">
                <span class="nav-tab-label" data-i18n="nav.tab.songbook">Song Book</span>
            </button>
            <button class="nav-tab" data-tab="livesession">
                <span class="nav-tab-label" data-i18n="nav.tab.livesession">Live</span>
            </button>
            <button class="nav-tab" data-tab="tools">
                <span class="nav-tab-label" data-i18n="nav.tab.tools">Tools</span>
            </button>
        </div>
        <!-- Live Session sub-menu (hidden by default) -->
        <div id="liveSessionSubmenu" class="nav-submenu" style="display: none;">
            <button class="nav-submenu-btn" id="navCreateSession" data-i18n="nav.sub.create">Create</button>
            <button class="nav-submenu-btn" id="navJoinSession" data-i18n="nav.sub.join">Join</button>
            <button class="nav-submenu-btn" id="navMySessions" data-i18n="nav.sub.mysessions">My Sessions</button>
        </div>
    </nav>

    <!-- Tools Combined View (hidden by default) -->
    <section id="toolsCombinedView" class="tools-combined-view" style="display: none;">
        <div class="tools-combined-container">
            <div class="tools-panel" id="toolsMetronomePanel"></div>
            <div class="tools-panel" id="toolsPadsPanel"></div>
        </div>
    </section>

    <main class="container">
        <section class="hero" id="top">
            <div class="hero-text">
                <h1 data-i18n="hero.title">Turn any chord sheet into a clean, printable chart!</h1>
                <p data-i18n="hero.subtitle">Upload a handwritten sheet or photo, extract the music, refine the result,
                    transpose to any key, then
                    print with confidence.</p>
            </div>
        </section>

        <section class="workflow" id="workflow">
            <h2 data-i18n="workflow.title">Three simple steps</h2>
            <div class="workflow-grid">
                <article class="step-card">
                    <span class="step-number" data-i18n="step1.number">1</span>
                    <h3 data-i18n="step1.title">Upload your chart</h3>
                    <p data-i18n="step1.desc">Accepts images (JPG, PNG, HEIC) and PDFs. High contrast photos deliver the
                        best recognition
                        results.</p>
                    <input id="chartFileInput" class="sr-only" type="file" accept="image/*,.pdf">
                    <label class="primary-action" for="chartFileInput" style="width: 100%;"
                        data-i18n="step1.btn">Upload</label>
                    <div class="preview-panel" id="uploadPreview">
                        <img id="previewImage" alt="Uploaded chart preview">
                        <p class="preview-placeholder" data-i18n="step1.placeholder">No file selected yet. Supported:
                            JPG, PNG, HEIC, PDF.</p>
                    </div>
                </article>
                <article class="step-card">
                    <span class="step-number" data-i18n="step2.number">2</span>
                    <h3 data-i18n="step2.title">transcription ready!</h3>
                    <p data-i18n="step2.desc">Edit visually in the bottom Editor.</p>
                    <label
                        style="display: block; margin-top: 12px; font-size: 0.9rem; color: var(--text); cursor: pointer; user-select: none;">
                        <input type="checkbox" id="autoAnalyzeCheckbox" checked
                            style="margin-right: 8px; cursor: pointer;">
                        <span data-i18n="step2.auto_analyze">Auto-analyze uploads</span> <span
                            data-i18n="step2.recommended"
                            style="color: var(--text-muted); font-size: 0.8rem;">(recommended)</span>
                    </label>
                    <button id="analyzeButton" class="primary-action" disabled
                        data-i18n="step2.btn.analyze">Analyze</button>
                    <label id="intenseScanOption"
                        style="display: none; margin-top: 8px; font-size: 0.85rem; color: var(--text-muted); cursor: pointer; user-select: none;">
                        <input type="checkbox" id="intenseScanCheckbox" style="margin-right: 6px; cursor: pointer;">
                        <span style="color: var(--text);"></span> <span data-i18n="step2.intense">Intense Scan</span> <span
                            data-i18n="step2.intense.desc" style="color: var(--text-muted); font-size: 0.75rem;">(Pro -
                            better for hard scans)</span>
                    </label>
                    <div class="status-panel" id="analysisStatus" role="status" aria-live="polite">
                        <div class="scanner-animation">
                            <div class="scanner-document">
                                <div class="scanner-page">
                                    <div class="scanner-lines">
                                        <span></span><span></span><span></span><span></span><span></span>
                                    </div>
                                    <div class="scanner-music-note">♪</div>
                                </div>
                                <div class="scanner-beam"></div>
                            </div>
                        </div>
                        <div class="status-content">
                            <span class="status-dot idle"></span>
                            <span class="status-text" data-i18n="step2.status.waiting">Waiting for an upload…</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill"></div>
                        </div>
                    </div>
                    <small class="status-hint"><span data-i18n="step2.status.hint">Analysis typically takes 15-60
                            seconds. Supports all languages texts. If
                            the result is not good, try to run analyze again. Processing costs us money - please
                            consider </span><a href="#support"
                            style="color: var(--primary); text-decoration: underline;"
                            data-i18n="step2.donate">donating</a> <span data-i18n="step2.status.hint_end">to
                            keep this free tool running.</span></small>
                </article>
                <article class="step-card">
                    <span class="step-number" data-i18n="step3.number">3</span>
                    <h3 data-i18n="step3.title">Refine, transpose &amp; print</h3>
                    <p data-i18n="step3.desc">Edit chords visually, transpose to any key, and enjoy playing and singing
                        your favorite worship songs beautifully!</p>
                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                        <button id="showAllFeaturesBtn" class="primary-action" data-i18n="step3.btn.features"
                            style="flex: 1; background: var(--text); color: var(--bg);">Show All Features</button>
                        <button id="showRawOutputBtn" class="primary-action" data-i18n="step3.btn.raw"
                            style="flex: 0 0 auto; padding: 12px; background: var(--text); color: var(--bg); font-size: 12px;"
                            title="View raw output">Raw</button>
                    </div>
                    <div class="ai-reference-preview" id="aiReferencePreview"
                        style="flex: 1; display: none; max-height: 300px; overflow-y: auto; background: var(--surface); padding: 12px; margin-top: 8px;">
                        <h4 style="margin: 0 0 8px 0; color: var(--text); font-size: 12px;" data-i18n="step3.raw.title">Raw
                            Output (v4 Format)</h4>
                        <pre class="reference-content" id="aiReferenceContent"
                            style="margin: 0; white-space: pre-wrap; word-break: break-word; font-family: monospace; font-size: 11px; color: var(--text); line-height: 1.4;">transcription will appear here after analysis.</pre>
                    </div>
                </article>
            </div>
        </section>

        <section class="preview-section" id="previewSection">
            <div class="preview-header">
                <div class="preview-header-row">
                    <h2 id="previewHeaderTitle" data-i18n="preview.title">Print Preview</h2>

                    <!-- View Toggle Group -->
                    <div class="header-btn-group view-toggles">
                        <button id="toggleControlsBtn2" class="header-btn display-toggle"
                            data-i18n="preview.btn.controls">Controls</button>
                        <button id="toggleEditorBtn2" class="header-btn display-toggle"
                            data-i18n="preview.btn.editor">Editor</button>
                    </div>

                    <!-- Music Tools Group -->
                    <div class="header-btn-group music-tools">
                        <button class="header-btn pads-btn" id="headerPadsBtn" data-i18n="preview.btn.pads">Pads</button>
                        <button class="header-btn metro-btn" id="headerMetronomeBtn" data-i18n="preview.btn.metro">Metro</button>
                    </div>

                    <!-- Live Session Group -->
                    <div class="header-btn-group live-group">
                        <button class="header-btn go-live-btn" id="headerGoLiveBtn" data-i18n="preview.btn.golive">Go
                            Live</button>
                        <button class="header-btn live-preview-btn" id="headerLivePreview"
                            data-i18n="preview.btn.preview">Preview</button>
                    </div>

                    <div class="header-spacer"></div>

                    <!-- File Actions Group -->
                    <div class="header-btn-group file-actions">
                        <button class="header-btn" id="headerSaveSong" data-i18n="preview.btn.save">Save</button>
                        <button class="header-btn" id="headerLoadSong" data-i18n="preview.btn.load">Load</button>
                        <button class="header-btn" id="headerSaveAsImage" data-i18n="preview.btn.image">Image</button>
                        <button class="header-btn" id="printButton" data-i18n="preview.btn.print">Print</button>
                        <button class="header-btn" id="headerAutoFit" data-i18n="preview.btn.autofit">Auto
                            Fit</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Side Menu Overlay -->
        <div id="sideMenuOverlay" class="side-menu-overlay"></div>

        <!-- Side Menu Panel -->
        <aside id="sideMenuPanel" class="side-menu-panel">
            <div class="side-menu-header">
                <h3 data-i18n="menu.title">Controls</h3>
                <button id="sideMenuClose" class="side-menu-close">&times;</button>
            </div>
            <div class="side-menu-content">
                <!-- Quick Actions -->
                <div class="side-menu-section">
                    <h4 data-i18n="menu.section.actions">Quick Actions</h4>
                    <div class="side-menu-buttons">
                        <button class="side-menu-btn primary" id="sideMenuPrint" data-i18n="menu.btn.print">Print
                            Chart</button>
                        <button class="side-menu-btn orange" id="saveAsImageButton" data-i18n="menu.btn.image">Save
                            as Image</button>
                        <button class="side-menu-btn purple" id="livePreviewToggle" data-i18n="menu.btn.live">Live
                            Preview</button>
                        <button class="side-menu-btn" id="saveLayoutButton" data-i18n="menu.btn.save_layout">Save
                            Layout</button>
                    </div>
                </div>

                <!-- Display Mode -->
                <div class="side-menu-section">
                    <h4 data-i18n="menu.section.display">Display</h4>
                    <div class="side-menu-row">
                        <label data-i18n="menu.label.mode">Mode:</label>
                        <select id="sideMenuNashvilleMode" class="side-menu-select">
                            <option value="chords" selected data-i18n="menu.mode.chords">Chords</option>
                            <option value="both" data-i18n="menu.mode.both">Nashville + Chords</option>
                            <option value="numbers" data-i18n="menu.mode.numbers">Nashville Only</option>
                            <option value="roman_both" data-i18n="menu.mode.roman_both">Roman + Chords</option>
                            <option value="roman" data-i18n="menu.mode.roman">Roman Only</option>
                            <option value="lyrics" data-i18n="menu.mode.lyrics">Lyrics Only</option>
                        </select>
                    </div>
                    <div class="side-menu-row">
                        <label data-i18n="menu.label.fontsize">Font Size:</label>
                        <input type="range" id="sideMenuFontSize" min="8" max="28" value="8.5" step="0.5">
                        <span id="sideMenuFontSizeVal">8.5pt</span>
                    </div>
                    <div class="side-menu-row">
                        <label data-i18n="menu.label.linespacing">Line Spacing:</label>
                        <input type="range" id="sideMenuLineHeight" min="1.0" max="2.0" value="1.2" step="0.1">
                        <span id="sideMenuLineHeightVal">1.2</span>
                    </div>
                    <div class="side-menu-row">
                        <label data-i18n="menu.label.charspacing">Char Spacing:</label>
                        <input type="range" id="sideMenuCharSpacing" min="0" max="8" value="0" step="0.5">
                        <span id="sideMenuCharSpacingVal">0px</span>
                    </div>
                    <div class="side-menu-row">
                        <label class="side-menu-checkbox">
                            <input type="checkbox" id="sideMenuBadges" checked>
                            <span data-i18n="menu.check.badges">Show Badges</span>
                        </label>
                    </div>
                    <div class="side-menu-row">
                        <label class="side-menu-checkbox">
                            <input type="checkbox" id="followArrangementBtn">
                            <span data-i18n="menu.check.arrangement">Follow Arrangement</span>
                        </label>
                    </div>
                    <div class="side-menu-row">
                        <label class="side-menu-checkbox">
                            <input type="checkbox" id="sideMenuShowControls">
                            <span data-i18n="menu.check.controls">Show Main Controls</span>
                        </label>
                    </div>
                    <div class="side-menu-row">
                        <label class="side-menu-checkbox">
                            <input type="checkbox" id="sideMenuShowEditor">
                            <span data-i18n="menu.check.editor">Show Edit Workspace</span>
                        </label>
                    </div>
                    <div class="side-menu-row">
                        <label class="side-menu-checkbox">
                            <input type="checkbox" id="sideMenuShowSongbook">
                            <span data-i18n="menu.check.songbook">Show SongBook Format</span>
                        </label>
                    </div>
                    <div class="side-menu-row">
                        <label class="side-menu-checkbox">
                            <input type="checkbox" id="sideMenuDarkMode">
                            <span data-i18n="menu.check.darkmode">Dark Mode</span>
                        </label>
                    </div>
                    <div class="side-menu-row">
                        <label class="side-menu-checkbox">
                            <input type="checkbox" id="hideEmojisToggle">
                            <span data-i18n="menu.check.hide_emojis">Hide Emojis</span>
                        </label>
                    </div>
                </div>

                <!-- Layout -->
                <div class="side-menu-section">
                    <h4 data-i18n="menu.section.layout">Layout</h4>
                    <div class="side-menu-row">
                        <label data-i18n="menu.label.columns">Columns:</label>
                        <select id="sideMenuColumns" class="side-menu-select">
                            <option value="1" data-i18n="menu.col.1">1 Column</option>
                            <option value="2" selected data-i18n="menu.col.2">2 Columns</option>
                            <option value="3" data-i18n="menu.col.3">3 Columns</option>
                            <option value="4" data-i18n="menu.col.4">4 Columns</option>
                        </select>
                    </div>
                    <div class="side-menu-row">
                        <label>Sections:</label>
                        <select id="sideMenuLanguage" class="side-menu-select">
                            <option value="en" selected>English</option>
                            <option value="he">עברית</option>
                        </select>
                    </div>
                    <button class="side-menu-btn purple full-width" id="sideMenuAutoFit"
                        data-i18n="menu.btn.autofit_full">Auto-fit to 1 Page</button>
                </div>

                <!-- Transpose -->
                <div class="side-menu-section">
                    <h4 data-i18n="menu.section.transpose">Transpose</h4>
                    <div class="side-menu-row">
                        <label data-i18n="menu.label.key">Key:</label>
                        <select id="sideMenuKey" class="side-menu-select">
                            <optgroup label="Major Keys" data-i18n="menu.group.major">
                                <option value="C Major">C Major</option>
                                <option value="D Major">D Major</option>
                                <option value="E Major">E Major</option>
                                <option value="F Major">F Major</option>
                                <option value="G Major">G Major</option>
                                <option value="A Major">A Major</option>
                                <option value="B Major">B Major</option>
                            </optgroup>
                            <optgroup label="Minor Keys" data-i18n="menu.group.minor">
                                <option value="A Minor">A Minor</option>
                                <option value="B Minor">B Minor</option>
                                <option value="C Minor">C Minor</option>
                                <option value="D Minor">D Minor</option>
                                <option value="E Minor">E Minor</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="side-menu-key-grid">
                        <button class="key-btn" data-key="C">C</button>
                        <button class="key-btn" data-key="D">D</button>
                        <button class="key-btn" data-key="E">E</button>
                        <button class="key-btn" data-key="F">F</button>
                        <button class="key-btn" data-key="G">G</button>
                        <button class="key-btn" data-key="A">A</button>
                        <button class="key-btn" data-key="B">B</button>
                    </div>
                    <div class="side-menu-transpose-btns">
                        <button class="side-menu-btn" id="sideMenuTransposeDown">−1</button>
                        <span id="sideMenuTransposeVal">0</span>
                        <button class="side-menu-btn" id="sideMenuTransposeUp">+1</button>
                        <button class="side-menu-btn" id="sideMenuTransposeReset"
                            data-i18n="menu.btn.reset">Reset</button>
                    </div>
                </div>

                <!-- Song Info -->
                <div class="side-menu-section">
                    <h4 data-i18n="menu.section.info">Song Info</h4>
                    <div class="side-menu-row">
                        <label data-i18n="menu.label.bpm">BPM:</label>
                        <input type="number" id="sideMenuBPM" value="120" min="40" max="240" class="side-menu-input">
                    </div>
                    <div class="side-menu-row">
                        <label data-i18n="menu.label.time">Time:</label>
                        <select id="sideMenuTime" class="side-menu-select">
                            <option value="4/4" selected>4/4</option>
                            <option value="3/4">3/4</option>
                            <option value="6/8">6/8</option>
                            <option value="2/4">2/4</option>
                        </select>
                    </div>
                </div>

                <!-- Library -->
                <div class="side-menu-section">
                    <h4 data-i18n="menu.section.library">Library</h4>
                    <div class="side-menu-buttons">
                        <button class="side-menu-btn" id="sideMenuSave" data-i18n="menu.btn.save_song">Save
                            Song</button>
                        <button class="side-menu-btn" id="sideMenuLoad" data-i18n="menu.btn.load_song">Load
                            Song</button>
                        <button class="side-menu-btn" id="sideMenuBulkImport" data-i18n="menu.btn.import">Bulk
                            Import</button>
                        <button class="side-menu-btn" id="sideMenuUpdate" data-i18n="menu.btn.update">Update
                            Song</button>
                    </div>
                </div>

                <!-- Live Sessions -->
                <div class="side-menu-section">
                    <h4 data-i18n="menu.section.sessions">Live Sessions</h4>
                    <div class="side-menu-buttons">
                        <button class="side-menu-btn green" id="sideMenuCreateSession"
                            data-i18n="menu.btn.create_session">Create Session</button>
                        <button class="side-menu-btn blue" id="sideMenuJoinSession" data-i18n="menu.btn.join_session">Join Session</button>
                        <button class="side-menu-btn" id="sideMenuMySessions" data-i18n="menu.btn.my_sessions">My
                            Sessions</button>
                        <button class="side-menu-btn purple" id="sideMenuGoLive" data-i18n="menu.btn.go_live">Go
                            Live</button>
                    </div>
                </div>

                <!-- Pads Mini Player -->
                <div class="side-menu-section">
                    <h4 data-i18n="menu.section.pads">Worship Pads</h4>
                    <!-- Mini 12-key grid -->
                    <div id="miniPadsGrid"
                        style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; margin-bottom: 10px;">
                        <button class="mini-pad-key" data-key="C">C</button>
                        <button class="mini-pad-key" data-key="Csharp">C#</button>
                        <button class="mini-pad-key" data-key="D">D</button>
                        <button class="mini-pad-key" data-key="Dsharp">D#</button>
                        <button class="mini-pad-key" data-key="E">E</button>
                        <button class="mini-pad-key" data-key="F">F</button>
                        <button class="mini-pad-key" data-key="Fsharp">F#</button>
                        <button class="mini-pad-key" data-key="G">G</button>
                        <button class="mini-pad-key" data-key="Gsharp">G#</button>
                        <button class="mini-pad-key" data-key="A">A</button>
                        <button class="mini-pad-key" data-key="Asharp">A#</button>
                        <button class="mini-pad-key" data-key="B">B</button>
                    </div>
                    <!-- Stop button and Volume slider -->
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <button id="miniPadStop" onclick="padPlayer.stopAll();"
                            style="width: 32px; height: 32px; background: transparent; border: 1px solid var(--border); color: var(--text); font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;">Stop</button>
                        <span style="font-size: 12px; opacity: 0.7;"></span>
                        <input type="range" id="miniPadVolume" min="0" max="100" value="70"
                            style="flex: 1; height: 4px;">
                        <span id="miniPadNowPlaying"
                            style="font-size: 11px; color: var(--text); font-weight: 600; min-width: 24px;"></span>
                    </div>
                    <!-- Full controls button -->
                    <div class="side-menu-buttons">
                        <button class="side-menu-btn" id="sideMenuOpenPads" data-i18n="menu.btn.full_pads"
                            style="background: transparent; border-color: var(--border); font-size: 12px;">
                            Full Controls
                        </button>
                    </div>
                </div>

                <!-- Metronome Mini Player -->
                <div class="side-menu-section">
                    <h4 data-i18n="menu.section.metronome">Metronome</h4>
                    <!-- BPM and Controls -->
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <button id="miniMetronomePlay" class="mini-metronome-btn" onclick="metronome.toggle();"
                            style="width: 36px; height: 36px; background: transparent; border: 1px solid var(--border); color: var(--text); font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center;">▶</button>
                        <div style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <button onclick="metronome.setBpm(Math.max(20, metronome.bpm - 1));"
                                style="width: 24px; height: 24px; background: transparent; border: 1px solid var(--border); color: var(--text); font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center;">−</button>
                            <div style="text-align: center;">
                                <span id="miniMetronomeBpm"
                                    style="font-size: 24px; font-weight: bold; color: var(--text);">120</span>
                                <span style="font-size: 11px; color: var(--text-muted);"> BPM</span>
                            </div>
                            <button onclick="metronome.setBpm(Math.min(300, metronome.bpm + 1));"
                                style="width: 24px; height: 24px; background: transparent; border: 1px solid var(--border); color: var(--text); font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center;">+</button>
                        </div>
                        <button id="miniMetronomeMult" onclick="metronome.toggleDoubleTime();"
                            style="padding: 4px 8px; background: transparent; border: 1px solid var(--border); color: var(--text); font-size: 10px; font-weight: 700; cursor: pointer; min-width: 28px;">x1</button>
                        <button id="miniMetronomeTap" class="mini-metronome-tap" onclick="metronome.tap();"
                            data-i18n="menu.btn.tap"
                            style="padding: 4px 8px; background: transparent; border: 1px solid var(--border); color: var(--text); font-size: 10px; font-weight: 600; cursor: pointer;">TAP</button>
                    </div>
                    <!-- BPM Slider -->
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 10px; opacity: 0.5;">20</span>
                        <input type="range" id="miniMetronomeBpmSlider" min="20" max="300" value="120"
                            style="flex: 1; height: 4px;"
                            oninput="metronome.setBpm(this.value); document.getElementById('miniMetronomeBpm').textContent = this.value;">
                        <span style="font-size: 10px; opacity: 0.5;">300</span>
                    </div>
                    <!-- Volume Slider -->
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <span style="font-size: 12px; opacity: 0.6;"></span>
                        <input type="range" id="miniMetronomeVolume" min="0" max="100" value="70"
                            style="flex: 1; height: 4px;"
                            oninput="metronome.setVolume(this.value / 100);">
                        <span style="font-size: 12px; opacity: 0.6;"></span>
                    </div>
                    <!-- Full controls button -->
                    <div class="side-menu-buttons">
                        <button class="side-menu-btn" id="sideMenuOpenMetronome" data-i18n="menu.btn.full_metro"
                            style="background: transparent; border-color: var(--border); font-size: 12px;">
                            Full Controls
                        </button>
                    </div>
                </div>

                <!-- Active Session Info (shown when broadcasting) -->
                <div id="sideMenuActiveSession" class="side-menu-section"
                    style="display: none; border-top: 1px solid var(--border);">
                    <h4 style="color: var(--text);">Active Session</h4>
                    <div style="text-align: center; padding: 12px 0;">
                        <div id="sideMenuSessionCode"
                            style="font-family: monospace; font-size: 28px; font-weight: bold; color: var(--text); margin-bottom: 12px; letter-spacing: 2px;">
                        </div>
                        <div id="sideMenuQRCode"
                            style="display: flex; justify-content: center; margin-bottom: 12px; background: white; padding: 8px; width: fit-content; margin-left: auto; margin-right: auto;">
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Scan QR or share
                            link:</div>
                        <input type="text" id="sideMenuSessionLink" readonly
                            style="width: 100%; padding: 8px; font-size: 11px; background: var(--surface); border: 1px solid var(--border); color: var(--text); text-align: center; cursor: pointer;">
                        <button id="sideMenuCopyLink" class="side-menu-btn green"
                            style="margin-top: 8px; width: 100%;">Copy Link</button>
                    </div>
                </div>

                <!-- User Profile Section (shown when logged in) -->
                <div id="sideMenuUserProfile" class="side-menu-section"
                    style="display: none; border-top: 1px solid var(--border); margin-top: auto; padding-top: 16px;">
                    <div
                        style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--surface);">
                        <!-- Avatar / Logo Upload -->
                        <div id="sideMenuAvatarContainer"
                            style="width: 40px; height: 40px; min-width: 40px; background: var(--text); display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--bg); font-weight: 600; cursor: pointer; position: relative; overflow: hidden;"
                            title="Click to upload logo">
                            <span id="sideMenuUserAvatar">?</span>
                            <img id="sideMenuUserLogo" style="display: none; width: 40px; height: 40px; object-fit: contain; position: absolute; top: 0; left: 0;" alt="Logo">
                        </div>
                        <input type="file" id="logoUploadInput" accept="image/png,image/jpeg,image/svg+xml,image/webp" style="display: none;">
                        <div style="flex: 1; min-width: 0;">
                            <div id="sideMenuUserName"
                                style="font-weight: 600; font-size: 14px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                User</div>
                            <div id="sideMenuTierBadge"
                                style="display: inline-block; padding: 2px 8px; font-size: 11px; font-weight: 600; margin-top: 4px; background: var(--surface); color: var(--text);">
                                Free</div>
                            <input type="text" id="brandingTextInput"
                                placeholder="Band / Church name..."
                                data-i18n-placeholder="branding.placeholder"
                                maxlength="40"
                                style="display: none; width: 100%; margin-top: 6px; padding: 4px 8px; font-size: 11px; background: transparent; border: 1px solid var(--border); color: var(--text); font-family: inherit;">
                            <button id="clearLogoBtn" data-i18n="branding.remove_logo"
                                style="display: none; font-size: 10px; padding: 2px 6px; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; margin-top: 4px;">
                                ✕ Remove Logo
                            </button>
                            <button id="toggleAchordimBrandingBtn" data-i18n="branding.hide_footer"
                                style="display: none; font-size: 10px; padding: 2px 6px; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; margin-top: 4px;">
                                Hide aChordim footer
                            </button>
                        </div>
                    </div>
                    <!-- Usage Indicator -->
                    <div id="sideMenuUsageIndicator"
                        style="margin-top: 12px; padding: 10px 12px; background: var(--surface); border: 1px solid var(--border); text-align: center;">
                        <span id="sideMenuUsageText"
                            style="font-size: 13px; color: var(--text); font-weight: 500;">Loading...</span>
                    </div>
                    <!-- Scans Remaining -->
                    <div id="sideMenuScansIndicator"
                        style="margin-top: 8px; padding: 10px 12px; background: var(--surface); border: 1px solid var(--border); text-align: center; display: none;">
                        <span style="font-size: 11px; color: var(--text);">Scans remaining:</span>
                        <span id="sideMenuScansText"
                            style="font-size: 15px; color: var(--text); font-weight: 600; margin-left: 6px;">0</span>
                    </div>
                    <!-- Upgrade Button -->
                    <button id="sideMenuUpgradeButton" class="side-menu-btn"
                        style="margin-top: 10px; width: 100%; background: var(--text); color: var(--bg); font-weight: 600; border: none; display: none;">
                        Upgrade
                    </button>
                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                        <button id="sideMenuMySubscription" class="side-menu-btn" style="flex: 1; font-size: 12px;">My
                            Subscription</button>
                        <button id="sideMenuSignOut" class="side-menu-btn"
                            style="flex: 1; font-size: 12px; background: transparent; border-color: var(--border); color: var(--text);">Sign
                            Out</button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Live Section -->
        <section class="session-section">
            <div class="session-controls"
                style="margin: 20px 0; padding: 16px; background: var(--bg); border: 1px solid var(--border);">
                <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 0.9rem; font-weight: 600;"
                    data-i18n="session.title">Live Section</h4>
                <!-- Session Status Indicator (shown when in session) -->
                <div id="sessionStatusIndicator" style="display: none; margin-bottom: 12px;"></div>

                <!-- Now Playing Banner (shown when in session) -->
                <div id="liveSessionBanner"
                    style="display: none; margin-bottom: 12px; padding: 12px 16px; background: var(--bg); border: 1px solid var(--border); align-items: center; justify-content: space-between; gap: 12px;">
                    <span id="nowPlayingLabel" style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                        <span style="animation: pulse 2s infinite;"></span>
                        <span data-i18n="session.label.now_playing">Now Playing:</span> <strong id="nowPlayingSong"
                            style="color: var(--primary);">-</strong>
                    </span>
                    <button id="returnToLiveBtn" onclick="window.returnToLeaderSong()" data-i18n="session.btn.return"
                        style="display: none; padding: 6px 12px; background: var(--text); color: var(--bg); border: none; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                        Return to Live
                    </button>
                </div>

                <!-- Session Action Buttons (shown when not in session) -->
                <div id="sessionActionButtons"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    <button class="ghost-button" id="createSessionBtn" data-i18n="session.btn.create_pro"
                        style="background: var(--text); color: var(--bg); border: none; display: none;">
                        Create Live Session (PRO)
                    </button>
                    <button class="ghost-button" id="joinSessionBtn" data-i18n="session.btn.join_basic"
                        style="background: var(--text); color: var(--bg); border: none; display: none;">
                        Join Session (Basic)
                    </button>
                    <button class="ghost-button" id="mySessionsBtn" style="display: none;">
                        My Sessions
                    </button>
                    <button class="ghost-button" id="goLiveButton"
                        style="background: var(--text); color: var(--bg); border: none; display: none;">
                        Go Live
                    </button>
                </div>
            </div>
        </section>

        <section class="preview-section-content">
            <!-- Advanced Layout Controls (Collapsible) -->
            <div id="advancedControls" class="preview-controls-row"
                style="display: none; flex-direction: column; gap: 12px; margin-bottom: 20px; overflow: hidden; transition: all 0.3s ease;">

                <!-- 1. Transpose Controls (FIRST) -->
                <div
                    style="background: var(--bg); border: 1px solid var(--border); padding: 16px;">
                    <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 0.9rem; font-weight: 600;"
                        data-i18n="adv.transpose.title">Transpose</h4>

                    <!-- Quick Key Transpose -->
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 0.85rem; color: var(--text-muted); display: block; margin-bottom: 6px;"
                            data-i18n="adv.label.quick">Quick
                            Transpose to Key:</label>
                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                            <button class="ghost-button quick-key-transpose" data-target-key="C"
                                style="flex: 1; min-width: 50px; padding: 8px; font-weight: 600; background: transparent;">C</button>
                            <button class="ghost-button quick-key-transpose" data-target-key="D"
                                style="flex: 1; min-width: 50px; padding: 8px; font-weight: 600; background: transparent;">D</button>
                            <button class="ghost-button quick-key-transpose" data-target-key="E"
                                style="flex: 1; min-width: 50px; padding: 8px; font-weight: 600; background: transparent;">E</button>
                            <button class="ghost-button quick-key-transpose" data-target-key="F"
                                style="flex: 1; min-width: 50px; padding: 8px; font-weight: 600; background: transparent;">F</button>
                            <button class="ghost-button quick-key-transpose" data-target-key="G"
                                style="flex: 1; min-width: 50px; padding: 8px; font-weight: 600; background: transparent;">G</button>
                            <button class="ghost-button quick-key-transpose" data-target-key="A"
                                style="flex: 1; min-width: 50px; padding: 8px; font-weight: 600; background: transparent;">A</button>
                            <button class="ghost-button quick-key-transpose" data-target-key="B"
                                style="flex: 1; min-width: 50px; padding: 8px; font-weight: 600; background: transparent;">B</button>
                        </div>
                    </div>

                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                        <div style="display: flex; gap: 8px; flex: 1 1 100px; min-width: 100px;">
                            <button class="ghost-button" data-shift="-1"
                                style="flex: 1; padding: 10px; min-width: 44px;">–1</button>
                            <button class="ghost-button" data-shift="1"
                                style="flex: 1; padding: 10px; min-width: 44px;">+1</button>
                        </div>
                        <label class="transpose-label"
                            style="display: flex; align-items: center; gap: 6px; white-space: nowrap; justify-content: center; flex: 1 1 100px; min-width: 100px;">
                            <span style="font-size: 0.9rem; color: var(--text-muted); font-weight: 500;"
                                data-i18n="adv.label.steps">Steps</span>
                            <input type="number" id="transposeStepInput" value="0" min="-11" max="11"
                                style="width: 50px; padding: 8px;">
                        </label>
                        <div style="display: flex; gap: 8px; flex: 1 1 150px; min-width: 150px;">
                            <button class="ghost-button" id="applyTranspose" data-i18n="adv.btn.apply"
                                style="flex: 1; padding: 10px 12px;">Apply</button>
                            <button class="ghost-button" id="resetTranspose" data-i18n="menu.btn.reset"
                                style="flex: 1; padding: 10px 12px;">Reset</button>
                        </div>
                    </div>
                </div>

                <!-- 2. Layout Customization (SECOND) -->
                <div
                    style="background: var(--bg); border: 1px solid var(--border); padding: 16px;">
                    <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 0.9rem; font-weight: 600;"
                        data-i18n="adv.layout.title">Layout
                        Customization</h4>
                    <!-- Save & Load Buttons (at top) -->
                    <div class="layout-actions-row"
                        style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px;">
                        <button class="ghost-button" id="saveSongButton" data-i18n="adv.btn.save"
                            style="padding: 8px 12px; font-size: 0.8rem;">Save</button>
                        <button class="ghost-button" id="loadSongButton" data-i18n="adv.btn.load"
                            style="padding: 8px 12px; font-size: 0.8rem;">Load</button>
                        <button class="ghost-button" id="bulkImportButton" data-i18n="adv.btn.import"
                            style="padding: 8px 12px; font-size: 0.8rem;">Import</button>
                        <input type="file" id="bulkImportInput" multiple accept=".txt,.cho,.chordpro,.chopro"
                            style="display: none;">
                        <button class="ghost-button" id="updateSongButton" data-i18n="adv.btn.update"
                            style="padding: 8px 12px; font-size: 0.8rem; background: transparent; border-color: var(--border); color: var(--text);">Update</button>
                    </div>
                    <!-- Row 0a: Music Settings (Chords, Key, BPM, Time Sig) -->
                    <div class="layout-controls-row layout-music-row"
                        style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-bottom: 8px; width: 100%; justify-content: space-between;">
                        <div
                            style="display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); flex: 1;">
                            <span style="font-size: 0.75rem;"></span>
                            <select id="nashvilleMode"
                                style="padding: 4px 6px; background: var(--surface); color: var(--text); border: none; font-size: 0.8rem; cursor: pointer; font-weight: 500; flex: 1; -webkit-appearance: menulist; appearance: menulist;">
                                <option value="chords" selected>Chords</option>
                                <option value="both">Nash+Chords</option>
                                <option value="numbers">Nashville</option>
                                <option value="roman_both">Roman+Chords</option>
                                <option value="roman">Roman</option>
                                <option value="lyrics">Lyrics</option>
                            </select>
                        </div>
                        <div id="keyDetection"
                            style="display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); flex: 1;">
                            <span style="font-size: 0.75rem;"></span>
                            <select id="keySelector"
                                style="padding: 4px 6px; background: var(--surface); color: var(--text); border: none; font-size: 0.8rem; font-weight: 500; cursor: pointer; flex: 1; -webkit-appearance: menulist; appearance: menulist;">
                                <optgroup label="Major">
                                    <option value="C Major" selected>C</option>
                                    <option value="C# Major">C#</option>
                                    <option value="D Major">D</option>
                                    <option value="D# Major">D#</option>
                                    <option value="E Major">E</option>
                                    <option value="F Major">F</option>
                                    <option value="F# Major">F#</option>
                                    <option value="G Major">G</option>
                                    <option value="G# Major">G#</option>
                                    <option value="A Major">A</option>
                                    <option value="A# Major">A#</option>
                                    <option value="B Major">B</option>
                                </optgroup>
                                <optgroup label="Minor">
                                    <option value="C Minor">Cm</option>
                                    <option value="C# Minor">C#m</option>
                                    <option value="D Minor">Dm</option>
                                    <option value="D# Minor">D#m</option>
                                    <option value="E Minor">Em</option>
                                    <option value="F Minor">Fm</option>
                                    <option value="F# Minor">F#m</option>
                                    <option value="G Minor">Gm</option>
                                    <option value="G# Minor">G#m</option>
                                    <option value="A Minor">Am</option>
                                    <option value="A# Minor">A#m</option>
                                    <option value="B Minor">Bm</option>
                                </optgroup>
                            </select>
                            <span id="detectedKey" style="display: none;"></span>
                        </div>
                        <div
                            style="display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); flex: 1;">
                            <span style="font-size: 0.75rem;"></span>
                            <input type="number" id="bpmInput" value="120" min="40" max="240"
                                style="width: 100%; padding: 2px 4px; background: transparent; color: var(--text); border: none; font-size: 0.8rem; text-align: center; font-weight: 500;"
                                required>
                        </div>
                        <div
                            style="display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); flex: 1;">
                            <span style="font-size: 0.75rem;"></span>
                            <select id="timeSignature"
                                style="padding: 4px 6px; background: var(--surface); color: var(--text); border: none; font-size: 0.8rem; cursor: pointer; font-weight: 500; flex: 1; -webkit-appearance: menulist; appearance: menulist;">
                                <option value="4/4" selected>4/4</option>
                                <option value="3/4">3/4</option>
                                <option value="6/8">6/8</option>
                                <option value="2/4">2/4</option>
                                <option value="5/4">5/4</option>
                                <option value="7/8">7/8</option>
                                <option value="12/8">12/8</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); flex: 1;"
                            title="Song duration (MM:SS)">
                            <span style="font-size: 0.75rem;"></span>
                            <input type="text" id="songDuration" value="5:00" placeholder="5:00"
                                style="width: 100%; padding: 2px 4px; background: transparent; color: var(--text); border: none; font-size: 0.8rem; text-align: center; font-weight: 500;"
                                onchange="updateDurationInEditor()">
                        </div>
                    </div>
                    <!-- Row 0b: Display & Actions (Badges, Columns, Pages, Actions) -->
                    <div class="layout-controls-row layout-display-row"
                        style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; width: 100%; justify-content: space-between;">
                        <label
                            style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); flex: 1;">
                            <input type="checkbox" id="showBadges" checked
                                style="width: 14px; height: 14px; cursor: pointer;">
                            <span style="font-size: 0.8rem; color: var(--text); font-weight: 500;"
                                data-i18n="adv.check.badges">Badges</span>
                        </label>
                        <div
                            style="display: flex; align-items: center; padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); flex: 1; justify-content: center;">
                            <select id="columnCount"
                                style="padding: 4px 6px; background: var(--surface); color: var(--text); border: none; font-size: 0.8rem; cursor: pointer; font-weight: 500; -webkit-appearance: menulist; appearance: menulist;">
                                <option value="1">1 Col</option>
                                <option value="2" selected>2 Col</option>
                                <option value="3">3 Col</option>
                                <option value="4">4 Col</option>
                            </select>
                        </div>
                        <div
                            style="display: flex; align-items: center; padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); flex: 1; justify-content: center;">
                            <span style="margin-right: 4px;"></span>
                            <select id="sectionLanguage"
                                style="padding: 4px 6px; background: var(--surface); color: var(--text); border: none; font-size: 0.8rem; cursor: pointer; font-weight: 500; -webkit-appearance: menulist; appearance: menulist;">
                                <option value="en" selected>EN</option>
                                <option value="he">עב</option>
                            </select>
                        </div>
                        <label
                            style="display: flex; align-items: center; gap: 4px; cursor: pointer; padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); flex: 1; justify-content: center;">
                            <input type="checkbox" id="followArrangementBtn2"
                                style="width: 14px; height: 14px; cursor: pointer;">
                            <span style="font-size: 0.8rem; color: var(--text); font-weight: 500;"
                                data-i18n="adv.check.follow">Follow</span>
                        </label>
                        <button id="layoutSaveAsImage" data-i18n="adv.btn.image_short"
                            style="display: flex; align-items: center; justify-content: center; gap: 4px; padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); color: var(--text); font-size: 0.8rem; cursor: pointer; font-weight: 500; flex: 1;">Image</button>
                        <button id="layoutPrintButton" data-i18n="adv.btn.print_short"
                            style="display: flex; align-items: center; justify-content: center; gap: 4px; padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); color: var(--text); font-size: 0.8rem; cursor: pointer; font-weight: 500; flex: 1;">Print</button>
                        <button id="layoutAutoFitButton" data-i18n="adv.btn.autofit_short"
                            style="display: flex; align-items: center; justify-content: center; gap: 4px; padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); color: var(--text); font-size: 0.8rem; cursor: pointer; font-weight: 500; flex: 1;">Auto Fit</button>
                    </div>
                    <!-- Row 1: Sliders -->
                    <div class="layout-sliders-row"
                        style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px;">
                        <label class="font-size-control" style="flex: 1 1 140px; min-width: 140px;">
                            Font Size: <span id="fontSizeValue">8</span>pt
                            <input type="range" id="fontSizeSlider" min="8" max="28" value="8" step="0.5">
                        </label>
                        <label class="line-height-control" style="flex: 1 1 140px; min-width: 140px;">
                            Line Spacing: <span id="lineHeightValue">1.2</span>
                            <input type="range" id="lineHeightSlider" min="1.0" max="2.0" value="1.2" step="0.1">
                        </label>
                        <label class="char-spacing-control" style="flex: 1 1 140px; min-width: 140px;">
                            Char Spacing: <span id="charSpacingValue">0</span>px
                            <input type="range" id="charSpacingSlider" min="0" max="8" value="0" step="0.5">
                        </label>
                    </div>
                    <!-- Display Toggle Buttons -->
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                        <button id="toggleControlsBtn" class="ghost-button display-toggle"
                            style="flex: 1; min-width: 120px; padding: 8px 12px; font-size: 12px; font-weight: 500;">
                            <span style="margin-right: 4px;"></span> Main Controls
                        </button>
                        <button id="toggleEditorBtn" class="ghost-button display-toggle"
                            style="flex: 1; min-width: 120px; padding: 8px 12px; font-size: 12px; font-weight: 500;">
                            <span style="margin-right: 4px;"></span> Edit Workspace
                        </button>
                    </div>
                </div>
            </div>

            <!-- Editor + Preview Side-by-Side Wrapper -->
            <!-- Force LTR for this section so chords/editor structure remains Left-to-Right even in Hebrew -->
            <div class="editor-preview-wrapper" dir="ltr">

                <!-- Preview Container (LEFT) -->
                <div class="preview-container" style="position: relative; padding: 0; overflow: hidden;">
                    <div id="pageCounter"
                        style="position: absolute; top: -24px; right: 0; font-size: 11px; color: var(--text-muted); font-weight: 500;">
                        Page 1 of 1 (A4)</div>
                    <div id="pagesWrapper" style="display: flex; flex-direction: column; gap: 20px;">
                        <div class="preview-page" data-page="1">
                            <!-- Logo removed per user request -->
                            <div id="livePreview" class="live-preview"
                                style="height: 1123px; max-height: 1123px; overflow: hidden; border: none; padding: 20px 20px 40px 20px; width: 100%; max-width: 210mm; column-count: 2; column-gap: 40px; column-fill: auto;">
                            </div>
                            <!-- Page Footer with User Branding + TheFaithSound branding -->
                            <div class="preview-page-footer">
                                <!-- User Branding (left, hidden by default) -->
                                <div id="userBrandingFooter" style="display: none; align-items: center; gap: 6px; margin-right: auto;">
                                    <img id="footerUserLogo" style="width: 16px; height: 16px; object-fit: contain; display: none;" alt="">
                                    <span id="footerBrandingText" style="font-weight: 600; font-size: 11px;"></span>
                                </div>
                                <!-- aChordim branding (right, toggleable) -->
                                <span id="achordimBranding" style="display: flex; align-items: center; gap: 6px;">
                                    <img src="achordim-icon-app.svg" alt="" class="footer-icon">
                                    <span class="footer-brand">א/aChordim</span>
                                    <span class="footer-url">www.thefaith<span
                                            class="footer-highlight">sound</span>.com</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit Workspace (RIGHT) -->
                <section id="editor" class="editor" style="display: block;">
                    <div id="chordWorkspaceContent">
                        <div class="editor-panel">
                            <!-- TEXTAREA EDITOR -->
                            <textarea id="visualEditor"
                                placeholder="Edit chords and lyrics with visual spacing..."></textarea>
                            <!-- FONT SIZE SLIDER (below editor) -->
                            <div
                                style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg); border: 1px solid var(--border); margin-top: 12px;">
                                <label style="flex: 1; display: flex; align-items: center; gap: 8px; margin: 0;">
                                    <span
                                        style="font-size: 0.9rem; color: var(--text-muted); font-weight: 500; white-space: nowrap;">Edit
                                        Font Size:</span>
                                    <span id="editorFontSizeValue"
                                        style="font-size: 0.9rem; color: var(--text); font-weight: 600; min-width: 40px;">10px</span>
                                    <input type="range" id="editorFontSizeSlider" min="8" max="24" value="10" step="1"
                                        style="flex: 1; min-width: 120px;">
                                </label>
                            </div>
                            <!-- KEY ANALYSIS (below font slider) -->
                            <div id="keyAnalysis"
                                style="margin-top: 12px; padding: 16px; background: var(--bg); border: 1px solid var(--border); display: none;">
                                <h4
                                    style="margin: 0 0 12px 0; color: var(--text); font-size: 0.95rem; font-weight: 600;">
                                    Key Analysis</h4>
                                <p id="keyAnalysisText"
                                    style="margin: 0; color: var(--text-muted); font-size: 0.9rem; line-height: 1.6;">
                                </p>
                            </div>

                            <!-- VISUAL WORKSPACE SECTION (BOTTOM) -->
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                                <div class="mini-preview" id="miniWorkspacePreview">
                                    <img id="miniWorkspacePreviewImage" alt="Uploaded chart preview">
                                    <span class="mini-preview-placeholder">Preview appears here after upload.</span>
                                </div>
                                <div class="reanalyze-block">
                                    <label for="reanalyzeFeedback">Need a better pass? Tell us what to fix.</label>
                                    <textarea id="reanalyzeFeedback"
                                        placeholder="Example: Verse 1 chords drift left; please align with lyrics and double-check key."></textarea>
                                    <button class="ghost-button" id="reanalyzeButton" disabled>Re-analyze with
                                        feedback</button>
                                </div>

                                <!-- Music Links Section -->
                                <div class="music-section" id="musicSection">
                                    <!-- Add Music Link Button -->
                                    <div class="music-add-btn" id="musicAddBtn" onclick="openMusicModal()">
                                        <svg class="music-icon" viewBox="0 0 24 24" fill="currentColor">
                                            <path
                                                d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" />
                                        </svg>
                                        <span>Add Music Link</span>
                                    </div>

                                    <!-- YouTube Player (Primary - Large) -->
                                    <div class="music-player-container youtube-player" id="youtubePlayerContainer"
                                        style="display: none;">
                                        <div class="music-player-header" data-platform="youtube">
                                            <span class="music-label">
                                                <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                                    <path
                                                        d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z" />
                                                </svg>
                                                YouTube
                                            </span>
                                            <button class="music-remove-btn" onclick="removeMusicLink('youtube')"
                                                title="Remove">✕</button>
                                        </div>
                                        <div class="music-iframe-wrapper">
                                            <iframe id="youtubeIframe" frameborder="0"
                                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                                allowfullscreen>
                                            </iframe>
                                        </div>
                                    </div>

                                    <!-- Other Music Links (Compact Buttons) -->
                                    <div class="music-links-row" id="musicLinksRow" style="display: none;">
                                        <!-- Spotify -->
                                        <a class="music-link-btn spotify" id="spotifyLinkBtn" href="#" target="_blank"
                                            style="display: none;">
                                            <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                                                <path
                                                    d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z" />
                                            </svg>
                                            <span>Spotify</span>
                                            <button class="music-link-remove"
                                                onclick="event.preventDefault(); removeMusicLink('spotify')">✕</button>
                                        </a>
                                        <!-- Apple Music -->
                                        <a class="music-link-btn apple" id="appleLinkBtn" href="#" target="_blank"
                                            style="display: none;">
                                            <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                                                <path
                                                    d="M23.994 6.124a9.23 9.23 0 00-.24-2.19c-.317-1.31-1.062-2.31-2.18-3.043a5.022 5.022 0 00-1.877-.726 10.496 10.496 0 00-1.564-.15c-.04-.003-.083-.01-.124-.013H5.986c-.152.01-.303.017-.455.026-.747.043-1.49.123-2.193.4-1.336.53-2.3 1.452-2.865 2.78-.192.448-.292.925-.363 1.408-.056.392-.088.785-.1 1.18 0 .032-.007.062-.01.093v12.223c.01.14.017.283.027.424.05.815.154 1.624.497 2.373.65 1.42 1.738 2.353 3.234 2.801.42.127.856.187 1.293.228.555.053 1.11.06 1.667.06h11.03c.525 0 1.048-.034 1.57-.1.823-.106 1.597-.35 2.296-.81a5.046 5.046 0 001.88-2.207c.186-.42.293-.87.37-1.324.113-.675.138-1.358.137-2.04-.002-3.8 0-7.595-.003-11.393zm-6.423 3.99v5.712c0 .417-.058.827-.244 1.206-.29.59-.76.962-1.388 1.14-.35.1-.706.157-1.07.173-.95.042-1.775-.597-1.942-1.498-.096-.517-.006-1.013.323-1.445.329-.432.776-.705 1.299-.84.292-.076.59-.125.89-.167.376-.053.754-.088 1.128-.145.19-.03.336-.134.388-.332.015-.053.023-.11.023-.165V9.834a.46.46 0 00-.06-.245c-.055-.083-.15-.115-.253-.093l-4.12.893c-.09.02-.163.076-.202.167-.027.063-.04.13-.04.197v7.196c0 .204-.02.407-.06.608a1.794 1.794 0 01-.864 1.236c-.322.197-.677.304-1.052.36-.14.02-.28.038-.42.046-.832.044-1.574-.362-1.876-1.087-.265-.637-.21-1.285.155-1.88.313-.51.775-.838 1.345-.986.365-.095.735-.146 1.107-.185.31-.032.62-.073.927-.124.27-.046.433-.217.475-.49.01-.072.013-.146.013-.22V6.234c0-.12.022-.234.076-.34.08-.157.2-.25.372-.295L17.23 4.59c.123-.03.246-.044.37-.024.212.033.37.16.418.38.018.082.026.166.026.25v4.918h.527z" />
                                            </svg>
                                            <span>Apple Music</span>
                                            <button class="music-link-remove"
                                                onclick="event.preventDefault(); removeMusicLink('apple')">✕</button>
                                        </a>
                                        <!-- SoundCloud -->
                                        <a class="music-link-btn soundcloud" id="soundcloudLinkBtn" href="#"
                                            target="_blank" style="display: none;">
                                            <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                                                <path
                                                    d="M1.175 12.225c-.051 0-.094.046-.101.1l-.233 2.154.233 2.105c.007.058.05.098.101.098.05 0 .09-.04.099-.098l.255-2.105-.27-2.154c-.009-.06-.049-.1-.084-.1zm-.899 1.77c-.053 0-.092.04-.101.1l-.153 1.395.153 1.36c.009.057.048.097.101.097.05 0 .09-.04.1-.1l.178-1.357-.178-1.396c-.01-.06-.05-.1-.1-.1zm1.822-1.395c-.063 0-.108.053-.117.113l-.213 2.28.213 2.227c.009.065.054.112.117.112.063 0 .105-.047.115-.112l.244-2.227-.244-2.28c-.01-.06-.052-.113-.115-.113zm.88-.318c-.07 0-.125.058-.133.126l-.192 2.598.192 2.54c.008.072.063.125.133.125s.12-.053.13-.125l.22-2.54-.22-2.598c-.01-.068-.06-.126-.13-.126zm.94-.41c-.082 0-.137.065-.146.145l-.173 3.008.173 2.93c.009.086.064.145.146.145.082 0 .134-.059.144-.145l.2-2.93-.2-3.008c-.01-.08-.062-.145-.144-.145zm.928-.242c-.09 0-.15.074-.16.163l-.152 3.25.152 3.14c.01.093.07.163.16.163s.145-.07.156-.163l.176-3.14-.176-3.25c-.01-.09-.066-.163-.156-.163zm.98-.163c-.1 0-.167.082-.176.18l-.132 3.413.132 3.3c.009.103.076.18.176.18.099 0 .163-.077.173-.18l.153-3.3-.153-3.413c-.01-.098-.074-.18-.173-.18zm.973-.118c-.108 0-.18.09-.188.197l-.112 3.53.112 3.44c.008.11.08.198.188.198.107 0 .177-.088.187-.198l.13-3.44-.13-3.53c-.01-.108-.08-.197-.187-.197zm1.022-.028c-.117 0-.193.096-.2.212l-.092 3.558.093 3.5c.007.117.082.212.2.212.116 0 .19-.095.198-.212l.108-3.5-.108-3.558c-.008-.116-.082-.212-.199-.212zm.99-.015c-.125 0-.206.104-.212.227l-.073 3.573.073 3.533c.006.125.087.228.212.228.124 0 .203-.103.21-.228l.085-3.533-.084-3.573c-.008-.123-.087-.227-.211-.227zm1.068.01c-.135 0-.22.112-.226.245l-.054 3.563.054 3.508c.006.132.09.244.226.244.135 0 .216-.112.223-.244l.062-3.508-.062-3.563c-.007-.133-.088-.245-.223-.245zm.957-.05c-.142 0-.233.12-.238.26l-.035 3.613.035 3.558c.005.14.096.26.238.26.14 0 .23-.12.236-.26l.04-3.558-.04-3.613c-.006-.14-.096-.26-.236-.26zm1.06.01c-.15 0-.246.127-.252.275l-.015 3.603.015 3.548c.006.148.1.275.25.275.15 0 .243-.127.25-.275l.016-3.548-.017-3.603c-.007-.148-.1-.275-.248-.275zm1.03.02c-.16 0-.262.135-.267.29v7.15c.005.153.107.29.267.29.16 0 .26-.137.266-.29V12.39c-.005-.155-.106-.29-.266-.29zm1.03-.016c-.07 0-.135.03-.183.078-.05.05-.082.12-.085.192v7.21c.003.145.114.27.27.27.077 0 .147-.032.196-.083.05-.05.082-.122.084-.187v-7.21c-.002-.07-.034-.142-.084-.192-.05-.048-.12-.078-.198-.078zm1.028 0c-.075 0-.147.03-.197.08-.048.047-.08.117-.082.188v7.208c0 .072.034.14.082.188.05.05.122.082.197.082.17 0 .28-.125.28-.27V12.66c0-.143-.11-.27-.28-.27zm3.05.05c-.168 0-.33.022-.488.068-1.903.57-3.34 2.32-3.553 4.412-.037.352.25.642.593.642h7.25c.203 0 .395-.08.537-.22.142-.14.22-.33.22-.537V15.58c0-1.847-1.493-3.34-3.34-3.34-.077 0-.146.003-.22.01z" />
                                            </svg>
                                            <span>SoundCloud</span>
                                            <button class="music-link-remove"
                                                onclick="event.preventDefault(); removeMusicLink('soundcloud')">✕</button>
                                        </a>
                                        <!-- Generic Link -->
                                        <a class="music-link-btn generic" id="genericLinkBtn" href="#" target="_blank"
                                            style="display: none;">
                                            <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                                                <path
                                                    d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z" />
                                            </svg>
                                            <span id="genericLinkText">Link</span>
                                            <button class="music-link-remove"
                                                onclick="event.preventDefault(); removeMusicLink('generic')">✕</button>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

            </div><!-- End editor-preview-wrapper -->
        </section>

        <section class="editor" id="songbookSection" style="display: none;">
            <div class="editor-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h2>SongBook Format (auto-updated)</h2>
                <button id="toggleSongbookFormat" class="ghost-button"
                    style="padding: 8px 16px; font-size: 0.9rem; background: transparent; color: var(--text); border: 1px solid var(--border);">
                    ▼ Expand
                </button>
            </div>
            <div id="songbookFormatContent" style="display: none;">
                <div class="editor-panel">
                    <small style="display: block; margin-bottom: 12px; color: var(--text-muted);">Copy this to SongBook
                        app</small>
                    <!-- Font Size Control -->
                    <div
                        style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg); border: 1px solid var(--border); margin-bottom: 12px;">
                        <label style="flex: 1; display: flex; align-items: center; gap: 8px; margin: 0;">
                            <span
                                style="font-size: 0.9rem; color: var(--text-muted); font-weight: 500; white-space: nowrap;">Font
                                Size:</span>
                            <span id="songbookFontSizeValue"
                                style="font-size: 0.9rem; color: var(--text); font-weight: 600; min-width: 40px;">14px</span>
                            <input type="range" id="songbookFontSizeSlider" min="10" max="24" value="14" step="1"
                                style="flex: 1; min-width: 120px;">
                        </label>
                    </div>
                    <textarea id="songbookOutput" readonly
                        placeholder="SongBook format with [C] brackets will appear here..."></textarea>
                </div>
            </div>
        </section>

        <section class="support-section" id="support"
            style="max-width: 1100px; margin: 60px auto 80px; padding: 40px 30px; text-align: center; background: var(--bg); border: 1px solid var(--border); position: relative; overflow: hidden;">
            <div style="position: relative; z-index: 1;">
                <div
                    style="display: inline-block; background: var(--text); padding: 8px 20px; margin-bottom: 20px;">
                    <span style="color: var(--bg); font-weight: 600; font-size: 0.9rem; letter-spacing: 0.5px;">UNLOCK FULL
                        POWER</span>
                </div>

                <h2
                    style="font-size: clamp(1.5rem, 5vw, 2.2rem); margin-bottom: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <span data-i18n="pricing.title"
                        style="color: var(--text); align-self: flex-start; margin-top: -4px;">Support</span>
                    <img src="achordim-icon-app.svg" alt=""
                        style="width: clamp(32px, 8vw, 44px); height: clamp(32px, 8vw, 44px); align-self: flex-start;">
                    <span style="display: flex; flex-direction: column; line-height: 1.2;">
                        <span
                            style="color: var(--text);">א/aChordim</span>
                        <span style="font-size: 0.5rem; color: var(--text); font-weight: 400;">www.thefaith<span
                                style="color: var(--text);">sound</span>.com</span>
                    </span>
                </h2>

                <p data-i18n="pricing.subtitle"
                    style="font-size: 1.15rem; color: var(--text-muted); margin-bottom: 28px; line-height: 1.7; max-width: 550px; margin-left: auto; margin-right: auto;">
                    Join thousands of worship leaders using aChordim to transform their music ministry
                </p>

                <!-- Feature highlights -->
                <div style="display: flex; justify-content: center; gap: 24px; flex-wrap: wrap; margin-bottom: 32px;">
                    <div style="display: flex; align-items: center; gap: 8px; color: var(--text);">
                        <span style="font-size: 1.3rem;"></span>
                        <span data-i18n="pricing.feat.scans" style="font-size: 0.95rem;">More Scans</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; color: var(--text);">
                        <span style="font-size: 1.3rem;"></span>
                        <span data-i18n="pricing.feat.priority" style="font-size: 0.95rem;">Priority Processing</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; color: var(--text);">
                        <span style="font-size: 1.3rem;"></span>
                        <span data-i18n="pricing.feat.cloud" style="font-size: 0.95rem;">Cloud Sync</span>
                    </div>
                </div>

                <!-- Pricing badges - Compact -->
                <div style="display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                    <!-- Free tier -->
                    <div
                        style="background: var(--bg); border: 1px solid var(--border); padding: 10px 12px; min-width: 90px;">
                        <div data-i18n="pricing.tier.free"
                            style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 2px;">Free</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--text);">$0</div>
                        <div style="font-size: 0.6rem; color: var(--text-muted); margin-top: 4px; line-height: 1.3;">3
                            <span data-i18n="pricing.scans_month">scans/month</span>
                        </div>
                    </div>
                    <!-- Basic tier -->
                    <div
                        style="background: var(--bg); border: 1px solid var(--border); padding: 10px 12px; min-width: 90px;">
                        <div data-i18n="pricing.tier.basic"
                            style="font-size: 0.7rem; color: var(--text); margin-bottom: 2px;">Basic</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--text);">$0.99<span
                                style="font-size: 0.6rem; font-weight: 400; color: var(--text);"
                                data-i18n="pricing.per_month">/mo</span></div>
                        <div style="font-size: 0.6rem; color: var(--text-muted); margin-top: 4px; line-height: 1.3;">20
                            <span data-i18n="pricing.scans_month">scans/month</span>
                        </div>
                    </div>
                    <!-- Pro tier -->
                    <div
                        style="background: var(--bg); border: 1px solid var(--border); padding: 10px 12px; position: relative; min-width: 90px;">
                        <div data-i18n="pricing.badge.popular"
                            style="position: absolute; top: -6px; left: 50%; transform: translateX(-50%); background: var(--text); color: var(--bg); font-size: 0.5rem; padding: 1px 4px; font-weight: 600;">
                            POPULAR</div>
                        <div data-i18n="pricing.tier.pro"
                            style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 2px;">Pro</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--text);">$1.99<span
                                style="font-size: 0.6rem; font-weight: 400; color: var(--text-muted);"
                                data-i18n="pricing.per_month">/mo</span></div>
                        <div data-i18n="pricing.feat.live"
                            style="font-size: 0.6rem; color: var(--text-muted); margin-top: 4px; line-height: 1.3;">
                            Live Sessions</div>
                    </div>
                    <!-- Book tier -->
                    <div
                        style="background: var(--bg); border: 1px solid var(--border); padding: 10px 12px; min-width: 90px; position: relative;">
                        <div data-i18n="pricing.badge.onetime"
                            style="position: absolute; top: -6px; left: 50%; transform: translateX(-50%); background: var(--text); color: var(--bg); font-size: 0.5rem; padding: 1px 4px; font-weight: 600;">
                            ONE-TIME</div>
                        <div data-i18n="pricing.tier.book"
                            style="font-size: 0.7rem; color: var(--text); margin-bottom: 2px;">Book</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--text);">$9.99<span
                                style="font-size: 0.55rem; font-weight: 400; color: var(--text-muted);"><span
                                    data-i18n="pricing.once"> once</span></span>
                        </div>
                        <div style="font-size: 0.6rem; color: var(--text-muted); margin-top: 4px; line-height: 1.3;">20
                            <span data-i18n="pricing.scans_included">scans included</span>
                        </div>
                    </div>
                </div>

                <button class="primary-action" onclick="window.showSubscriptionModal()"
                    style="padding: 16px 40px; font-size: 1.15rem; background: var(--text); color: var(--bg); transition: all 0.3s ease;">
                    <span data-i18n="pricing.btn">Get Started Now</span>
                </button>

                <p data-i18n="pricing.note" style="margin-top: 16px; font-size: 0.85rem; color: var(--text-muted);">
                    Cancel anytime • Secure
                    payment via PayPal</p>
            </div>
        </section>
    </main>

    <footer class="app-footer">
        <p>&copy; <span id="year"></span> The Faith Sound. <span data-i18n="footer.tagline">Built with love for worship leaders and musicians.</span> <span
                style="opacity: 0.7;">| v3.1 - 28/01/2026</span></p>
        <p style="margin-top: 8px; font-size: 0.85rem;">
            <a href="privacy.html" style="color: var(--text-muted);" data-i18n="footer.privacy">Privacy Policy</a> ·
            <a href="terms.html" style="color: var(--text-muted);" data-i18n="footer.terms">Terms of Service</a>
        </p>
    </footer>

    <!-- Hidden print-only formatted version -->
    <div id="printPreview" class="print-only" style="display: none;"></div>

    <!-- Custom Modal -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="modalTitle">Modal Title</h3>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modalMessage">Modal message goes here.</p>
                <input type="number" id="modalInput" class="modal-input" placeholder="10" min="1" step="0.01"
                    style="display: none;">
            </div>
            <div class="modal-footer">
                <button class="ghost-button" id="modalCancel">Cancel</button>
                <button class="primary-action" id="modalConfirm">OK</button>
            </div>
        </div>
    </div>

    <!-- Auth Message / Toast Display -->
    <div id="authMessage"
        style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 400px; width: 90%; padding: 20px 24px; display: none; z-index: 10000; font-weight: 500; background: var(--text); color: var(--bg); border: 1px solid var(--border); text-align: center; font-size: 14px; line-height: 1.5;">
    </div>

    <!-- Beautiful Custom Alert Modal -->
    <div id="customAlertModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 99999; justify-content: center; align-items: center;">
        <div
            style="background: var(--surface); padding: 24px; max-width: 400px; width: 90%; position: relative; border: 1px solid var(--border); animation: alertSlideIn 0.25s ease-out;">
            <div id="customAlertIcon" style="text-align: center; font-size: 48px; margin-bottom: 16px;">i</div>
            <h3 id="customAlertTitle"
                style="margin: 0 0 12px 0; color: var(--text); font-size: 18px; text-align: center; font-weight: 600;">
                Alert</h3>
            <p id="customAlertMessage"
                style="color: var(--text-muted); font-size: 14px; line-height: 1.6; text-align: center; margin: 0 0 20px 0; white-space: pre-line;">
            </p>
            <button id="customAlertOk"
                style="width: 100%; padding: 12px 24px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.2s ease;">OK</button>
        </div>
    </div>
    <style>
        @keyframes alertSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        #customAlertOk:hover {
            background: var(--text) !important;
            color: var(--bg) !important;
            border-color: var(--text) !important;
        }

        #customAlertOk:active {
            transform: translateY(0);
        }
    </style>

    <!-- Beautiful Custom Confirm Modal -->
    <div id="customConfirmModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 99999; justify-content: center; align-items: center;">
        <div
            style="background: var(--surface); padding: 24px; max-width: 400px; width: 90%; position: relative; border: 1px solid var(--border); animation: alertSlideIn 0.25s ease-out;">
            <div id="customConfirmIcon" style="text-align: center; font-size: 48px; margin-bottom: 16px;"></div>
            <h3 id="customConfirmTitle"
                style="margin: 0 0 12px 0; color: var(--text); font-size: 18px; text-align: center; font-weight: 600;">
                Confirm</h3>
            <p id="customConfirmMessage"
                style="color: var(--text-muted); font-size: 14px; line-height: 1.6; text-align: center; margin: 0 0 24px 0; white-space: pre-line;">
            </p>
            <div style="display: flex; gap: 12px;">
                <button id="customConfirmCancel"
                    style="flex: 1; padding: 12px 24px; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.2s ease;">Cancel</button>
                <button id="customConfirmOk"
                    style="flex: 1; padding: 12px 24px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.2s ease;">Remove</button>
            </div>
        </div>
    </div>
    <style>
        #customConfirmCancel:hover {
            background: var(--text) !important;
            color: var(--bg) !important;
            border-color: var(--text) !important;
        }

        #customConfirmOk:hover {
            background: var(--text) !important;
            color: var(--bg) !important;
            border-color: var(--text) !important;
        }

        #customConfirmOk:active,
        #customConfirmCancel:active {
            transform: translateY(0);
        }
    </style>

    <!-- Authentication Modal -->
    <div id="authModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 9999; justify-content: center; align-items: center;">
        <div
            style="background: var(--surface); padding: 40px; max-width: 450px; width: 90%; position: relative; border: 1px solid var(--border);">
            <button id="closeAuthModal"
                style="position: absolute; top: 20px; right: 20px; background: transparent; border: none; color: var(--text-muted); font-size: 28px; cursor: pointer; line-height: 1; padding: 0;">&times;</button>

            <!-- Login Form -->
            <div id="loginFormContainer">
                <h2 style="margin-bottom: 10px; color: var(--text); font-size: 1.8rem;" data-i18n="auth.welcome">Welcome
                    Back</h2>
                <p style="color: var(--text-muted); margin-bottom: 30px;" data-i18n="auth.signin_desc">Sign in to
                    continue to aChordim</p>

                <form id="loginForm">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;"
                            data-i18n="auth.email_label">Email
                            Address</label>
                        <input type="email" id="loginEmail" placeholder="you@example.com"
                            data-i18n-placeholder="auth.email_placeholder" required
                            style="width: 100%; padding: 12px 16px; background: var(--surface); border: 1px solid var(--border); color: var(--text); font-size: 1rem;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;"
                            data-i18n="auth.password_label">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password"
                            data-i18n-placeholder="auth.password_placeholder" required
                            style="width: 100%; padding: 12px 16px; background: var(--surface); border: 1px solid var(--border); color: var(--text); font-size: 1rem;">
                    </div>

                    <button type="submit" data-i18n="auth.btn_signin"
                        style="width: 100%; padding: 14px; background: var(--text); color: var(--bg); border: none; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px;">Sign
                        In</button>

                    <button type="button" class="google-signin-btn"
                        style="width: 100%; padding: 14px; background: var(--bg); color: var(--text); border: 1px solid var(--border); font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg">
                            <g fill="none" fill-rule="evenodd">
                                <path d="M17.6 9.2l-.1-1.8H9v3.4h4.8C13.6 12 13 13 12 13.6v2.2h3a8.8 8.8 0 0 0 2.6-6.6z"
                                    fill="#4285F4" />
                                <path d="M9 18c2.4 0 4.5-.8 6-2.2l-3-2.2a5.4 5.4 0 0 1-8-2.9H1V13a9 9 0 0 0 8 5z"
                                    fill="#34A853" />
                                <path d="M4 10.7a5.4 5.4 0 0 1 0-3.4V5H1a9 9 0 0 0 0 8l3-2.3z" fill="#FBBC05" />
                                <path d="M9 3.6c1.3 0 2.5.4 3.4 1.3L15 2.3A9 9 0 0 0 1 5l3 2.4a5.4 5.4 0 0 1 5-3.7z"
                                    fill="#EA4335" />
                            </g>
                        </svg>
                        <span data-i18n="auth.btn_google">Continue with Google</span>
                    </button>

                    <div style="text-align: center; margin-top: 20px; color: var(--text-muted);">
                        <span data-i18n="auth.no_account">Don't have an account?</span> <a href="#" id="switchToSignup"
                            style="color: var(--primary); text-decoration: none; font-weight: 500;"
                            data-i18n="auth.link_signup">Sign up</a>
                        <br><a href="#" id="switchToReset"
                            style="color: var(--primary); text-decoration: none; font-weight: 500;"
                            data-i18n="auth.link_forgot">Forgot password?</a>
                    </div>
                </form>
            </div>

            <!-- Signup Form -->
            <div id="signupFormContainer" style="display: none;">
                <h2 style="margin-bottom: 10px; color: var(--text); font-size: 1.8rem;" data-i18n="auth.create_account">
                    Create Account</h2>
                <p style="color: var(--text-muted); margin-bottom: 30px;" data-i18n="auth.join_community">Join aChordim
                    community</p>

                <form id="signupForm">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;"
                            data-i18n="auth.fullname">Full
                            Name</label>
                        <input type="text" id="signupName" placeholder="John Doe"
                            data-i18n-placeholder="auth.name_placeholder" required
                            style="width: 100%; padding: 12px 16px; background: var(--surface); border: 1px solid var(--border); color: var(--text); font-size: 1rem;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;"
                            data-i18n="auth.email_label">Email
                            Address</label>
                        <input type="email" id="signupEmail" placeholder="you@example.com"
                            data-i18n-placeholder="auth.email_placeholder" required
                            style="width: 100%; padding: 12px 16px; background: var(--surface); border: 1px solid var(--border); color: var(--text); font-size: 1rem;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;"
                            data-i18n="auth.password_label">Password</label>
                        <input type="password" id="signupPassword" placeholder="At least 6 characters"
                            data-i18n-placeholder="auth.password_min" required
                            style="width: 100%; padding: 12px 16px; background: var(--surface); border: 1px solid var(--border); color: var(--text); font-size: 1rem;">
                    </div>

                    <button type="submit" data-i18n="auth.btn_create"
                        style="width: 100%; padding: 14px; background: var(--text); color: var(--bg); border: none; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px;">Create
                        Account</button>

                    <button type="button" class="google-signin-btn"
                        style="width: 100%; padding: 14px; background: var(--bg); color: var(--text); border: 1px solid var(--border); font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg">
                            <g fill="none" fill-rule="evenodd">
                                <path d="M17.6 9.2l-.1-1.8H9v3.4h4.8C13.6 12 13 13 12 13.6v2.2h3a8.8 8.8 0 0 0 2.6-6.6z"
                                    fill="#4285F4" />
                                <path d="M9 18c2.4 0 4.5-.8 6-2.2l-3-2.2a5.4 5.4 0 0 1-8-2.9H1V13a9 9 0 0 0 8 5z"
                                    fill="#34A853" />
                                <path d="M4 10.7a5.4 5.4 0 0 1 0-3.4V5H1a9 9 0 0 0 0 8l3-2.3z" fill="#FBBC05" />
                                <path d="M9 3.6c1.3 0 2.5.4 3.4 1.3L15 2.3A9 9 0 0 0 1 5l3 2.4a5.4 5.4 0 0 1 5-3.7z"
                                    fill="#EA4335" />
                            </g>
                        </svg>
                        <span data-i18n="auth.btn_google">Sign up with Google</span>
                    </button>

                    <div style="text-align: center; margin-top: 20px; color: var(--text-muted);">
                        <span data-i18n="auth.already_account">Already have an account?</span> <a href="#"
                            class="switchToLogin"
                            style="color: var(--primary); text-decoration: none; font-weight: 500;"
                            data-i18n="auth.link_signin">Sign in</a>
                    </div>
                </form>
            </div>

            <!-- Reset Password Form -->
            <div id="resetFormContainer" style="display: none;">
                <h2 style="margin-bottom: 10px; color: var(--text); font-size: 1.8rem;" data-i18n="auth.title_reset">
                    Reset Password</h2>
                <p style="color: var(--text-muted); margin-bottom: 30px;" data-i18n="auth.desc_reset">Enter your email
                    to receive a reset link</p>

                <form id="resetForm">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;"
                            data-i18n="auth.email_label">Email
                            Address</label>
                        <input type="email" id="resetEmail" placeholder="you@example.com"
                            data-i18n-placeholder="auth.email_placeholder" required
                            style="width: 100%; padding: 12px 16px; background: var(--surface); border: 1px solid var(--border); color: var(--text); font-size: 1rem;">
                    </div>

                    <button type="submit" data-i18n="auth.btn_send_reset"
                        style="width: 100%; padding: 14px; background: var(--text); color: var(--bg); border: none; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px;">Send
                        Reset Link</button>

                    <div style="text-align: center; margin-top: 20px; color: var(--text-muted);">
                        <span data-i18n="auth.remember_pass">Remember your password?</span> <a href="#"
                            class="switchToLogin"
                            style="color: var(--primary); text-decoration: none; font-weight: 500;"
                            data-i18n="auth.link_signin">Sign in</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Save Song Modal -->
    <div id="saveSongModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 data-i18n="modal.save.title">Save Song to Library</h3>
                <button class="modal-close" id="saveSongClose">&times;</button>
            </div>
            <div class="modal-body">
                <p data-i18n="modal.save.desc">Enter a name for this song:</p>
                <input type="text" id="songNameInput" class="modal-input" placeholder="Song name (e.g., Amazing Grace)"
                    data-i18n-placeholder="modal.save.placeholder" style="display: block;">
            </div>
            <div class="modal-footer">
                <button class="ghost-button" id="saveSongCancel" data-i18n="modal.btn.cancel">Cancel</button>
                <button class="primary-action" id="saveSongConfirm" data-i18n="modal.btn.save">Save</button>
            </div>
        </div>
    </div>

    <!-- Generic Styled Prompt Modal -->
    <div id="styledPromptModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 450px;">
            <div class="modal-header">
                <h3 id="styledPromptTitle">Enter value</h3>
                <button class="modal-close" id="styledPromptClose">&times;</button>
            </div>
            <div class="modal-body">
                <p id="styledPromptMessage">Please enter a value:</p>
                <input type="text" id="styledPromptInput" class="modal-input" placeholder=""
                    style="display: block; width: 100%;">
            </div>
            <div class="modal-footer">
                <button class="ghost-button" id="styledPromptCancel">Cancel</button>
                <button class="primary-action" id="styledPromptConfirm">OK</button>
            </div>
        </div>
    </div>

    <!-- Load Song Modal -->
    <div id="loadSongModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Load Song from Library</h3>
                <button class="modal-close" id="loadSongClose">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 8px;">Select a song from your library:</p>

                <!-- Row 1: Book selector + Search -->
                <div style="display: flex; gap: 6px; margin-bottom: 6px; align-items: center;">
                    <select id="bookFilter" class="modal-input" style="flex: 0 0 auto; width: 140px; font-size: 0.85rem; padding: 8px 6px;">
                        <option value="all">All Songs</option>
                        <!-- Books populated dynamically -->
                    </select>
                    <button id="manageBooksBtn" class="ghost-button" style="padding: 8px 10px; font-size: 0.85rem;"
                        title="Manage Books">Books</button>
                    <input type="text" id="songSearchInput" class="modal-input" placeholder="Search..."
                        style="flex: 1; min-width: 100px; font-size: 0.85rem; padding: 8px 10px;">
                    <button id="bulkSelectToggle" class="ghost-button" style="padding: 8px 10px; font-size: 0.85rem;"
                        title="Select multiple songs">Select</button>
                </div>

                <!-- Row 2: Key filter + Sort -->
                <div style="display: flex; gap: 6px; margin-bottom: 12px; align-items: center;">
                    <select id="songKeyFilter" class="modal-input" style="flex: 1; font-size: 0.85rem; padding: 8px 6px;">
                        <option value="">All Keys</option>
                        <option value="C">C Major</option>
                        <option value="C#">C# Major</option>
                        <option value="Db">Db Major</option>
                        <option value="D">D Major</option>
                        <option value="Eb">Eb Major</option>
                        <option value="E">E Major</option>
                        <option value="F">F Major</option>
                        <option value="F#">F# Major</option>
                        <option value="Gb">Gb Major</option>
                        <option value="G">G Major</option>
                        <option value="Ab">Ab Major</option>
                        <option value="A">A Major</option>
                        <option value="Bb">Bb Major</option>
                        <option value="B">B Major</option>
                        <option value="Am">A Minor</option>
                        <option value="Bm">B Minor</option>
                        <option value="Cm">C Minor</option>
                        <option value="Dm">D Minor</option>
                        <option value="Em">E Minor</option>
                        <option value="Fm">F Minor</option>
                        <option value="Gm">G Minor</option>
                    </select>
                    <select id="songSortBy" class="modal-input" style="flex: 1; font-size: 0.85rem; padding: 8px 6px;">
                        <option value="date">Latest First</option>
                        <option value="name">A-Z</option>
                        <option value="bpm">BPM</option>
                        <option value="key">Key</option>
                    </select>
                </div>

                <div id="songList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Songs will be loaded here -->
                </div>

                <!-- Bulk Action Bar (hidden by default) -->
                <div id="bulkActionBar"
                    style="display: none; position: sticky; bottom: 0; background: var(--surface); padding: 16px 0 0 0; margin-top: 12px; border-top: 1px solid var(--border);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <span id="bulkSelectedCount" style="color: var(--text-muted); font-size: 0.9rem;">0
                            selected</span>
                        <div style="display: flex; gap: 8px;">
                            <button id="bulkSelectAll" class="ghost-button"
                                style="padding: 8px 14px; font-size: 0.85rem;">Select All</button>
                            <button id="bulkAddToBook" class="primary-button"
                                style="padding: 8px 14px; font-size: 0.85rem; background: var(--text); color: var(--bg);">Add to
                                Book</button>
                            <button id="bulkAddToSession" class="primary-button"
                                style="padding: 8px 14px; font-size: 0.85rem; background: var(--text); color: var(--bg);">Add to
                                Session</button>
                            <button id="bulkDeleteBtn" class="primary-button"
                                style="padding: 8px 14px; font-size: 0.85rem; background: var(--text); color: var(--bg);">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="ghost-button" id="loadSongCancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Books Management Modal -->
    <div id="booksModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 500px;">
            <div class="modal-header">
                <h3>My Books</h3>
                <button class="modal-close" id="booksClose">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); margin-bottom: 16px;">Organize your songs into books for easy
                    access.</p>

                <!-- Create New Book Form -->
                <div id="newBookForm" style="display: flex; gap: 8px; margin-bottom: 20px;">
                    <input type="text" id="newBookName" class="modal-input" placeholder="New book name..."
                        style="flex: 1;">
                    <button id="createBookBtn" class="primary-button" style="padding: 10px 16px;">Create</button>
                </div>

                <!-- Books List -->
                <div id="booksList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Books will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="ghost-button" id="booksModalCancel">Close</button>
            </div>
        </div>
    </div>

    <!-- Add to Book Selection Modal -->
    <div id="addToBookModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Select Book</h3>
                <button class="modal-close" id="addToBookClose">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); margin-bottom: 16px;">Choose a book to add the selected songs:</p>

                <!-- Books Selection List -->
                <div id="addToBookList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Books will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="ghost-button" id="addToBookCancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Subscription Modal -->
    <style>
        .pricing-grid-responsive {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            grid-auto-rows: 1fr;
            gap: 16px;
            align-items: stretch;
            padding-top: 14px;
        }

        .pricing-grid-responsive .pricing-card,
        .pricing-grid-responsive>div {
            display: flex;
            flex-direction: column;
            position: relative;
            height: 100%;
            width: 100%;
            min-width: 0;
            box-sizing: border-box;
            overflow: visible;
        }

        /* Contain PayPal buttons within cards */
        .pricing-grid-responsive .pricing-card>div:last-child,
        .pricing-grid-responsive>div>div:last-child {
            overflow: hidden;
        }

        [id^="paypal-button-"] {
            overflow: hidden;
        }

        .pricing-grid-responsive .pricing-card ul,
        .pricing-grid-responsive>div ul {
            flex: 1;
        }

        @media (max-width: 800px) {
            .pricing-grid-responsive {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 500px) {
            .pricing-grid-responsive {
                grid-template-columns: 1fr;
                grid-auto-rows: auto;
            }

            .pricing-grid-responsive .pricing-card,
            .pricing-grid-responsive>div {
                height: auto;
            }
        }

        .scan-packs-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .scan-packs-grid>div {
            display: flex;
            flex-direction: column;
            min-height: 180px;
        }

        @media (max-width: 600px) {
            .scan-packs-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <!-- Music Link Modal -->
    <div id="musicModal" class="modal-overlay" style="display: none;">
        <div class="modal-container" style="max-width: 500px; width: 90%;">
            <div class="modal-header">
                <h3 style="display: flex; align-items: center; gap: 10px;">
                    <svg viewBox="0 0 24 24" fill="var(--primary)" width="24" height="24">
                        <path
                            d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" />
                    </svg>
                    Add Music Link
                </h3>
                <button class="modal-close" onclick="closeMusicModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.9rem;">
                    Paste any music link (YouTube, Spotify, Apple Music, SoundCloud, or any URL)
                </p>
                <input type="text" id="musicUrlInput"
                    placeholder="https://youtube.com/... or https://open.spotify.com/..."
                    style="width: 100%; padding: 14px 16px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 1rem; box-sizing: border-box;">
                <p id="musicUrlError" style="color: var(--text); font-size: 0.85rem; margin-top: 8px; display: none;">
                    Please enter a valid URL
                </p>
                <div id="detectedPlatform"
                    style="display: none; margin-top: 12px; padding: 10px; background: var(--surface); border: 1px solid var(--border);">
                    <span style="font-size: 0.85rem; color: var(--text-muted);">Detected: </span>
                    <span id="detectedPlatformName" style="font-weight: 600; color: var(--primary);"></span>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button onclick="closeMusicModal()"
                        style="flex: 1; padding: 12px; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; font-weight: 500;">
                        Cancel
                    </button>
                    <button id="addMusicBtn" onclick="saveMusicLink()"
                        style="flex: 1; padding: 12px; border: none; background: var(--text); color: var(--bg); cursor: pointer; font-weight: 600;">
                        Add Link
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="subscriptionModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 1100px; width: 95%; background: var(--bg);">
            <div class="modal-header" style="background: transparent; border-bottom: 1px solid var(--border);">
                <h3 data-i18n="modal.plan.title" style="color: var(--text); font-weight: 700; font-size: 20px;">Choose Your
                    Plan</h3>
                <button class="modal-close" id="subscriptionModalClose">&times;</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <!-- Usage Indicator (for logged-in users) -->
                <div id="usageIndicator"
                    style="display: none; background: var(--surface); border: 1px solid var(--border); padding: 12px; margin-bottom: 20px;">
                    <p id="usageText" style="margin: 0; color: var(--text); font-size: 14px;"></p>
                </div>

                <!-- Pricing Tiers - 4 columns on desktop, 2 on tablet, 1 on mobile -->
                <div class="pricing-grid-responsive" style="margin-bottom: 20px;">
                    <!-- Free Tier -->
                    <div id="pricing-card-free" class="pricing-card"
                        style="border: 1px solid var(--border); padding: 20px; background: var(--bg); display: flex; flex-direction: column;">
                        <h3 data-i18n="modal.plan.free"
                            style="margin: 0 0 8px 0; color: var(--text); font-size: 18px; font-weight: 600;">Free</h3>
                        <div style="font-size: 36px; font-weight: 700; color: var(--text);">$0</div>
                        <div data-i18n="modal.plan.no_card"
                            style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">No credit card</div>
                        <ul
                            style="list-style: none; padding: 0; margin: 0; font-size: 14px; line-height: 2; flex: 1; color: var(--text);">
                            <li>✓ <span data-i18n="modal.plan.scans3">3 scans/month</span></li>
                            <li>✓ <span data-i18n="modal.plan.transpose">Transpose</span></li>
                            <li>✓ <span data-i18n="modal.plan.print">Print/Export</span></li>
                            <li style="opacity: 0.5;">✗ <span data-i18n="modal.plan.save">Save to Library</span></li>
                            <li style="opacity: 0.5;">✗ <span data-i18n="modal.plan.nashville">Nashville Numbers</span>
                            </li>
                        </ul>
                        <div id="pricing-free-action" style="margin-top: auto; padding-top: 16px;"></div>
                    </div>

                    <!-- Basic Tier -->
                    <div id="pricing-card-basic" class="pricing-card"
                        style="border: 1px solid var(--border); padding: 20px; background: var(--bg); display: flex; flex-direction: column;">
                        <h3 data-i18n="modal.plan.basic"
                            style="margin: 0 0 8px 0; color: var(--text); font-size: 18px; font-weight: 600;">Basic</h3>
                        <div style="font-size: 36px; font-weight: 700; color: var(--text);">$0.99<span
                                style="font-size: 16px; font-weight: 400; color: var(--text-muted);"
                                data-i18n="pricing.per_month">/mo</span></div>
                        <div data-i18n="modal.plan.trial" style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">
                            3-day free trial</div>
                        <ul
                            style="list-style: none; padding: 0; margin: 0; font-size: 14px; line-height: 2; flex: 1; color: var(--text);">
                            <li>✓ <span data-i18n="modal.plan.scans20">20 scans/month</span></li>
                            <li>✓ <span data-i18n="modal.plan.save">Save to Library</span></li>
                            <li>✓ <span data-i18n="modal.plan.transpose">Transpose</span></li>
                            <li>✓ <span data-i18n="modal.plan.print">Print/Export</span></li>
                            <li style="opacity: 0.5; color: var(--text-muted);">✗ <span data-i18n="modal.plan.nashville">Nashville
                                    Numbers</span></li>
                        </ul>
                        <div id="pricing-basic-action" style="margin-top: auto; padding-top: 16px;">
                            <div id="paypal-basic-button"></div>
                        </div>
                    </div>

                    <!-- Pro Tier -->
                    <div id="pricing-card-pro" class="pricing-card"
                        style="border: 2px solid var(--text); padding: 20px; background: var(--bg); position: relative; display: flex; flex-direction: column;">
                        <div data-i18n="pricing.badge.popular"
                            style="position: absolute; top: -10px; right: 12px; background: var(--text); color: var(--bg); padding: 4px 12px; font-size: 11px; font-weight: 600;">
                            POPULAR</div>
                        <h3 data-i18n="modal.plan.pro"
                            style="margin: 0 0 8px 0; color: var(--text); font-size: 18px; font-weight: 600;">Pro</h3>
                        <div style="font-size: 36px; font-weight: 700; color: var(--text);">$1.99<span
                                style="font-size: 16px; font-weight: 400; color: var(--text-muted);"
                                data-i18n="pricing.per_month">/mo</span></div>
                        <div data-i18n="modal.plan.trial" style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">
                            3-day free trial</div>
                        <ul
                            style="list-style: none; padding: 0; margin: 0; font-size: 14px; line-height: 2; flex: 1; color: var(--text);">
                            <li>✓ <span data-i18n="modal.plan.scans50">50 scans/month</span></li>
                            <li>✓ <span data-i18n="modal.plan.save">Save to Library</span></li>
                            <li>✓ <span data-i18n="modal.plan.nashville">Nashville Numbers</span></li>
                            <li>✓ <span data-i18n="modal.plan.live">Live Sessions</span></li>
                            <li>✓ <span data-i18n="modal.plan.transpose_export">Transpose & Export</span></li>
                        </ul>
                        <div id="pricing-pro-action" style="margin-top: auto; padding-top: 16px;">
                            <div id="paypal-pro-button"></div>
                        </div>
                    </div>

                    <!-- Book Tier (One-time purchase) -->
                    <div id="pricing-card-book" class="pricing-card"
                        style="border: 1px solid var(--border); padding: 20px; background: var(--bg); position: relative; display: flex; flex-direction: column;">
                        <div data-i18n="pricing.badge.onetime"
                            style="position: absolute; top: -10px; right: 12px; background: var(--text); color: var(--bg); padding: 4px 12px; font-size: 11px; font-weight: 600;">
                            ONE-TIME</div>
                        <h3 data-i18n="modal.plan.book"
                            style="margin: 0 0 8px 0; color: var(--text); font-size: 18px; font-weight: 600;">Book</h3>
                        <div style="font-size: 36px; font-weight: 700; color: var(--text);">$9.99<span
                                style="font-size: 16px; font-weight: 400; color: var(--text-muted);" data-i18n="pricing.once">
                                once</span></div>
                        <div data-i18n="modal.plan.lifetime"
                            style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">Lifetime + 20 scans</div>
                        <ul
                            style="list-style: none; padding: 0; margin: 0; font-size: 14px; line-height: 2; flex: 1; color: var(--text);">
                            <li>✓ <span data-i18n="modal.plan.scans20_included">20 scans included</span></li>
                            <li>✓ <span data-i18n="modal.plan.buy_packs">Buy more scan packs</span></li>
                            <li>✓ <span data-i18n="modal.plan.save_nashville">Save & Nashville</span></li>
                            <li>✓ <span data-i18n="modal.plan.transpose_export">Transpose & Export</span></li>
                            <li style="opacity: 0.5; color: var(--text-muted);">✗ <span data-i18n="modal.plan.live">Live
                                    Sessions</span></li>
                        </ul>
                        <div id="pricing-book-action" style="margin-top: auto; padding-top: 16px;">
                            <div id="paypal-book-button"></div>
                        </div>
                    </div>
                </div>

                <!-- Scan Packs Section (for Book users) -->
                <div id="scanPacksSection"
                    style="display: none; margin-top: 24px; padding: 24px; background: var(--surface); border: 1px solid var(--border);">
                    <h4 data-i18n="modal.scan.title" style="margin: 0 0 8px 0; color: var(--text); font-size: 18px;">Buy
                        More Scans</h4>
                    <p style="margin: 0 0 20px 0; font-size: 15px; color: var(--text-muted);"><span
                            data-i18n="modal.scan.your_scans">Your scans:</span> <span id="currentScansCount"
                            style="font-weight: 600; color: var(--text);">0</span></p>
                    <div class="scan-packs-grid">
                        <div
                            style="text-align: center; padding: 20px; background: var(--bg); border: 1px solid var(--border);">
                            <div data-i18n="modal.scan.5" style="font-weight: 600; font-size: 16px; color: var(--text);">5
                                Scans</div>
                            <div style="font-size: 28px; font-weight: 700; color: var(--text); margin: 8px 0;">$0.99</div>
                            <div id="paypal-scan-starter" style="margin-top: 12px;"></div>
                        </div>
                        <div
                            style="text-align: center; padding: 20px; background: var(--bg); border: 1px solid var(--border);">
                            <div data-i18n="modal.scan.15" style="font-weight: 600; font-size: 16px; color: var(--text);">15
                                Scans</div>
                            <div style="font-size: 28px; font-weight: 700; color: var(--text); margin: 8px 0;">$1.99</div>
                            <div id="paypal-scan-value" style="margin-top: 12px;"></div>
                        </div>
                        <div
                            style="text-align: center; padding: 20px; background: var(--bg); border: 2px solid var(--text); position: relative;">
                            <div
                                style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--text); color: var(--bg); padding: 4px 12px; font-size: 11px; font-weight: 600;">
                                BEST VALUE</div>
                            <div data-i18n="modal.scan.50" style="font-weight: 600; font-size: 16px; color: var(--text);">50
                                Scans</div>
                            <div style="font-size: 28px; font-weight: 700; color: var(--text); margin: 8px 0;">$4.99</div>
                            <div id="paypal-scan-bundle" style="margin-top: 12px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Cancel Subscription Section (for paid subscribers) -->
                <div id="currentSubscriptionInfo"
                    style="display: none; background: var(--bg); border: 1px solid var(--border); padding: 16px; margin-top: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                        <div>
                            <p style="margin: 0 0 4px 0; font-size: 13px; color: var(--text-muted); font-weight: 500;">MANAGE SUBSCRIPTION</p>
                            <p style="margin: 0; font-size: 14px; color: var(--text);">
                                Current plan: <strong id="currentPlanName" style="color: var(--text);">Pro</strong>
                                <span id="currentPlanStatus" style="font-size: 12px; color: var(--text-muted); margin-left: 8px;">(Active)</span>
                            </p>
                        </div>
                        <button id="cancelSubscriptionBtn" onclick="handleCancelSubscription()"
                            style="padding: 8px 16px; background: var(--bg); color: var(--text); border: 1px solid var(--border); font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            Cancel Subscription
                        </button>
                    </div>
                </div>

                <div style="text-align: center; font-size: 13px; color: var(--text-muted); margin-top: 20px;">
                    <p data-i18n="modal.footer.note" style="margin: 0;">Subscriptions include 3-day free trial. Cancel
                        anytime. Secure payment via
                        PayPal.</p>
                    <p id="subscriptionSignInLink" style="display: none; margin-top: 12px;">
                        <span style="font-size: 13px; color: var(--text-muted);">Already have an account? </span>
                        <a href="#" id="subscriptionLoginLink"
                            style="font-size: 13px; color: var(--text); font-weight: 600; text-decoration: none;">Sign
                            In</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Prompt Modal (for non-logged-in users) -->
    <div id="registrationPromptModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 1100px; width: 95%; background: var(--bg);">
            <div class="modal-header"
                style="background: transparent; border-bottom: 1px solid var(--border); padding: 16px 20px;">
                <h3 style="color: var(--text); font-weight: 700; font-size: 20px;">Choose Your Plan</h3>
                <button class="modal-close" id="registrationPromptClose">&times;</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <!-- Pricing Tiers Grid - 4 columns on desktop, 2 on tablet, 1 on mobile -->
                <div class="pricing-grid-responsive" style="margin-bottom: 20px;">
                    <!-- Free Tier -->
                    <div
                        style="border: 1px solid var(--border); padding: 20px; background: var(--bg); display: flex; flex-direction: column;">
                        <h3 style="margin: 0 0 8px 0; color: var(--text); font-size: 18px; font-weight: 600;">Free</h3>
                        <div style="font-size: 36px; font-weight: 700; color: var(--text);">$0</div>
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">No credit card</div>
                        <ul
                            style="list-style: none; padding: 0; margin: 0; font-size: 14px; line-height: 2; flex: 1; color: var(--text);">
                            <li>✓ 3 scans/month</li>
                            <li>✓ Transpose</li>
                            <li>✓ Print/Export</li>
                            <li style="opacity: 0.5;">✗ Save to Library</li>
                            <li style="opacity: 0.5;">✗ Nashville Numbers</li>
                        </ul>
                        <button id="registerFreeBtn"
                            style="width: 100%; padding: 12px; margin-top: auto; background: var(--text); color: var(--bg); border: none; font-size: 14px; font-weight: 600; cursor: pointer;">
                            Start Free
                        </button>
                    </div>

                    <!-- Basic Tier -->
                    <div
                        style="border: 1px solid var(--border); padding: 20px; background: var(--bg); display: flex; flex-direction: column;">
                        <h3 style="margin: 0 0 8px 0; color: var(--text); font-size: 18px; font-weight: 600;">Basic</h3>
                        <div style="font-size: 36px; font-weight: 700; color: var(--text);">$0.99<span
                                style="font-size: 16px; font-weight: 400; color: var(--text-muted);">/mo</span></div>
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">3-day free trial</div>
                        <ul
                            style="list-style: none; padding: 0; margin: 0; font-size: 14px; line-height: 2; flex: 1; color: var(--text);">
                            <li>✓ 20 scans/month</li>
                            <li>✓ Save to Library</li>
                            <li>✓ Transpose</li>
                            <li>✓ Print/Export</li>
                            <li style="opacity: 0.5; color: var(--text-muted);">✗ Nashville Numbers</li>
                        </ul>
                        <button class="register-basic-btn"
                            style="width: 100%; padding: 12px; margin-top: auto; background: var(--text); color: var(--bg); border: none; font-size: 14px; font-weight: 600; cursor: pointer;">
                            Start Basic
                        </button>
                    </div>

                    <!-- Pro Tier -->
                    <div
                        style="border: 2px solid var(--text); padding: 20px; background: var(--bg); position: relative; display: flex; flex-direction: column;">
                        <span
                            style="position: absolute; top: -10px; right: 12px; background: var(--text); color: var(--bg); font-size: 11px; font-weight: 600; padding: 4px 12px;">POPULAR</span>
                        <h3 style="margin: 0 0 8px 0; color: var(--text); font-size: 18px; font-weight: 600;">Pro</h3>
                        <div style="font-size: 36px; font-weight: 700; color: var(--text);">$1.99<span
                                style="font-size: 16px; font-weight: 400; color: var(--text-muted);">/mo</span></div>
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">3-day free trial</div>
                        <ul
                            style="list-style: none; padding: 0; margin: 0; font-size: 14px; line-height: 2; flex: 1; color: var(--text);">
                            <li>✓ 50 scans/month</li>
                            <li>✓ Save to Library</li>
                            <li>✓ Nashville Numbers</li>
                            <li>✓ Live Sessions</li>
                            <li>✓ Transpose & Export</li>
                        </ul>
                        <button class="register-pro-btn"
                            style="width: 100%; padding: 12px; margin-top: auto; background: var(--text); color: var(--bg); border: none; font-size: 14px; font-weight: 600; cursor: pointer;">
                            Start Pro
                        </button>
                    </div>

                    <!-- Book Tier (One-time) -->
                    <div
                        style="border: 1px solid var(--border); padding: 20px; background: var(--bg); position: relative; display: flex; flex-direction: column;">
                        <span
                            style="position: absolute; top: -10px; right: 12px; background: var(--text); color: var(--bg); font-size: 11px; font-weight: 600; padding: 4px 12px;">ONE-TIME</span>
                        <h3 style="margin: 0 0 8px 0; color: var(--text); font-size: 18px; font-weight: 600;">Book</h3>
                        <div style="font-size: 36px; font-weight: 700; color: var(--text);">$9.99<span
                                style="font-size: 16px; font-weight: 400; color: var(--text-muted);"> once</span></div>
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">Lifetime + 20 scans</div>
                        <ul
                            style="list-style: none; padding: 0; margin: 0; font-size: 14px; line-height: 2; flex: 1; color: var(--text);">
                            <li>✓ 20 scans included</li>
                            <li>✓ Buy more scan packs</li>
                            <li>✓ Save & Nashville</li>
                            <li>✓ Transpose & Export</li>
                            <li style="opacity: 0.5; color: var(--text-muted);">✗ Live Sessions</li>
                        </ul>
                        <button class="register-book-btn"
                            style="width: 100%; padding: 12px; margin-top: auto; background: var(--text); color: var(--bg); border: none; font-size: 14px; font-weight: 600; cursor: pointer;">
                            Get Book
                        </button>
                    </div>
                </div>

                <!-- Footer -->
                <div style="text-align: center; padding-top: 16px; border-top: 1px solid var(--border);">
                    <p style="margin: 0 0 8px 0; font-size: 13px; color: var(--text-muted);">Subscriptions include 3-day free
                        trial. Cancel anytime.</p>
                    <span style="font-size: 13px; color: var(--text-muted);">Already have an account? </span>
                    <a href="#" id="loginFromPrompt"
                        style="font-size: 13px; color: var(--text); font-weight: 600; text-decoration: none;">Sign In</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Features Modal -->
    <div id="featuresModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 750px; background: var(--bg);">
            <div class="modal-header"
                style="background: var(--text); color: var(--bg);">
                <h3>Everything You Need to Lead Worship</h3>
                <button class="modal-close" id="featuresModalClose">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 24px;">
                <!-- Intro -->
                <p style="text-align: center; font-size: 15px; color: var(--text-muted); margin: 0 0 24px 0; line-height: 1.6;">
                    aChordim transforms any chord sheet image into a beautiful, editable, print-ready format in
                    seconds.<br>
                    <strong style="color: var(--text);">No more manual typing. No more messy printouts.</strong>
                </p>

                <!-- Analysis -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: var(--surface); border-left: 4px solid var(--border);">
                    <h4 style="margin: 0 0 8px 0; color: var(--text); font-size: 17px;">Instant Chord Recognition</h4>
                    <p style="margin: 0 0 12px 0; font-size: 14px; color: var(--text-muted); line-height: 1.5;">
                        Simply snap a photo or upload any chord sheet image. We instantly recognize chords, lyrics, and
                        song structure - even from blurry photos or handwritten notes!
                    </p>
                    <ul
                        style="list-style: none; padding: 0; margin: 0; font-size: 14px; line-height: 1.9; color: var(--text);">
                        <li>✓ <strong>Works with any image</strong> - photos, screenshots, PDFs, scanned sheets</li>
                        <li>✓ <strong>Multi-language support</strong> - Hebrew, English, Spanish, Portuguese & more</li>
                        <li>✓ <strong>Smart detection</strong> - automatically finds key, BPM, and time signature</li>
                        <li>✓ <strong>Handles complex chords</strong> - slash chords, extensions, alterations</li>
                    </ul>
                </div>

                <!-- Editing & Customization -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: var(--surface); border-left: 4px solid var(--border);">
                    <h4 style="margin: 0 0 8px 0; color: var(--text); font-size: 17px;">Powerful Visual Editor</h4>
                    <p style="margin: 0 0 12px 0; font-size: 14px; color: var(--text-muted); line-height: 1.5;">
                        Perfect your charts with our intuitive click-to-edit interface. No more struggling with text
                        formatting - just click any chord and change it instantly.
                    </p>
                    <ul
                        style="list-style: none; padding: 0; margin: 0; font-size: 14px; line-height: 1.9; color: var(--text);">
                        <li>✓ <strong>One-click transpose</strong> - change keys instantly for any vocalist</li>
                        <li>✓ <strong>Nashville Numbers</strong> - switch between chord names and numbers (Pro)</li>
                        <li>✓ <strong>Full customization</strong> - fonts, sizes, spacing, columns, margins</li>
                        <li>✓ <strong>Auto-fit to page</strong> - perfect formatting for any paper size</li>
                    </ul>
                </div>

                <!-- Export & Live -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: var(--surface); border-left: 4px solid var(--border);">
                    <h4 style="margin: 0 0 8px 0; color: var(--text); font-size: 17px;">Share, Print & Present Live</h4>
                    <p style="margin: 0 0 12px 0; font-size: 14px; color: var(--text-muted); line-height: 1.5;">
                        From practice to performance - share your charts however you need them. Print beautiful copies,
                        project on screen, or share with your whole band in real-time.
                    </p>
                    <ul
                        style="list-style: none; padding: 0; margin: 0; font-size: 14px; line-height: 1.9; color: var(--text);">
                        <li>✓ <strong>Print-ready output</strong> - professional quality every time</li>
                        <li>✓ <strong>Save as image</strong> - high-resolution PNG for sharing</li>
                        <li>✓ <strong>Live Preview mode</strong> - full-screen display for projectors & screens</li>
                        <li>✓ <strong>Real-time sessions</strong> - band members see changes instantly</li>
                    </ul>
                </div>

                <!-- Song Library -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: var(--surface); border-left: 4px solid var(--border);">
                    <h4 style="margin: 0 0 8px 0; color: var(--text); font-size: 17px;">Your Personal Song Library</h4>
                    <p style="margin: 0 0 12px 0; font-size: 14px; color: var(--text-muted); line-height: 1.5;">
                        Build your ultimate worship collection. Save every song, organize by service or event, and
                        access your library from anywhere. Never lose a chart again!
                    </p>
                    <ul
                        style="list-style: none; padding: 0; margin: 0; font-size: 14px; line-height: 1.9; color: var(--text);">
                        <li>✓ <strong>Unlimited songs</strong> - save your entire repertoire</li>
                        <li>✓ <strong>Custom songbooks</strong> - organize by service, event, or theme</li>
                        <li>✓ <strong>Smart search</strong> - find songs by title, lyrics, or key</li>
                        <li>✓ <strong>Cloud sync</strong> - access from any device, anytime</li>
                    </ul>
                    <p style="margin: 12px 0 0 0; font-size: 12px; color: var(--text-muted); font-style: italic;">Available with
                        Basic & Pro plans</p>
                </div>

                <!-- Worship Tools -->
                <div
                    style="margin-bottom: 20px; padding: 20px; background: var(--surface); border-left: 4px solid var(--border);">
                    <h4 style="margin: 0 0 8px 0; color: var(--text); font-size: 17px;">Ambient Worship Pads</h4>
                    <p style="margin: 0 0 12px 0; font-size: 14px; color: var(--text-muted); line-height: 1.5;">
                        Create the perfect atmosphere for worship. Our built-in ambient pads provide beautiful,
                        continuous background music that matches your song's key automatically.
                    </p>
                    <ul
                        style="list-style: none; padding: 0; margin: 0; font-size: 14px; line-height: 1.9; color: var(--text);">
                        <li>✓ <strong>Key-matched pads</strong> - automatically syncs to your song</li>
                        <li>✓ <strong>Multiple sounds</strong> - warm, bright, atmospheric options</li>
                        <li>✓ <strong>Perfect for transitions</strong> - smooth flow between songs</li>
                    </ul>
                </div>

                <!-- Get Started CTA -->
                <div
                    style="text-align: center; padding: 24px; background: var(--bg); border: 1px solid var(--border); margin-top: 8px;">
                    <p style="margin: 0 0 4px 0; font-size: 18px; font-weight: 700; color: var(--text);">Ready to transform
                        your worship experience?</p>
                    <p style="margin: 0 0 16px 0; font-size: 14px; color: var(--text-muted);">Start free with 3 scans. Upgrade
                        anytime for more features.</p>
                    <button id="featuresModalUpgrade"
                        style="padding: 14px 40px; background: var(--text); color: var(--bg); border: none; font-size: 16px; font-weight: 700; cursor: pointer; transition: transform 0.2s;">
                        View Plans & Pricing
                    </button>
                    <p style="margin: 12px 0 0 0; font-size: 12px; color: var(--text-muted);">Plans start at just $0.99/month</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Session Modal -->
    <div id="createSessionModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 500px;">
            <div class="modal-header">
                <h3 data-i18n="session.modal.create_title">Create Live Session</h3>
                <button class="modal-close" onclick="sessionUI.hideCreateSessionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--text-muted);" data-i18n="session.modal.create_desc">Create a
                    live session to broadcast songs to your band in real-time.</p>
                <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 600;"
                    data-i18n="session.label.title">Session
                    Title</label>
                <input type="text" id="sessionTitleInput" class="modal-input"
                    placeholder="e.g., Sunday Worship Set 14.11.25" data-i18n-placeholder="session.placeholder.title"
                    style="display: block; margin-bottom: 16px;">
                <p style="font-size: 13px; color: var(--text-muted);" data-i18n="session.tip.share">Tip: Share the
                    session code with your band
                    members so they can join and follow along.</p>
            </div>
            <div class="modal-footer">
                <button class="ghost-button" onclick="sessionUI.hideCreateSessionModal()"
                    data-i18n="modal.btn.cancel">Cancel</button>
                <button class="primary-action" onclick="sessionUI.handleCreateSession()"
                    data-i18n="session.btn.create">Create Session</button>
            </div>
        </div>
    </div>

    <!-- Join Session Modal -->
    <div id="joinSessionModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 500px;">
            <div class="modal-header">
                <h3 data-i18n="session.modal.join_title">Join Session</h3>
                <button class="modal-close" onclick="sessionUI.hideJoinSessionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--text-muted);" data-i18n="session.modal.join_desc">Enter the
                    session code provided by your
                    worship leader.</p>
                <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 600;"
                    data-i18n="session.label.code">Session
                    Code</label>
                <input type="text" id="sessionCodeInput" class="modal-input" placeholder="e.g., A3F-7K2"
                    data-i18n-placeholder="session.placeholder.code" maxlength="7"
                    style="display: block; margin-bottom: 16px; text-transform: uppercase; font-family: monospace; font-size: 18px; letter-spacing: 2px; text-align: center;">
                <p style="font-size: 13px; color: var(--text-muted);" data-i18n="session.tip.join">Tip: You'll be
                    able to adjust font size and
                    transpose locally while following the leader's song selection.</p>
            </div>
            <div class="modal-footer">
                <button class="ghost-button" onclick="sessionUI.hideJoinSessionModal()"
                    data-i18n="modal.btn.cancel">Cancel</button>
                <button class="primary-action" onclick="sessionUI.handleJoinSession()" data-i18n="session.btn.join">Join
                    Session</button>
            </div>
        </div>
    </div>

    <!-- My Sessions Modal -->
    <div id="mySessionsModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 700px;">
            <div class="modal-header">
                <h3 data-i18n="session.modal.my_title">My Sessions</h3>
                <button class="modal-close" onclick="sessionUI.hideMySessionsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 16px;">
                    <input type="text" id="sessionsSearchInput" placeholder="Search sessions by title..."
                        data-i18n-placeholder="session.search_placeholder"
                        style="width: 100%; padding: 10px 14px; border: 1px solid var(--border); background: var(--surface); color: var(--text); font-size: 14px;"
                        oninput="filterSessionsList(this.value)">
                </div>
                <p style="margin-bottom: 16px; color: var(--text-muted);" data-i18n="session.list_desc">Your saved and
                    recent sessions</p>
                <div id="sessionsList" style="max-height: 70vh; overflow-y: auto;">
                    <!-- Sessions will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="ghost-button" onclick="sessionUI.hideMySessionsModal()"
                    data-i18n="session.btn.close">Close</button>
                <button class="primary-button"
                    onclick="sessionUI.hideMySessionsModal(); sessionUI.showCreateSessionModal();"
                    data-i18n="session.btn.new">+ Create
                    Session</button>
            </div>
        </div>
    </div>

    <!-- Session Controls Modal -->
    <div id="sessionControlsModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Session Controls</h3>
                <button class="modal-close" onclick="sessionUI.hideSessionControls()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- Participants Panel -->
                    <div>
                        <h4
                            style="margin: 0 0 12px 0; color: var(--text); font-size: 16px; border-bottom: 1px solid var(--border); padding-bottom: 8px;">
                            Participants
                        </h4>
                        <div id="participantsList" style="max-height: 300px; overflow-y: auto;">
                            <!-- Participants will be loaded here -->
                        </div>
                    </div>

                    <!-- Playlist Panel -->
                    <div>
                        <h4
                            style="margin: 0 0 12px 0; color: var(--text); font-size: 16px; border-bottom: 1px solid var(--border); padding-bottom: 8px;">
                            Playlist
                        </h4>
                        <div class="leader-only" data-display="flex"
                            style="display: none; gap: 8px; margin-bottom: 12px;">
                            <button class="ghost-button" onclick="sessionUI.addCurrentSongToPlaylist()"
                                style="flex: 1; font-size: 13px; padding: 8px;">
                                + Current Song
                            </button>
                            <button class="ghost-button" onclick="sessionUI.showAddFromSongbook()"
                                style="flex: 1; font-size: 13px; padding: 8px;">
                                + From Library
                            </button>
                        </div>
                        <div id="sessionPlaylist" style="max-height: 300px; overflow-y: auto;">
                            <!-- Playlist will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Singer Toggle (Leader only) -->
                <div id="singerToggleContainer" class="leader-only" style="display: none;">
                    <!-- Will be populated by sessionUI.updateSingerToggle() -->
                </div>

                <!-- Player Controls (BASIC users) -->
                <div class="player-only"
                    style="padding: 12px; background: transparent; border: 1px solid var(--border); margin-bottom: 12px; display: none;">
                    <button class="ghost-button" id="toggleLiveModeBtn" onclick="sessionUI.toggleLiveMode()"
                        style="width: 100%;">
                        Follow Leader: ON
                    </button>
                    <p style="margin: 8px 0 0 0; font-size: 12px; color: var(--text-muted); text-align: center;">
                        Transpose to your key - it's saved per song!
                    </p>
                </div>

                <!-- Leader Controls (PRO users) -->
                <div class="leader-only"
                    style="padding: 12px; background: var(--surface); border: 1px solid var(--border); display: none;">
                    <p style="margin: 0; font-size: 13px; color: var(--text-muted); text-align: center;">
                        Change songs in the editor to broadcast to all participants
                    </p>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between;">
                <button class="ghost-button leader-only" onclick="sessionUI.endSession()"
                    style="background: var(--text); color: var(--bg); display: none;">
                    End Session
                </button>
                <button class="ghost-button player-only" onclick="sessionUI.leaveSession()" style="display: none;">
                    Leave Session
                </button>
                <button class="ghost-button" onclick="sessionUI.hideSessionControls()">Close</button>
            </div>
        </div>
    </div>

    <!-- Pads Modal -->
    <div id="padsModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 340px; padding: 0; overflow: hidden;">
            <div class="modal-header"
                style="background: var(--bg); border-bottom: 1px solid var(--border); padding: 12px 16px;">
                <h3 style="display: flex; align-items: center; gap: 8px; font-size: 15px;">
                    <span></span> Worship Pads
                </h3>
                <button class="modal-close" id="padsModalClose">&times;</button>
            </div>
            <div class="modal-body" style="padding: 12px;">
                <!-- Loading indicator -->
                <div id="padsLoading" style="text-align: center; padding: 30px; display: none;">
                    <div style="font-size: 28px; margin-bottom: 10px;"></div>
                    <div style="color: var(--text-muted); font-size: 13px;">Loading pad sounds...</div>
                    <div id="padsLoadingProgress" style="margin-top: 6px; color: var(--primary); font-size: 12px;">0/12
                    </div>
                </div>

                <!-- Pad Grid -->
                <div id="padsGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;">
                    <button id="pad-key-C" class="pad-key-btn" onclick="padPlayer.toggle('C')">C</button>
                    <button id="pad-key-Csharp" class="pad-key-btn" onclick="padPlayer.toggle('Csharp')">C#</button>
                    <button id="pad-key-D" class="pad-key-btn" onclick="padPlayer.toggle('D')">D</button>
                    <button id="pad-key-Dsharp" class="pad-key-btn" onclick="padPlayer.toggle('Dsharp')">D#</button>
                    <button id="pad-key-E" class="pad-key-btn" onclick="padPlayer.toggle('E')">E</button>
                    <button id="pad-key-F" class="pad-key-btn" onclick="padPlayer.toggle('F')">F</button>
                    <button id="pad-key-Fsharp" class="pad-key-btn" onclick="padPlayer.toggle('Fsharp')">F#</button>
                    <button id="pad-key-G" class="pad-key-btn" onclick="padPlayer.toggle('G')">G</button>
                    <button id="pad-key-Gsharp" class="pad-key-btn" onclick="padPlayer.toggle('Gsharp')">G#</button>
                    <button id="pad-key-A" class="pad-key-btn" onclick="padPlayer.toggle('A')">A</button>
                    <button id="pad-key-Asharp" class="pad-key-btn" onclick="padPlayer.toggle('Asharp')">A#</button>
                    <button id="pad-key-B" class="pad-key-btn" onclick="padPlayer.toggle('B')">B</button>
                </div>

                <!-- Audio Controls -->
                <div style="margin-top: 12px; padding: 10px; background: transparent;">
                    <div
                        style="font-size: 10px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">
                        Pads</div>

                    <!-- Crossfade -->
                    <div class="pad-control-row">
                        <span class="pad-control-label">Crossfade</span>
                        <input type="range" id="padsCrossfade" min="250" max="800" value="400" class="pad-slider">
                    </div>

                    <!-- Low Pass -->
                    <div class="pad-control-row">
                        <span class="pad-control-label">Low Pass</span>
                        <input type="range" id="padsLowPass" min="0" max="100" value="100" class="pad-slider">
                    </div>

                    <!-- High Pass -->
                    <div class="pad-control-row">
                        <span class="pad-control-label">High Pass</span>
                        <input type="range" id="padsHighPass" min="0" max="100" value="0" class="pad-slider">
                    </div>

                    <!-- Reverb -->
                    <div class="pad-control-row">
                        <span class="pad-control-label">Reverb</span>
                        <input type="range" id="padsReverb" min="0" max="100" value="30" class="pad-slider">
                    </div>

                    <!-- Pan -->
                    <div class="pad-control-row">
                        <span class="pad-control-label">Pan</span>
                        <input type="range" id="padsPan" min="-100" max="100" value="0" class="pad-slider">
                    </div>

                    <!-- Volume -->
                    <div class="pad-control-row">
                        <span class="pad-control-label">Volume</span>
                        <input type="range" id="padsVolume" min="0" max="100" value="70" class="pad-slider">
                    </div>
                </div>

            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border); padding: 10px 16px;">
                <button class="ghost-button" id="padsStopAll" onclick="padPlayer.stopAll()"
                    style="font-size: 12px; padding: 6px 12px;">Stop All</button>
                <button class="ghost-button" onclick="document.getElementById('padsModal').style.display='none'"
                    style="font-size: 12px; padding: 6px 12px;">Close</button>
            </div>
        </div>
    </div>

    <!-- Metronome Modal -->
    <div id="metronomeModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 300px; padding: 0; overflow: hidden;">
            <div class="modal-header"
                style="background: var(--bg); border-bottom: 1px solid var(--border); padding: 12px 16px;">
                <h3 style="display: flex; align-items: center; gap: 8px; font-size: 15px;">
                    <span></span> Metronome
                </h3>
                <button class="modal-close" id="metronomeModalClose">&times;</button>
            </div>
            <div class="modal-body" style="padding: 12px;">
                <!-- BPM Display -->
                <div
                    style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 12px;">
                    <button onclick="metronome.setBpm(Math.max(20, metronome.bpm - 1));"
                        style="width: 32px; height: 32px; background: transparent; border: 1px solid var(--border); color: var(--text); font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center;">−</button>
                    <div style="text-align: center;">
                        <div id="metronome-bpm-display"
                            style="font-size: 42px; font-weight: bold; color: var(--primary); line-height: 1;">120</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">BPM</div>
                    </div>
                    <button onclick="metronome.setBpm(Math.min(300, metronome.bpm + 1));"
                        style="width: 32px; height: 32px; background: transparent; border: 1px solid var(--border); color: var(--text); font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center;">+</button>
                </div>

                <!-- Beat Indicators -->
                <div id="metronome-beats"
                    style="display: flex; justify-content: center; gap: 8px; margin-bottom: 12px;">
                    <div class="beat-dot accent" data-beat="0"></div>
                    <div class="beat-dot" data-beat="1"></div>
                    <div class="beat-dot" data-beat="2"></div>
                    <div class="beat-dot" data-beat="3"></div>
                </div>

                <!-- BPM Slider -->
                <div style="margin-bottom: 12px;">
                    <input type="range" id="metronome-bpm-slider" min="20" max="300" value="120"
                        style="width: 100%;" oninput="metronome.setBpm(this.value)">
                    <div
                        style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); margin-top: 2px;">
                        <span>20</span>
                        <span>160</span>
                        <span>300</span>
                    </div>
                </div>

                <!-- Tap Tempo Button -->
                <div style="text-align: center; margin-bottom: 12px;">
                    <button id="metronome-tap-btn" class="metronome-tap-btn" onclick="metronome.tap()"
                        style="padding: 8px 20px; font-size: 12px;">
                        TAP TEMPO
                    </button>
                </div>

                <!-- Time Signature -->
                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-size: 10px; color: var(--text-muted); margin-bottom: 6px;">Time
                        Signature</label>
                    <div style="display: flex; gap: 6px; justify-content: center;">
                        <button class="metronome-ts-btn active" data-beats="4" data-unit="4"
                            onclick="selectTimeSignature(this)" style="padding: 4px 10px; font-size: 11px;">4/4</button>
                        <button class="metronome-ts-btn" data-beats="3" data-unit="4"
                            onclick="selectTimeSignature(this)" style="padding: 4px 10px; font-size: 11px;">3/4</button>
                        <button class="metronome-ts-btn" data-beats="6" data-unit="8"
                            onclick="selectTimeSignature(this)" style="padding: 4px 10px; font-size: 11px;">6/8</button>
                        <button class="metronome-ts-btn" data-beats="2" data-unit="4"
                            onclick="selectTimeSignature(this)" style="padding: 4px 10px; font-size: 11px;">2/4</button>
                    </div>
                </div>

                <!-- Sound Type -->
                <div style="margin-bottom: 12px;">
                    <label
                        style="display: block; font-size: 10px; color: var(--text-muted); margin-bottom: 6px;">Sound</label>
                    <div style="display: flex; gap: 6px; justify-content: center;">
                        <button class="metronome-sound-btn active" data-sound="click"
                            onclick="selectMetronomeSound(this)"
                            style="padding: 4px 10px; font-size: 11px;">Click</button>
                        <button class="metronome-sound-btn" data-sound="beep" onclick="selectMetronomeSound(this)"
                            style="padding: 4px 10px; font-size: 11px;">Beep</button>
                        <button class="metronome-sound-btn" data-sound="wood" onclick="selectMetronomeSound(this)"
                            style="padding: 4px 10px; font-size: 11px;">Wood</button>
                    </div>
                </div>

                <!-- Speed Multiplier -->
                <div style="margin-bottom: 12px;">
                    <label
                        style="display: block; font-size: 10px; color: var(--text-muted); margin-bottom: 6px;">Speed</label>
                    <div style="display: flex; gap: 6px; justify-content: center;">
                        <button class="metronome-mult-btn" data-mult="0.5" onclick="metronome.setMultiplier(0.5)"
                            style="padding: 4px 10px; font-size: 11px;">÷2</button>
                        <button class="metronome-mult-btn active" data-mult="1" onclick="metronome.setMultiplier(1)"
                            style="padding: 4px 10px; font-size: 11px;">x1</button>
                        <button class="metronome-mult-btn" data-mult="2" onclick="metronome.setMultiplier(2)"
                            style="padding: 4px 10px; font-size: 11px;">x2</button>
                    </div>
                </div>

                <!-- Volume -->
                <div>
                    <label
                        style="display: block; font-size: 10px; color: var(--text-muted); margin-bottom: 6px;">Volume</label>
                    <input type="range" id="metronome-volume" min="0" max="100" value="70"
                        style="width: 100%;" oninput="metronome.setVolume(this.value / 100)">
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border); padding: 10px 16px;">
                <button class="ghost-button" id="metronome-play-btn" onclick="metronome.toggle()"
                    style="background: transparent; border-color: var(--border); font-size: 12px; padding: 6px 14px;">Play</button>
                <button class="ghost-button" onclick="document.getElementById('metronomeModal').style.display='none'"
                    style="font-size: 12px; padding: 6px 14px;">Close</button>
            </div>
        </div>
    </div>

    <!-- Session Manager Modal (higher z-index for Live Mode) -->
    <div id="sessionManagerModal" class="modal-overlay" style="z-index: 100000;">
        <div class="modal-container" style="max-width: 500px;">
            <div class="modal-header"
                style="background: var(--bg); border-bottom: 1px solid var(--border);">
                <h3 style="display: flex; align-items: center; gap: 8px;">
                    <span></span> Manage Session
                </h3>
                <button class="modal-close" onclick="liveMode.closeSessionManager()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 16px;">
                <!-- Session Info -->
                <div
                    style="text-align: center; padding: 12px; background: var(--bg); border: 1px solid var(--border); margin-bottom: 16px;">
                    <div style="font-size: 11px; color: var(--text); text-transform: uppercase; letter-spacing: 1px;">
                        Session Code</div>
                    <div id="sessionManagerCode"
                        style="font-size: 28px; font-weight: 700; color: var(--text); font-family: 'Courier New', monospace; letter-spacing: 3px; margin: 4px 0;">
                    </div>
                    <div id="sessionManagerTitle" style="font-size: 14px; color: var(--text-muted);"></div>
                </div>

                <!-- Participants Section -->
                <div style="margin-bottom: 16px;">
                    <h4
                        style="margin: 0 0 12px 0; color: var(--text); font-size: 14px; display: flex; align-items: center; gap: 8px;">
                        Participants <span id="participantCount"
                            style="font-size: 12px; color: var(--text-muted); font-weight: normal;">(0)</span>
                    </h4>
                    <div id="participantsList"
                        style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); background: var(--surface);">
                        <!-- Participants will be populated here -->
                        <div style="padding: 20px; text-align: center; color: var(--text-muted);">Loading
                            participants...</div>
                    </div>
                </div>

                <!-- Singer/Vocal Only Link Section -->
                <div style="margin-bottom: 16px;">
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <h4
                            style="margin: 0; color: var(--text); font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            Singer Mode
                        </h4>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <span style="font-size: 12px; color: var(--text-muted);">Allow Singers</span>
                            <input type="checkbox" id="allowSingersToggle"
                                onchange="liveMode.toggleAllowSingers(this.checked)"
                                style="width: 18px; height: 18px; cursor: pointer;">
                        </label>
                    </div>
                    <div id="singerLinkSection" style="display: none;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">Lyrics only, no
                            account needed</div>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="sessionManagerSingerLink" readonly
                                style="flex: 1; padding: 10px; font-size: 12px; background: var(--surface); border: 1px solid var(--border); color: var(--text); cursor: pointer;"
                                onclick="this.select()">
                            <button onclick="liveMode.copySingerLink()"
                                style="padding: 10px 16px; background: transparent; color: var(--text); border: 1px solid var(--border); cursor: pointer; font-weight: 600; white-space: nowrap;">
                                Copy
                            </button>
                        </div>
                    </div>
                    <div id="singerLinkDisabled"
                        style="padding: 12px; background: var(--surface); border: 1px solid var(--border); text-align: center; color: var(--text-muted); font-size: 12px;">
                        Enable "Allow Singers" to share the singer link
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border);">
                <button class="ghost-button" onclick="liveMode.endSession()"
                    style="color: var(--text); border-color: var(--border);">End Session</button>
                <button class="primary-action" onclick="liveMode.closeSessionManager()">Done</button>
            </div>
        </div>
    </div>

    <!-- Pad Key Button Styles - Pure B&W Minimalist -->
    <style>
        /* Pad Keys - Pure B&W */
        .pad-key-btn {
            aspect-ratio: 1;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px;
        }

        .pad-key-btn:hover {
            background: var(--text);
            color: var(--bg);
        }

        .pad-key-btn:active {
            transform: scale(0.98);
        }

        .pad-key-btn.playing {
            background: var(--text);
            color: var(--bg);
            border-width: 2px;
        }

        /* Sharp keys - inverted style */
        .pad-key-btn[id*="sharp"] {
            background: var(--text);
            color: var(--bg);
            border-color: var(--border);
        }

        .pad-key-btn[id*="sharp"]:hover {
            background: transparent;
            color: var(--text);
        }

        .pad-key-btn[id*="sharp"].playing {
            background: transparent;
            color: var(--text);
            border-width: 2px;
        }

        /* Mini pad keys in side menu */
        .mini-pad-key {
            padding: 6px 2px;
            font-size: 10px;
            font-weight: 600;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .mini-pad-key:hover {
            background: var(--text);
            color: var(--bg);
        }

        .mini-pad-key.playing {
            background: var(--text);
            color: var(--bg);
            border-width: 2px;
        }

        .mini-pad-key[data-key*="sharp"] {
            background: var(--text);
            color: var(--bg);
        }

        .mini-pad-key[data-key*="sharp"]:hover {
            background: transparent;
            color: var(--text);
        }

        .mini-pad-key[data-key*="sharp"].playing {
            background: transparent;
            color: var(--text);
            border-width: 2px;
        }

        /* Mini Pad Stop button */
        #miniPadStop:hover {
            background: var(--text);
            color: var(--bg);
        }

        #miniPadStop.active {
            background: var(--text);
            color: var(--bg);
            border-width: 2px;
        }

        /* Pad control rows */
        .pad-control-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .pad-control-row:last-child {
            margin-bottom: 0;
        }

        .pad-control-label {
            color: var(--text);
            font-size: 11px;
            min-width: 60px;
        }

        .pad-slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--border);
            outline: none;
            cursor: pointer;
        }

        .pad-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--text);
            cursor: pointer;
        }

        .pad-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--text);
            border: none;
            cursor: pointer;
        }

        /* Metronome Styles - Pure B&W */
        .beat-dot {
            width: 20px;
            height: 20px;
            background: transparent;
            border: 2px solid var(--border);
            transition: all 0.1s ease;
        }

        .beat-dot.accent {
            border-width: 3px;
        }

        .beat-dot.active {
            background: var(--text);
            border-color: var(--text);
            transform: scale(1.2);
        }

        .beat-dot.accent.active {
            background: var(--text);
            border-color: var(--text);
        }

        .metronome-tap-btn {
            padding: 16px 40px;
            font-size: 16px;
            font-weight: 700;
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text);
            cursor: pointer;
            transition: all 0.1s ease;
            user-select: none;
        }

        .metronome-tap-btn:hover {
            background: var(--text);
            color: var(--bg);
        }

        .metronome-tap-btn:active,
        .metronome-tap-btn.tapped {
            background: var(--text);
            color: var(--bg);
            transform: scale(0.95);
        }

        .metronome-ts-btn,
        .metronome-sound-btn,
        .metronome-mult-btn {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .metronome-ts-btn:hover,
        .metronome-sound-btn:hover,
        .metronome-mult-btn:hover {
            background: var(--text);
            color: var(--bg);
        }

        .metronome-ts-btn.active,
        .metronome-sound-btn.active,
        .metronome-mult-btn.active {
            background: var(--text);
            color: var(--bg);
        }

        /* Pending state - simple opacity blink */
        .metronome-mult-btn.pending {
            animation: pendingBlink 0.5s ease-in-out infinite;
        }

        @keyframes pendingBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        #metronome-play-btn.playing {
            background: var(--text) !important;
            color: var(--bg) !important;
            border-color: var(--border) !important;
        }

        /* Mini metronome play button playing state */
        #miniMetronomePlay.playing {
            background: var(--text);
            color: var(--bg);
            border-width: 2px;
        }

        /* Mini metronome tap button active state */
        #miniMetronomeTap:active {
            background: var(--text);
            color: var(--bg);
            transform: scale(0.95);
        }

        /* Mini metronome multiplier button active state */
        #miniMetronomeMult.active {
            background: var(--text);
            color: var(--bg);
        }
    </style>

    <!-- Live Mode Full-Screen Overlay -->
    <div id="liveModeOverlay"
        style="display: none; position: fixed; inset: 0; background: var(--background); z-index: 10000; overflow: hidden;">
        <!-- Main Container with Sidebar Layout -->
        <div style="display: flex; height: 100%; width: 100%;">
            <!-- Vertical Timeline on Left (hidden by default, shows when auto-scroll is ON) -->
            <div id="verticalTimelineContainer"
                style="width: 24px; height: 100%; display: none; flex-direction: column; align-items: center; padding: 10px 4px 140px 4px; box-sizing: border-box; background: var(--surface);">
                <span id="verticalTimeStart"
                    style="font-size: 8px; color: var(--text-muted); font-weight: 600; margin-bottom: 4px;">0:00</span>
                <div style="flex: 1; width: 6px; background: var(--border); overflow: hidden; position: relative; cursor: pointer;"
                    onclick="liveMode.handleVerticalTimelineClick(event)" title="Click to seek">
                    <div id="verticalTimelineFill"
                        style="width: 100%; height: 0%; background: var(--text); transition: height 0.1s linear; position: absolute; top: 0;">
                    </div>
                    <div id="verticalTimelineHandle"
                        style="width: 12px; height: 12px; background: var(--text); position: absolute; top: 0; left: 50%; transform: translateX(-50%) translateY(-50%); cursor: grab;">
                    </div>
                </div>
                <span id="verticalTimeEnd"
                    style="font-size: 8px; color: var(--text-muted); font-weight: 600; margin-top: 4px;">3:00</span>
            </div>
            <!-- Song Display Area (tap to toggle sidebar) -->
            <div id="liveModeContent"
                style="flex: 1; height: 100%; overflow-y: auto; padding: 0 20px 140px 20px; box-sizing: border-box; cursor: pointer; display: flex; justify-content: center; align-items: flex-start; transition: margin-right 0.3s ease;">
                <div id="liveModeChartDisplay"
                    style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; font-size: 14px; line-height: 1.5; white-space: pre-wrap; color: var(--text); margin: 0; max-width: 800px; text-align: left;">
                </div>
            </div>

            <!-- Playlist Sidebar (slide in from right) -->
            <div id="liveModePlaylistSidebar"
                style="position: absolute; top: 0; right: -300px; width: 300px; height: 100%; background: var(--card-bg); border-left: 1px solid var(--border); overflow-y: auto; padding: 10px 12px 140px 12px; box-sizing: border-box; transition: right 0.3s ease; z-index: 10002;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h3 style="margin: 0; color: var(--text); font-size: 18px;">Playlist</h3>
                    <button onclick="liveMode.hidePlaylist()"
                        style="background: var(--button-bg); border: none; color: var(--text); width: 32px; height: 32px; cursor: pointer; font-size: 18px;">&times;</button>
                </div>
                <div id="liveModePlaylistContent">
                    <!-- Playlist items will be loaded here -->
                </div>
                <div id="liveModeSessionId"
                    style="display: none; margin-top: 12px; padding: 10px; background: var(--surface); border: 1px solid var(--border); text-align: center;">
                    <span
                        style="color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Session
                        Code</span>
                    <div id="liveModeSessionCode"
                        style="color: var(--text); font-size: 22px; font-weight: 700; font-family: 'Courier New', monospace; letter-spacing: 3px; margin: 6px 0;">
                    </div>
                    <!-- QR Code -->
                    <div id="liveModeSessionQR"
                        style="margin: 8px auto; background: white; padding: 8px; display: inline-block;">
                    </div>
                    <!-- Copy & Share buttons -->
                    <div style="display: flex; gap: 8px; justify-content: center; margin-top: 8px;">
                        <button onclick="liveMode.copySessionLink()"
                            style="flex: 1; padding: 8px 12px; background: var(--text); color: var(--bg); border: none; cursor: pointer; font-size: 12px; font-weight: 600;">
                            Copy Link
                        </button>
                        <button onclick="liveMode.copySessionCode()"
                            style="flex: 1; padding: 8px 12px; background: var(--surface); color: var(--text); border: 1px solid var(--border); cursor: pointer; font-size: 12px; font-weight: 600;">
                            Copy Code
                        </button>
                    </div>
                    <!-- Edit Session button (leader only) -->
                    <button id="editSessionBtn" onclick="liveMode.openSessionManager()"
                        style="width: 100%; margin-top: 8px; padding: 10px 12px; background: var(--surface); color: var(--text); border: 1px solid var(--border); cursor: pointer; font-size: 12px; font-weight: 600; display: none;">
                        Manage Session
                    </button>
                </div>
            </div>
        </div>

        <!-- Floating Quick-Access Buttons (always visible in live mode) -->
        <button id="liveFloatPlaylist" onclick="liveMode.togglePlaylistFloat()"
            style="display: none; position: absolute; bottom: 20px; right: 20px; z-index: 10004; width: 40px; height: 40px; background: transparent; color: var(--text); border: none; cursor: pointer; opacity: 0.5; padding: 0;"
            title="Toggle Playlist"><svg width="22" height="22" viewBox="0 0 20 20" fill="none" style="display:block;margin:auto;"><line x1="3" y1="5" x2="17" y2="5" stroke="currentColor" stroke-width="2"/><line x1="3" y1="10" x2="17" y2="10" stroke="currentColor" stroke-width="2"/><line x1="3" y1="15" x2="17" y2="15" stroke="currentColor" stroke-width="2"/></svg></button>
        <button id="liveFloatControls" onclick="liveMode.toggleControlsFloat()"
            style="display: none; position: absolute; bottom: 20px; left: 20px; z-index: 10004; width: 40px; height: 40px; background: transparent; color: var(--text); border: none; cursor: pointer; opacity: 0.5; padding: 0;"
            title="Toggle Controls"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" style="display:block;margin:auto;"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z" stroke="currentColor" stroke-width="1.5"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 11-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 11-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 11-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 110-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 112.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 114 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 112.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 110 4h-.09a1.65 1.65 0 00-1.51 1z" stroke="currentColor" stroke-width="1.5"/></svg></button>

        <!-- Left Controls Sidebar (slides in from left) -->
        <div id="liveModeBottomBar"
            style="position: absolute; top: 0; left: -300px; width: 300px; height: 100%; background: var(--bg); border-right: 1px solid var(--border); overflow-y: auto; padding: 56px 12px 20px 12px; box-sizing: border-box; transition: left 0.3s ease; z-index: 10002;">

            <!-- KEY -->
            <div style="margin-bottom: 10px;">
                <div style="font-size: 10px; font-weight: 700; color: var(--text); opacity: 0.5; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Key</div>
                <div id="liveModeTransposeRow"
                    style="display: flex; align-items: center; gap: 2px; padding: 3px 6px; border: 1px solid var(--border);">
                    <button onclick="liveMode.transpose(-1)"
                        style="width: 28px; height: 28px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 14px; font-weight: 600; padding: 0;">−</button>
                    <div id="liveModeCurrentKey"
                        style="padding: 3px 8px; background: var(--text); color: var(--bg); font-weight: 700; font-size: 13px; min-width: 32px; text-align: center;">
                        C</div>
                    <button onclick="liveMode.transpose(1)"
                        style="width: 28px; height: 28px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 14px; font-weight: 600; padding: 0;">+</button>
                </div>
            </div>

            <!-- METRONOME -->
            <div style="margin-bottom: 10px;">
                <div style="font-size: 10px; font-weight: 700; color: var(--text); opacity: 0.5; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Metronome</div>
                <div style="display: flex; align-items: center; gap: 3px; padding: 4px 6px; border: 1px solid var(--border); flex-wrap: wrap;">
                    <button id="liveMetroPlay" onclick="window.metronome && window.metronome.toggle()"
                        style="min-width: 36px; height: 28px; background: var(--text); border: none; color: var(--bg); font-size: 11px; font-weight: 700; cursor: pointer; padding: 0 6px;">PLAY</button>
                    <button onclick="window.metronome && window.metronome.decreaseBpm()"
                        style="width: 24px; height: 24px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 13px; padding: 0;">−</button>
                    <span id="liveMetroBpm"
                        style="font-size: 13px; font-weight: 700; color: var(--text); min-width: 30px; text-align: center;">120</span>
                    <button onclick="window.metronome && window.metronome.increaseBpm()"
                        style="width: 24px; height: 24px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 13px; padding: 0;">+</button>
                    <select id="liveMetroTimeSig"
                        onchange="window.metronome && window.metronome.setTimeSignature(parseInt(this.value.split('/')[0]), parseInt(this.value.split('/')[1]))"
                        style="padding: 3px 4px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 10px; font-weight: 600;">
                        <option value="4/4">4/4</option>
                        <option value="3/4">3/4</option>
                        <option value="6/8">6/8</option>
                        <option value="2/4">2/4</option>
                    </select>
                    <button id="liveMetroMult" onclick="window.metronome && window.metronome.toggleDoubleTime()"
                        style="padding: 3px 6px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 10px; font-weight: 700;">x1</button>
                    <button onclick="window.metronome && window.metronome.tap()"
                        style="padding: 3px 7px; background: var(--text); border: none; color: var(--bg); cursor: pointer; font-size: 10px; font-weight: 600;">TAP</button>
                </div>
                <div style="display: flex; align-items: center; gap: 4px; margin-top: 4px;">
                    <span style="font-size: 9px; color: var(--text); opacity: 0.5; min-width: 22px;">Vol</span>
                    <input type="range" id="liveClickVolume" min="0" max="100" value="70"
                        oninput="window.metronome && window.metronome.setVolume(this.value / 100)"
                        style="flex: 1; height: 4px; accent-color: var(--text); cursor: pointer;">
                </div>
            </div>

            <!-- PADS -->
            <div style="margin-bottom: 10px;">
                <div style="font-size: 10px; font-weight: 700; color: var(--text); opacity: 0.5; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Pads <span id="livePadKey" style="opacity: 1;">--</span></div>
                <div style="display: flex; align-items: center; gap: 2px; padding: 4px 6px; border: 1px solid var(--border); flex-wrap: wrap;">
                    <button id="livePadStop" onclick="window.padPlayer && window.padPlayer.stopAll()"
                        style="min-width: 36px; height: 28px; background: var(--text); border: none; color: var(--bg); font-size: 10px; font-weight: 700; cursor: pointer; padding: 0 6px;">STOP</button>
                    <button onclick="window.padPlayer && window.padPlayer.play('C')" style="padding: 5px 7px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 11px; font-weight: 600;">C</button>
                    <button onclick="window.padPlayer && window.padPlayer.play('D')" style="padding: 5px 7px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 11px; font-weight: 600;">D</button>
                    <button onclick="window.padPlayer && window.padPlayer.play('E')" style="padding: 5px 7px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 11px; font-weight: 600;">E</button>
                    <button onclick="window.padPlayer && window.padPlayer.play('F')" style="padding: 5px 7px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 11px; font-weight: 600;">F</button>
                    <button onclick="window.padPlayer && window.padPlayer.play('G')" style="padding: 5px 7px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 11px; font-weight: 600;">G</button>
                    <button onclick="window.padPlayer && window.padPlayer.play('A')" style="padding: 5px 7px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 11px; font-weight: 600;">A</button>
                    <button onclick="window.padPlayer && window.padPlayer.play('B')" style="padding: 5px 7px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 11px; font-weight: 600;">B</button>
                </div>
                <div style="display: flex; align-items: center; gap: 4px; margin-top: 4px;">
                    <span style="font-size: 9px; color: var(--text); opacity: 0.5; min-width: 22px;">Vol</span>
                    <input type="range" id="livePadVolume" min="0" max="100" value="70"
                        oninput="window.padPlayer && window.padPlayer.setVolume(this.value / 100)"
                        style="flex: 1; height: 4px; accent-color: var(--text); cursor: pointer;">
                </div>
            </div>

            <!-- FONT SIZE -->
            <div style="margin-bottom: 10px;">
                <div style="font-size: 10px; font-weight: 700; color: var(--text); opacity: 0.5; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Font Size</div>
                <div style="display: flex; align-items: center; gap: 2px; padding: 3px 6px; border: 1px solid var(--border);">
                    <button onclick="liveMode.setFontSize(Math.max(8, liveMode.currentFontSize - 1))"
                        style="width: 28px; height: 28px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 14px; padding: 0;">−</button>
                    <span id="liveModeZoomValue"
                        style="font-size: 12px; font-weight: 600; color: var(--text); min-width: 32px; text-align: center;">14pt</span>
                    <button onclick="liveMode.setFontSize(Math.min(24, liveMode.currentFontSize + 1))"
                        style="width: 28px; height: 28px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 14px; padding: 0;">+</button>
                </div>
            </div>

            <!-- AUTO-SCROLL -->
            <div style="margin-bottom: 10px;">
                <div style="font-size: 10px; font-weight: 700; color: var(--text); opacity: 0.5; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Auto Scroll</div>
                <div id="autoScrollControls"
                    style="display: flex; align-items: center; gap: 3px; padding: 4px 6px; border: 1px solid var(--border);">
                    <button id="autoScrollPlayBtn" onclick="liveMode.toggleAutoScroll()"
                        style="min-width: 36px; height: 28px; background: var(--text); border: none; color: var(--bg); font-size: 11px; font-weight: 700; cursor: pointer; padding: 0 6px;">SCROLL</button>
                    <input type="text" id="autoScrollDuration" value="3:00"
                        onchange="liveMode.setAutoScrollDuration(liveMode.parseTimeToSeconds(this.value))"
                        style="width: 42px; padding: 3px 4px; background: transparent; border: 1px solid var(--border); color: var(--text); font-size: 11px; font-weight: 600; text-align: center;"
                        title="Song duration (MM:SS)" placeholder="3:00">
                    <button onclick="liveMode.stopAutoScroll()"
                        style="padding: 4px 8px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 10px;">Stop</button>
                </div>
                <div id="autoScrollProgressContainer"
                    style="display: none; align-items: center; gap: 6px; margin-top: 6px; padding: 0 4px;">
                    <div style="flex: 1; height: 4px; background: var(--border); overflow: hidden; cursor: pointer;"
                        onclick="liveMode.handleProgressBarClick(event)">
                        <div id="autoScrollProgressFill"
                            style="width: 0%; height: 100%; background: var(--text); transition: width 0.1s linear;"></div>
                    </div>
                    <span id="autoScrollTimeDisplay"
                        style="font-size: 9px; color: var(--text); opacity: 0.5; font-weight: 600; white-space: nowrap;">0:00 / 3:00</span>
                </div>
            </div>

            <!-- DISPLAY -->
            <div style="margin-bottom: 10px;">
                <div style="font-size: 10px; font-weight: 700; color: var(--text); opacity: 0.5; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Display</div>
                <div style="padding: 6px; border: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                        <select id="liveModeDisplayMode" onchange="liveMode.setDisplayMode(this.value)"
                            style="flex: 1; padding: 5px 6px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 12px;">
                            <option value="chords" selected>Chords</option>
                            <option value="both">Nash+Chords</option>
                            <option value="numbers">Nashville</option>
                            <option value="lyrics">Lyrics</option>
                        </select>
                        <div style="display: flex; gap: 1px; border: 1px solid var(--border); overflow: hidden;">
                            <button id="liveModeLayout1" onclick="liveMode.setColumnLayout(1)"
                                style="padding: 5px 10px; background: transparent; border: none; color: var(--text); cursor: pointer; font-size: 12px; opacity: 0.5;">☰</button>
                            <button id="liveModeLayout2" onclick="liveMode.setColumnLayout(2)"
                                style="padding: 5px 10px; background: var(--text); border: none; color: var(--bg); cursor: pointer; font-size: 12px;">❘❘</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 11px; color: var(--text);">
                            <input type="checkbox" id="liveModeBadges" checked onchange="liveMode.toggleBadges(this.checked)" style="cursor: pointer; width: 14px; height: 14px;">
                            <span>Badges</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 11px; color: var(--text);">
                            <input type="checkbox" id="liveModeBorders" checked onchange="liveMode.toggleBorders(this.checked)" style="cursor: pointer; width: 14px; height: 14px;">
                            <span>Borders</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 11px; color: var(--text);">
                            <input type="checkbox" id="liveModeTimeline" onchange="liveMode.toggleTimeline(this.checked)" style="cursor: pointer; width: 14px; height: 14px;">
                            <span>Timeline</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- ACTIONS -->
            <div style="margin-bottom: 10px;">
                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    <button id="liveModeMidiBtn" onclick="openMidiSettings()"
                        style="flex: 1; padding: 8px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; font-size: 12px; font-weight: 500;">MIDI<span id="midiStatus" style="display: none; color: var(--text); font-size: 10px;"> ●</span></button>
                </div>
            </div>

            <!-- SESSION CONTROLS -->
            <div id="liveModeSessionControls" style="display: none; margin-bottom: 10px;">
                <div style="font-size: 10px; font-weight: 700; color: var(--text); opacity: 0.5; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Session</div>
                <div style="padding: 6px; border: 1px solid var(--border); display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 11px; color: var(--text);">
                        <input type="checkbox" id="liveModePlaylistToggle"
                            onchange="liveMode.setPlaylistVisible(this.checked); document.getElementById('playlistToggleLabel').textContent = this.checked ? 'ON' : 'OFF'"
                            style="cursor: pointer; width: 14px; height: 14px;">
                        <span id="playlistToggleLabel">OFF</span>
                    </label>
                    <label id="liveModePlaylistLock"
                        style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 11px; color: var(--text); padding: 2px 6px;">
                        <input type="checkbox" id="liveModePlaylistLockToggle"
                            onchange="liveMode.setPlaylistLocked(this.checked); document.getElementById('lockToggleLabel').textContent = this.checked ? 'Locked' : 'Unlocked'; this.parentElement.style.background = this.checked ? 'var(--text)' : 'transparent'; this.parentElement.style.color = this.checked ? 'var(--bg)' : ''"
                            style="cursor: pointer; width: 14px; height: 14px;">
                        <span id="lockToggleLabel">Unlocked</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 11px; color: var(--text);">
                        <input type="checkbox" id="liveModeAutoHidePlaylist" checked
                            onchange="liveMode.toggleAutoHidePlaylist(this.checked)"
                            style="cursor: pointer; width: 14px; height: 14px;">
                        <span>Auto-hide</span>
                    </label>
                    <label id="liveModeFollowLeader" style="display: none; cursor: pointer; font-size: 11px; color: var(--text);">
                        <input type="checkbox" id="followLeaderCheckbox" checked
                            onchange="liveMode.toggleFollowLeader(this.checked)"
                            style="margin-right: 4px; width: 14px; height: 14px;">
                        Follow
                    </label>
                    <span id="liveModeSessionInfo" style="font-size: 11px; color: var(--text); opacity: 0.5;"></span>
                </div>
            </div>

            <!-- EXIT -->
            <button id="liveModeCloseBtn" onclick="liveMode.exit()"
                style="width: 100%; padding: 10px; background: var(--text); border: none; color: var(--bg); cursor: pointer; font-size: 13px; font-weight: 600;">Exit Live Mode</button>
        </div>
    </div>

    <!-- MIDI Settings Modal -->
    <div id="midiSettingsModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 10010; justify-content: center; align-items: center;">
        <div
            style="background: var(--surface); padding: 24px; max-width: 400px; width: 90%; position: relative; border: 1px solid var(--border);">
            <button onclick="closeMidiSettings()"
                style="position: absolute; top: 12px; right: 12px; background: transparent; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>

            <h3 style="margin: 0 0 8px 0; color: var(--text); font-size: 18px;">MIDI Controller</h3>
            <p id="midiDeviceStatus" style="color: var(--text-muted); font-size: 13px; margin-bottom: 20px;">Checking
                devices...</p>

            <!-- MIDI Mappings -->
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <!-- Next Section -->
                <div
                    style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: var(--button-bg); border: 1px solid var(--border);">
                    <span style="color: var(--text); font-size: 13px;">Next Section</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span id="midiMapping-scrollDown"
                            style="color: var(--text); font-size: 12px; font-family: monospace;">CC#30</span>
                        <button onclick="midiController.learn('scrollDown')"
                            style="padding: 4px 10px; background: var(--text); color: var(--bg); border: none; cursor: pointer; font-size: 11px;">Learn</button>
                    </div>
                </div>

                <!-- Previous Section -->
                <div
                    style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: var(--button-bg); border: 1px solid var(--border);">
                    <span style="color: var(--text); font-size: 13px;">Previous Section</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span id="midiMapping-scrollUp"
                            style="color: var(--text); font-size: 12px; font-family: monospace;">CC#31</span>
                        <button onclick="midiController.learn('scrollUp')"
                            style="padding: 4px 10px; background: var(--text); color: var(--bg); border: none; cursor: pointer; font-size: 11px;">Learn</button>
                    </div>
                </div>

                <!-- Next Song -->
                <div
                    style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: var(--button-bg); border: 1px solid var(--border);">
                    <span style="color: var(--text); font-size: 13px;">Next Song</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span id="midiMapping-nextSong"
                            style="color: var(--text); font-size: 12px; font-family: monospace;">CC#32</span>
                        <button onclick="midiController.learn('nextSong')"
                            style="padding: 4px 10px; background: var(--text); color: var(--bg); border: none; cursor: pointer; font-size: 11px;">Learn</button>
                    </div>
                </div>

                <!-- Previous Song -->
                <div
                    style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: var(--button-bg); border: 1px solid var(--border);">
                    <span style="color: var(--text); font-size: 13px;">Previous Song</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span id="midiMapping-prevSong"
                            style="color: var(--text); font-size: 12px; font-family: monospace;">CC#33</span>
                        <button onclick="midiController.learn('prevSong')"
                            style="padding: 4px 10px; background: var(--text); color: var(--bg); border: none; cursor: pointer; font-size: 11px;">Learn</button>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="midiController.saveMappings(); closeMidiSettings();"
                    style="flex: 1; padding: 10px; background: var(--text); color: var(--bg); border: none; cursor: pointer; font-size: 13px; font-weight: 500;">Save</button>
                <button onclick="closeMidiSettings()"
                    style="flex: 1; padding: 10px; background: var(--button-bg); color: var(--text); border: 1px solid var(--border); cursor: pointer; font-size: 13px;">Close</button>
            </div>

            <!-- Browser Support Note -->
            <p style="color: var(--text-muted); font-size: 11px; margin-top: 16px; text-align: center;">
                Works in Chrome, Edge, Firefox. Not supported in Safari.
            </p>
        </div>
    </div>

    <!-- Theme Toggle -->
    <script src="theme.js?v=4"></script>

    <!-- Firebase Configuration and Auth -->
    <script src="firebase-config.js"></script>
    <script src="auth.js"></script>

    <!-- Subscription System -->
    <script src="subscription.js"></script>
    <script src="paypal-subscription.js"></script>

    <!-- Song Library -->
    <script src="song-library.js"></script>
    <script src="song-search-filter.js"></script>

    <!-- Live Sessions -->
    <script src="session-manager.js?v=2"></script>
    <script src="session-ui.js?v=2"></script>

    <!-- Live Mode (full-screen performance view) -->
    <script src="live-mode.js?v=2"></script>

    <!-- MIDI Controller (hands-free control for Live Mode) -->
    <script src="midi-controller.js"></script>
    <script>
        // Beautiful Custom Alert Function
        window.showAlert = function (message, options = {}) {
            const modal = document.getElementById('customAlertModal');
            const icon = document.getElementById('customAlertIcon');
            const title = document.getElementById('customAlertTitle');
            const msgEl = document.getElementById('customAlertMessage');
            const okBtn = document.getElementById('customAlertOk');

            // Determine icon and title based on message content or options
            let alertIcon = options.icon || 'ℹ️';
            let alertTitle = options.title || 'Notice';

            // Auto-detect type from message
            const msgLower = message.toLowerCase();
            if (msgLower.includes('error') || msgLower.includes('failed') || msgLower.includes('❌')) {
                alertIcon = '❌';
                alertTitle = options.title || 'Error';
            } else if (msgLower.includes('success') || msgLower.includes('welcome') || msgLower.includes('🎉') || msgLower.includes('complete')) {
                alertIcon = '🎉';
                alertTitle = options.title || 'Success';
            } else if (msgLower.includes('warning') || msgLower.includes('⚠️')) {
                alertIcon = '⚠️';
                alertTitle = options.title || 'Warning';
            } else if (msgLower.includes('pro') || msgLower.includes('upgrade') || msgLower.includes('subscription')) {
                alertIcon = '⭐';
                alertTitle = options.title || 'Upgrade Required';
            } else if (msgLower.includes('login') || msgLower.includes('log in') || msgLower.includes('sign in')) {
                alertIcon = '🔐';
                alertTitle = options.title || 'Authentication Required';
            } else if (msgLower.includes('cancel')) {
                alertIcon = '👋';
                alertTitle = options.title || 'Cancelled';
            }
            // Clean up message (remove emoji prefixes that we're now showing as icons)
            let cleanMessage = message.replace(/^[🎉❌⚠️🔢⭐🔐👋ℹ️]\s*/g, '').trim();

            icon.textContent = alertIcon;
            title.textContent = alertTitle;
            msgEl.textContent = cleanMessage;
            modal.style.display = 'flex';

            // Focus OK button for keyboard accessibility
            okBtn.focus();

            return new Promise((resolve) => {
                const closeModal = () => {
                    modal.style.display = 'none';
                    okBtn.removeEventListener('click', closeModal);
                    document.removeEventListener('keydown', handleKey);
                    resolve();
                };

                const handleKey = (e) => {
                    if (e.key === 'Enter' || e.key === 'Escape') {
                        closeModal();
                    }
                };

                okBtn.addEventListener('click', closeModal);
                document.addEventListener('keydown', handleKey);
            });
        };

        // Beautiful Custom Confirm Function
        window.showConfirm = function (message, options = {}) {
            const modal = document.getElementById('customConfirmModal');
            const icon = document.getElementById('customConfirmIcon');
            const title = document.getElementById('customConfirmTitle');
            const msgEl = document.getElementById('customConfirmMessage');
            const okBtn = document.getElementById('customConfirmOk');
            const cancelBtn = document.getElementById('customConfirmCancel');

            // Set icon and title
            icon.textContent = options.icon || '🗑️';
            title.textContent = options.title || 'Confirm';
            msgEl.textContent = message;
            okBtn.textContent = options.confirmText || 'Remove';
            cancelBtn.textContent = options.cancelText || 'Cancel';

            modal.style.display = 'flex';
            cancelBtn.focus();

            return new Promise((resolve) => {
                const cleanup = () => {
                    modal.style.display = 'none';
                    okBtn.removeEventListener('click', handleOk);
                    cancelBtn.removeEventListener('click', handleCancel);
                    document.removeEventListener('keydown', handleKey);
                };

                const handleOk = () => { cleanup(); resolve(true); };
                const handleCancel = () => { cleanup(); resolve(false); };
                const handleKey = (e) => {
                    if (e.key === 'Escape') handleCancel();
                    if (e.key === 'Enter') handleOk();
                };

                okBtn.addEventListener('click', handleOk);
                cancelBtn.addEventListener('click', handleCancel);
                document.addEventListener('keydown', handleKey);
            });
        };

        // MIDI Settings Modal functions
        function openMidiSettings() {
            const modal = document.getElementById('midiSettingsModal');
            if (modal) {
                modal.style.display = 'flex';
                // Initialize MIDI if not already done
                if (window.midiController && !midiController.midiAccess) {
                    midiController.init().then(() => {
                        midiController.refreshMappingDisplays();
                    });
                } else if (window.midiController) {
                    midiController.refreshMappingDisplays();
                }
            }
        }

        function closeMidiSettings() {
            const modal = document.getElementById('midiSettingsModal');
            if (modal) {
                modal.style.display = 'none';
                // Cancel learn mode if active
                if (window.midiController) {
                    midiController.cancelLearn();
                }
            }
        }

        // Metronome helper functions
        function selectTimeSignature(btn) {
            // Remove active from all
            document.querySelectorAll('.metronome-ts-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const beats = parseInt(btn.dataset.beats);
            const unit = parseInt(btn.dataset.unit);
            if (window.metronome) {
                metronome.setTimeSignature(beats, unit);
            }
        }

        function selectMetronomeSound(btn) {
            // Remove active from all
            document.querySelectorAll('.metronome-sound-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const sound = btn.dataset.sound;
            if (window.metronome) {
                metronome.setSoundType(sound);
            }
        }
    </script>

    <!-- Pad Player -->
    <script src="pad-player.js"></script>
    <script src="metronome.js"></script>

    <!-- Chords App Format Parser (ChordPro-like format v4) -->
    <script src="chordpro-parser.js"></script>

    <script src="app.js?v=43"></script>

    <style>
        /* Auth message states - B&W */
        #authMessage.success {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
        }

        #authMessage.error {
            background: var(--text);
            color: var(--bg);
            border: 1px solid var(--text);
        }

        #authMessage.info {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
        }

        #profileMenu button:hover {
            background: var(--background-secondary);
        }

        /* Live Mode theme-aware solid backgrounds */
        [data-theme="dark"] #liveModeOverlay {
            background: #000000 !important;
        }

        [data-theme="light"] #liveModeOverlay {
            background: #ffffff !important;
        }

        [data-theme="dark"] #liveModeContent {
            background: #000000 !important;
        }

        [data-theme="light"] #liveModeContent {
            background: #ffffff !important;
        }

        [data-theme="dark"] #liveModeBottomBar {
            background: #000000 !important;
        }

        [data-theme="light"] #liveModeBottomBar {
            background: #ffffff !important;
        }

        [data-theme="dark"] #liveModeTopBar {
            background: #000000 !important;
        }

        [data-theme="light"] #liveModeTopBar {
            background: #ffffff !important;
        }

        [data-theme="dark"] #liveModePlaylistSidebar {
            background: #000000 !important;
        }

        [data-theme="light"] #liveModePlaylistSidebar {
            background: #ffffff !important;
        }

        /* Hide song title/meta in live mode (shown in top bar) but keep badges row visible */
        #liveModeChartDisplay .song-header .song-title,
        #liveModeChartDisplay .song-header .song-meta {
            display: none;
        }

        /* Always show section badges row in Live Mode (unless hide-badges is set) */
        #liveModeChartDisplay .section-badges-row {
            display: flex;
            margin-bottom: 12px;
        }

        #liveModeChartDisplay.hide-badges .section-badges-row {
            display: none;
        }

        /* Show full song header in Full Overview mode */
        #liveModeChartDisplay.full-overview-active .song-header .song-title,
        #liveModeChartDisplay.full-overview-active .song-header .song-meta {
            display: block;
            margin-bottom: 8px;
        }

        /* Force single column in Full Overview mode */
        #liveModeChartDisplay.full-overview-active {
            column-count: 1 !important;
            columns: auto !important;
            column-width: auto !important;
            height: auto !important;
            max-width: 100% !important;
            column-gap: 0 !important;
        }
    </style>

    <script>
        // Custom Modal System
        const modal = {
            overlay: document.getElementById('customModal'),
            title: document.getElementById('modalTitle'),
            message: document.getElementById('modalMessage'),
            input: document.getElementById('modalInput'),
            confirmBtn: document.getElementById('modalConfirm'),
            cancelBtn: document.getElementById('modalCancel'),
            closeBtn: document.getElementById('modalClose'),

            show: function (title, message, showInput = false) {
                return new Promise((resolve, reject) => {
                    this.title.textContent = title;
                    this.message.textContent = message;
                    this.input.style.display = showInput ? 'block' : 'none';
                    if (showInput) this.input.value = '10';
                    this.overlay.style.display = 'flex';

                    const handleConfirm = () => {
                        if (showInput) {
                            const value = parseFloat(this.input.value);
                            if (!value || value <= 0) {
                                this.input.style.borderColor = 'var(--primary)';
                                setTimeout(() => {
                                    this.input.style.borderColor = '';
                                }, 500);
                                return;
                            }
                            this.close();
                            resolve(value);
                        } else {
                            this.close();
                            resolve(true);
                        }
                    };

                    const handleCancel = () => {
                        this.close();
                        resolve(null);
                    };

                    this.confirmBtn.onclick = handleConfirm;
                    this.cancelBtn.onclick = handleCancel;
                    this.closeBtn.onclick = handleCancel;
                    this.overlay.onclick = (e) => {
                        if (e.target === this.overlay) handleCancel();
                    };

                    // Enter key support
                    const handleEnter = (e) => {
                        if (e.key === 'Enter') {
                            handleConfirm();
                            document.removeEventListener('keydown', handleEnter);
                        }
                    };
                    document.addEventListener('keydown', handleEnter);
                });
            },

            close: function () {
                this.overlay.style.display = 'none';
                this.input.style.borderColor = '';
            }
        };

        // Save as Image functionality
        (function () {
            const saveAsImageBtn = document.getElementById('saveAsImageButton');
            if (saveAsImageBtn) {
                saveAsImageBtn.addEventListener('click', async function () {
                    const livePreview = document.getElementById('livePreview');
                    if (!livePreview || !livePreview.innerHTML.trim()) {
                        showAlert('Nothing to save. Please load or create a chord sheet first.');
                        return;
                    }

                    // Show loading state
                    const originalText = saveAsImageBtn.innerHTML;
                    saveAsImageBtn.innerHTML = 'Saving...';
                    saveAsImageBtn.disabled = true;

                    try {
                        // Get song title for filename
                        const titleEl = livePreview.querySelector('.song-title');
                        const songTitle = titleEl ? titleEl.textContent.trim().replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '_') : 'chord_sheet';

                        // Capture the full preview page (content + footer with user branding)
                        const captureTarget = document.querySelector('.preview-page[data-page="1"]');

                        // Capture the preview
                        const canvas = await html2canvas(captureTarget, {
                            backgroundColor: '#ffffff',
                            scale: 2, // Higher resolution for better quality
                            useCORS: true,
                            logging: false,
                            width: captureTarget.scrollWidth,
                            height: captureTarget.scrollHeight,
                            windowWidth: captureTarget.scrollWidth,
                            windowHeight: captureTarget.scrollHeight
                        });

                        // Convert to image
                        const imageData = canvas.toDataURL('image/png', 1.0);

                        // Check if on mobile (for different save behavior)
                        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

                        if (isMobile) {
                            // On mobile, open image in new tab so user can long-press to save
                            const newTab = window.open();
                            if (newTab) {
                                newTab.document.write(`
                                    <html>
                                    <head>
                                        <title>${songTitle}</title>
                                        <meta name="viewport" content="width=device-width, initial-scale=1">
                                        <style>
                                            body { margin: 0; padding: 20px; background: #fff; text-align: center; font-family: -apple-system, sans-serif; }
                                            img { max-width: 100%; height: auto; border: 1px solid #000; }
                                            p { color: #000; margin-top: 20px; font-size: 14px; }
                                        </style>
                                    </head>
                                    <body>
                                        <img src="${imageData}" alt="${songTitle}">
                                        <p>Long-press the image to save to your Photos</p>
                                    </body>
                                    </html>
                                `);
                                newTab.document.close();
                            } else {
                                // Fallback: direct download
                                downloadImage(imageData, songTitle);
                            }
                        } else {
                            // On desktop, trigger download
                            downloadImage(imageData, songTitle);
                        }

                        saveAsImageBtn.innerHTML = 'Saved!';
                        setTimeout(() => {
                            saveAsImageBtn.innerHTML = originalText;
                            saveAsImageBtn.disabled = false;
                        }, 2000);

                    } catch (error) {
                        console.error('Error saving image:', error);
                        showAlert('Failed to save image. Please try again.');
                        saveAsImageBtn.innerHTML = originalText;
                        saveAsImageBtn.disabled = false;
                    }
                });
            }

            // Header Save as Image button - triggers the same functionality
            const headerSaveAsImage = document.getElementById('headerSaveAsImage');
            if (headerSaveAsImage && saveAsImageBtn) {
                headerSaveAsImage.addEventListener('click', () => {
                    saveAsImageBtn.click();
                });
            }

            // Layout section Image button
            const layoutSaveAsImage = document.getElementById('layoutSaveAsImage');
            if (layoutSaveAsImage && saveAsImageBtn) {
                layoutSaveAsImage.addEventListener('click', () => {
                    saveAsImageBtn.click();
                });
            }

            // Layout section Print button
            const layoutPrintButton = document.getElementById('layoutPrintButton');
            const mainPrintButton = document.getElementById('printButton');
            if (layoutPrintButton && mainPrintButton) {
                layoutPrintButton.addEventListener('click', () => {
                    mainPrintButton.click();
                });
            }

            // Layout section Auto Fit button
            const layoutAutoFitButton = document.getElementById('layoutAutoFitButton');
            const headerAutoFitBtn = document.getElementById('headerAutoFit');
            if (layoutAutoFitButton && headerAutoFitBtn) {
                layoutAutoFitButton.addEventListener('click', () => {
                    headerAutoFitBtn.click();
                });
            }

            // Header Save Song button
            const headerSaveSong = document.getElementById('headerSaveSong');
            const mainSaveSongBtn = document.getElementById('saveSongButton');
            if (headerSaveSong && mainSaveSongBtn) {
                headerSaveSong.addEventListener('click', () => {
                    mainSaveSongBtn.click();
                });
            }

            // Header Load Song button
            const headerLoadSong = document.getElementById('headerLoadSong');
            const mainLoadSongBtn = document.getElementById('loadSongButton');
            if (headerLoadSong && mainLoadSongBtn) {
                headerLoadSong.addEventListener('click', () => {
                    mainLoadSongBtn.click();
                });
            }

            // Header Pads button
            const headerPadsBtn = document.getElementById('headerPadsBtn');
            if (headerPadsBtn) {
                headerPadsBtn.addEventListener('click', async () => {
                    const padsModal = document.getElementById('padsModal');
                    if (padsModal) {
                        padsModal.style.display = 'flex';

                        // Load sounds if not already loaded
                        if (window.padPlayer && Object.keys(padPlayer.buffers).length === 0) {
                            const loadingDiv = document.getElementById('padsLoading');
                            const gridDiv = document.getElementById('padsGrid');
                            const progressDiv = document.getElementById('padsLoadingProgress');

                            if (loadingDiv) loadingDiv.style.display = 'block';
                            if (gridDiv) gridDiv.style.opacity = '0.3';

                            await padPlayer.loadSounds((loaded, total) => {
                                if (progressDiv) progressDiv.textContent = `${loaded}/${total}`;
                            });

                            if (loadingDiv) loadingDiv.style.display = 'none';
                            if (gridDiv) gridDiv.style.opacity = '1';
                        }
                    }
                });
            }

            function downloadImage(dataUrl, filename) {
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = `${filename}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        })();

        // ============= USER BRANDING (Logo + Custom Text) =============
        (function () {
            const LOGO_STORAGE_KEY = 'chordsapp-user-logo';
            const BRANDING_TEXT_KEY = 'chordsapp-branding-text';
            const HIDE_ACHORDIM_KEY = 'chordsapp-hide-achordim';
            const MAX_LOGO_SIZE = 200 * 1024; // 200KB

            const avatarContainer = document.getElementById('sideMenuAvatarContainer');
            const logoInput = document.getElementById('logoUploadInput');
            const avatarSpan = document.getElementById('sideMenuUserAvatar');
            const logoImg = document.getElementById('sideMenuUserLogo');
            const clearLogoBtn = document.getElementById('clearLogoBtn');
            const brandingInput = document.getElementById('brandingTextInput');
            const footerLogo = document.getElementById('footerUserLogo');
            const footerText = document.getElementById('footerBrandingText');
            const footerContainer = document.getElementById('userBrandingFooter');

            // --- Logo Upload ---
            if (avatarContainer && logoInput) {
                avatarContainer.addEventListener('click', () => logoInput.click());

                logoInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    if (file.size > MAX_LOGO_SIZE) {
                        showAlert('Logo image must be under 200KB. Please use a smaller image.');
                        logoInput.value = '';
                        return;
                    }

                    try {
                        const reader = new FileReader();
                        const base64 = await new Promise((resolve, reject) => {
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });

                        localStorage.setItem(LOGO_STORAGE_KEY, base64);
                        applyLogo(base64);
                        syncBrandingToFirebase();
                    } catch (err) {
                        console.error('Logo upload error:', err);
                        showAlert('Failed to upload logo. Please try again.');
                    }

                    logoInput.value = '';
                });
            }

            // --- Clear Logo ---
            if (clearLogoBtn) {
                clearLogoBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    localStorage.removeItem(LOGO_STORAGE_KEY);
                    removeLogo();
                    syncBrandingToFirebase();
                });
            }

            // --- Branding Text ---
            if (brandingInput) {
                let debounceTimer;
                brandingInput.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        const text = brandingInput.value.trim();
                        localStorage.setItem(BRANDING_TEXT_KEY, text);
                        applyBrandingText(text);
                        syncBrandingToFirebase();
                    }, 500);
                });
            }

            // --- Apply Functions ---
            function applyLogo(base64) {
                if (logoImg) {
                    logoImg.src = base64;
                    logoImg.style.display = 'block';
                }
                if (avatarSpan) avatarSpan.style.display = 'none';
                if (avatarContainer) avatarContainer.style.background = 'var(--bg)';
                if (clearLogoBtn) clearLogoBtn.style.display = 'inline-block';
                if (footerLogo) {
                    footerLogo.src = base64;
                    footerLogo.style.display = 'block';
                }
                updateFooterVisibility();
            }

            function removeLogo() {
                if (logoImg) {
                    logoImg.src = '';
                    logoImg.style.display = 'none';
                }
                if (avatarSpan) avatarSpan.style.display = '';
                if (avatarContainer) avatarContainer.style.background = 'var(--text)';
                if (clearLogoBtn) clearLogoBtn.style.display = 'none';
                if (footerLogo) {
                    footerLogo.src = '';
                    footerLogo.style.display = 'none';
                }
                updateFooterVisibility();
            }

            function applyBrandingText(text) {
                if (footerText) footerText.textContent = text;
                updateFooterVisibility();
            }

            function updateFooterVisibility() {
                if (!footerContainer) return;
                const hasLogo = footerLogo && footerLogo.src && footerLogo.src !== '' && footerLogo.style.display !== 'none';
                const hasText = footerText && footerText.textContent.trim();
                if (hasLogo || hasText) {
                    footerContainer.style.display = 'flex';
                    footerContainer.classList.add('active');
                } else {
                    footerContainer.style.display = 'none';
                    footerContainer.classList.remove('active');
                }
            }

            // --- Firebase Sync ---
            async function syncBrandingToFirebase() {
                try {
                    const user = firebase.auth().currentUser;
                    if (!user) return;

                    const branding = {
                        logoBase64: localStorage.getItem(LOGO_STORAGE_KEY) || null,
                        brandingText: localStorage.getItem(BRANDING_TEXT_KEY) || '',
                        updatedAt: Date.now()
                    };
                    await firebase.database().ref('users/' + user.uid + '/branding').set(branding);
                } catch (err) {
                    console.error('Branding sync error:', err);
                }
            }

            async function loadBrandingFromFirebase() {
                try {
                    const user = firebase.auth().currentUser;
                    if (!user) return;

                    const snapshot = await firebase.database()
                        .ref('users/' + user.uid + '/branding').once('value');
                    const branding = snapshot.val();

                    if (branding) {
                        if (branding.logoBase64) {
                            localStorage.setItem(LOGO_STORAGE_KEY, branding.logoBase64);
                            applyLogo(branding.logoBase64);
                        }
                        if (branding.brandingText) {
                            localStorage.setItem(BRANDING_TEXT_KEY, branding.brandingText);
                            if (brandingInput) brandingInput.value = branding.brandingText;
                            applyBrandingText(branding.brandingText);
                        }
                    }
                } catch (err) {
                    console.error('Branding load error:', err);
                }
            }

            // --- aChordim Branding Toggle ---
            const achordimBranding = document.getElementById('achordimBranding');
            const toggleBrandingBtn = document.getElementById('toggleAchordimBrandingBtn');

            function applyAchordimVisibility(hidden) {
                if (achordimBranding) {
                    achordimBranding.style.display = hidden ? 'none' : 'flex';
                }
                if (toggleBrandingBtn) {
                    const showKey = 'branding.show_footer';
                    const hideKey = 'branding.hide_footer';
                    toggleBrandingBtn.textContent = window.t ? window.t(hidden ? showKey : hideKey) : (hidden ? 'Show aChordim footer' : 'Hide aChordim footer');
                    toggleBrandingBtn.setAttribute('data-i18n', hidden ? showKey : hideKey);
                    toggleBrandingBtn.style.background = hidden ? 'var(--text)' : 'transparent';
                    toggleBrandingBtn.style.color = hidden ? 'var(--bg)' : 'var(--text)';
                }
            }

            if (toggleBrandingBtn) {
                toggleBrandingBtn.addEventListener('click', () => {
                    const isHidden = localStorage.getItem(HIDE_ACHORDIM_KEY) === 'true';
                    const newState = !isHidden;
                    localStorage.setItem(HIDE_ACHORDIM_KEY, String(newState));
                    applyAchordimVisibility(newState);
                });
            }

            // --- Initialize from localStorage (instant, offline) ---
            function initBranding() {
                const savedLogo = localStorage.getItem(LOGO_STORAGE_KEY);
                const savedText = localStorage.getItem(BRANDING_TEXT_KEY);
                const hideAchordim = localStorage.getItem(HIDE_ACHORDIM_KEY) === 'true';

                if (savedLogo) applyLogo(savedLogo);
                if (savedText) {
                    if (brandingInput) brandingInput.value = savedText;
                    applyBrandingText(savedText);
                }
                applyAchordimVisibility(hideAchordim);
            }

            initBranding();

            // Expose for auth.js
            window.loadBrandingFromFirebase = loadBrandingFromFirebase;
            window.initBranding = initBranding;
        })();

        // ============= EMOJI TOGGLE =============
        (function () {
            const EMOJI_KEY = 'chordsapp-hide-emojis';
            const emojiRegex = /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{27BF}\u{2B50}\u{2702}-\u{27B0}\u{FE0F}\u{200D}\u{23CF}\u{23E9}-\u{23F3}\u{231A}\u{231B}\u{2328}\u{23F0}\u{23F8}-\u{23FA}\u{25AA}\u{25AB}\u{25B6}\u{25C0}\u{25FB}-\u{25FE}\u{2934}\u{2935}\u{2B05}-\u{2B07}\u{1F900}-\u{1F9FF}\u{1FA70}-\u{1FAFF}]/gu;
            const toggle = document.getElementById('hideEmojisToggle');
            let originalTexts = new Map();

            function stripEmojis() {
                document.querySelectorAll('[data-i18n], .header-btn, .side-menu-btn, .ghost-button, .primary-action, button, label, span, h2, h3, h4, p, div').forEach(el => {
                    el.childNodes.forEach(node => {
                        if (node.nodeType === Node.TEXT_NODE && emojiRegex.test(node.textContent)) {
                            if (!originalTexts.has(node)) {
                                originalTexts.set(node, node.textContent);
                            }
                            node.textContent = node.textContent.replace(emojiRegex, '').replace(/^\s+/, '');
                        }
                    });
                });
            }

            function restoreEmojis() {
                originalTexts.forEach((original, node) => {
                    if (node.parentNode) {
                        node.textContent = original;
                    }
                });
                originalTexts.clear();
                // Re-apply translations to get emoji versions back
                if (window.localization) {
                    window.localization.updateUI();
                }
            }

            function applyEmojiState(hidden) {
                if (hidden) {
                    stripEmojis();
                    document.documentElement.classList.add('hide-emojis');
                } else {
                    restoreEmojis();
                    document.documentElement.classList.remove('hide-emojis');
                }
            }

            if (toggle) {
                const saved = localStorage.getItem(EMOJI_KEY) === 'true';
                toggle.checked = saved;

                toggle.addEventListener('change', () => {
                    const hidden = toggle.checked;
                    localStorage.setItem(EMOJI_KEY, String(hidden));
                    applyEmojiState(hidden);
                });

                // Apply on load (after small delay to let translations render)
                if (saved) {
                    setTimeout(() => applyEmojiState(true), 200);
                }
            }

            // Re-strip after language change
            window.addEventListener('languageChanged', () => {
                if (localStorage.getItem(EMOJI_KEY) === 'true') {
                    setTimeout(() => stripEmojis(), 100);
                }
            });
        })();

        // Hide header on scroll
        (function () {
            const header = document.querySelector('.app-header');
            let lastScrollTop = 0;
            let isScrolling;

            window.addEventListener('scroll', function () {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

                // Clear timeout if scrolling
                clearTimeout(isScrolling);

                if (scrollTop > lastScrollTop && scrollTop > 100) {
                    // Scrolling down - hide header
                    header.style.transform = 'translateY(-100%)';
                    header.style.transition = 'transform 0.3s ease-in-out';
                } else {
                    // Scrolling up - show header
                    header.style.transform = 'translateY(0)';
                    header.style.transition = 'transform 0.3s ease-in-out';
                }

                lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
            }, false);
        })();

        // ============================================
        // SIDE MENU - Toggle & Control Sync
        // ============================================
        (function () {
            const hamburgerBtn = document.getElementById('sideMenuToggle');
            const sideMenuPanel = document.getElementById('sideMenuPanel');
            const sideMenuOverlay = document.getElementById('sideMenuOverlay');
            const sideMenuClose = document.getElementById('sideMenuClose');

            // Toggle menu
            function openMenu() {
                hamburgerBtn.classList.add('active');
                sideMenuPanel.classList.add('active');
                sideMenuOverlay.classList.add('active');
                // Allow scrolling main content while menu is open
            }

            function closeMenu() {
                hamburgerBtn.classList.remove('active');
                sideMenuPanel.classList.remove('active');
                sideMenuOverlay.classList.remove('active');
            }

            if (hamburgerBtn) {
                hamburgerBtn.addEventListener('click', () => {
                    if (sideMenuPanel.classList.contains('active')) {
                        closeMenu();
                    } else {
                        openMenu();
                    }
                });
            }

            if (sideMenuOverlay) {
                sideMenuOverlay.addEventListener('click', closeMenu);
            }

            if (sideMenuClose) {
                sideMenuClose.addEventListener('click', closeMenu);
            }

            // Close on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && sideMenuPanel.classList.contains('active')) {
                    closeMenu();
                }
            });

            // Triple-click on empty area opens menu
            let clickCount = 0;
            let clickTimer = null;
            const TRIPLE_CLICK_DELAY = 500; // ms between clicks

            document.addEventListener('click', (e) => {
                // Check if click is on an "empty" area (not interactive elements)
                const target = e.target;
                const isInteractive = target.closest('button, a, input, select, textarea, [onclick], .modal, .side-menu-panel, .song-item, .clickable, [role="button"]');

                if (isInteractive) {
                    clickCount = 0;
                    if (clickTimer) clearTimeout(clickTimer);
                    return;
                }

                clickCount++;

                if (clickTimer) clearTimeout(clickTimer);

                if (clickCount >= 3) {
                    // Triple click detected - open menu
                    clickCount = 0;
                    if (!sideMenuPanel.classList.contains('active')) {
                        openMenu();
                    }
                } else {
                    // Reset after delay
                    clickTimer = setTimeout(() => {
                        clickCount = 0;
                    }, TRIPLE_CLICK_DELAY);
                }
            });

            // ---- SYNC SIDEBAR CONTROLS WITH MAIN CONTROLS ----

            // Quick Actions: Print
            const sideMenuPrint = document.getElementById('sideMenuPrint');
            const mainPrintBtn = document.getElementById('printButton');
            if (sideMenuPrint && mainPrintBtn) {
                sideMenuPrint.addEventListener('click', () => {
                    closeMenu();
                    mainPrintBtn.click();
                });
            }

            // Quick Actions: Save as Image (use existing saveAsImageButton)
            const sideMenuSaveImage = document.getElementById('saveAsImageButton');
            // Already has its own event listener

            // Quick Actions: Live Preview toggle
            const sideMenuLivePreview = document.getElementById('livePreviewToggle');
            const mainLivePreviewBtn = document.getElementById('livePreviewBtn');
            if (sideMenuLivePreview && mainLivePreviewBtn) {
                sideMenuLivePreview.addEventListener('click', () => {
                    closeMenu();
                    mainLivePreviewBtn.click();
                });
            }

            // Quick Actions: Save Layout
            const sideMenuSaveLayout = document.getElementById('saveLayoutButton');
            const mainSaveLayoutBtn = document.getElementById('saveLayoutBtn');
            if (sideMenuSaveLayout && mainSaveLayoutBtn) {
                sideMenuSaveLayout.addEventListener('click', () => {
                    closeMenu();
                    mainSaveLayoutBtn.click();
                });
            }

            // Display: Nashville Mode sync
            const sideMenuNashvilleMode = document.getElementById('sideMenuNashvilleMode');
            const mainNashvilleMode = document.getElementById('nashvilleMode');
            if (sideMenuNashvilleMode && mainNashvilleMode) {
                // Sync initial value
                sideMenuNashvilleMode.value = mainNashvilleMode.value;

                // Side menu changes main
                sideMenuNashvilleMode.addEventListener('change', () => {
                    mainNashvilleMode.value = sideMenuNashvilleMode.value;
                    mainNashvilleMode.dispatchEvent(new Event('change'));
                });

                // Main changes side menu
                mainNashvilleMode.addEventListener('change', () => {
                    sideMenuNashvilleMode.value = mainNashvilleMode.value;
                });
            }

            // Display: Font Size sync
            const sideMenuFontSize = document.getElementById('sideMenuFontSize');
            const sideMenuFontSizeVal = document.getElementById('sideMenuFontSizeVal');
            const mainFontSize = document.getElementById('fontSizeSlider');
            const mainFontSizeVal = document.getElementById('fontSizeValue');
            if (sideMenuFontSize && mainFontSize) {
                // Sync initial value
                sideMenuFontSize.value = mainFontSize.value;
                if (sideMenuFontSizeVal) sideMenuFontSizeVal.textContent = mainFontSize.value + 'pt';

                sideMenuFontSize.addEventListener('input', () => {
                    mainFontSize.value = sideMenuFontSize.value;
                    mainFontSize.dispatchEvent(new Event('input'));
                    if (sideMenuFontSizeVal) sideMenuFontSizeVal.textContent = sideMenuFontSize.value + 'pt';
                });

                mainFontSize.addEventListener('input', () => {
                    sideMenuFontSize.value = mainFontSize.value;
                    if (sideMenuFontSizeVal) sideMenuFontSizeVal.textContent = mainFontSize.value + 'pt';
                });
            }

            // Display: Line Height sync
            const sideMenuLineHeight = document.getElementById('sideMenuLineHeight');
            const sideMenuLineHeightVal = document.getElementById('sideMenuLineHeightVal');
            const mainLineHeight = document.getElementById('lineHeightSlider');
            if (sideMenuLineHeight && mainLineHeight) {
                sideMenuLineHeight.value = mainLineHeight.value;
                if (sideMenuLineHeightVal) sideMenuLineHeightVal.textContent = mainLineHeight.value;

                sideMenuLineHeight.addEventListener('input', () => {
                    mainLineHeight.value = sideMenuLineHeight.value;
                    mainLineHeight.dispatchEvent(new Event('input'));
                    if (sideMenuLineHeightVal) sideMenuLineHeightVal.textContent = sideMenuLineHeight.value;
                });

                mainLineHeight.addEventListener('input', () => {
                    sideMenuLineHeight.value = mainLineHeight.value;
                    if (sideMenuLineHeightVal) sideMenuLineHeightVal.textContent = mainLineHeight.value;
                });
            }

            // Display: Char Spacing sync
            const sideMenuCharSpacing = document.getElementById('sideMenuCharSpacing');
            const sideMenuCharSpacingVal = document.getElementById('sideMenuCharSpacingVal');
            const mainCharSpacing = document.getElementById('charSpacingSlider');
            if (sideMenuCharSpacing && mainCharSpacing) {
                sideMenuCharSpacing.value = mainCharSpacing.value;
                if (sideMenuCharSpacingVal) sideMenuCharSpacingVal.textContent = mainCharSpacing.value + 'px';

                sideMenuCharSpacing.addEventListener('input', () => {
                    mainCharSpacing.value = sideMenuCharSpacing.value;
                    mainCharSpacing.dispatchEvent(new Event('input'));
                    if (sideMenuCharSpacingVal) sideMenuCharSpacingVal.textContent = sideMenuCharSpacing.value + 'px';
                });

                mainCharSpacing.addEventListener('input', () => {
                    sideMenuCharSpacing.value = mainCharSpacing.value;
                    if (sideMenuCharSpacingVal) sideMenuCharSpacingVal.textContent = mainCharSpacing.value + 'px';
                });
            }

            // Display: Badges sync
            const sideMenuBadges = document.getElementById('sideMenuBadges');
            const mainBadges = document.getElementById('showBadges');
            if (sideMenuBadges && mainBadges) {
                sideMenuBadges.checked = mainBadges.checked;

                sideMenuBadges.addEventListener('change', () => {
                    mainBadges.checked = sideMenuBadges.checked;
                    mainBadges.dispatchEvent(new Event('change'));
                });

                mainBadges.addEventListener('change', () => {
                    sideMenuBadges.checked = mainBadges.checked;
                });
            }

            // Layout: Columns sync
            const sideMenuColumns = document.getElementById('sideMenuColumns');
            const mainColumns = document.getElementById('columnCount');
            if (sideMenuColumns && mainColumns) {
                sideMenuColumns.value = mainColumns.value;

                sideMenuColumns.addEventListener('change', () => {
                    mainColumns.value = sideMenuColumns.value;
                    mainColumns.dispatchEvent(new Event('change'));
                });

                mainColumns.addEventListener('change', () => {
                    sideMenuColumns.value = mainColumns.value;
                });
            }

            // Layout: Section Language sync
            const sideMenuLanguage = document.getElementById('sideMenuLanguage');
            const mainLanguage = document.getElementById('sectionLanguage');
            if (sideMenuLanguage && mainLanguage) {
                sideMenuLanguage.value = mainLanguage.value;

                sideMenuLanguage.addEventListener('change', () => {
                    mainLanguage.value = sideMenuLanguage.value;
                    mainLanguage.dispatchEvent(new Event('change'));
                });

                mainLanguage.addEventListener('change', () => {
                    sideMenuLanguage.value = mainLanguage.value;
                });
            }

            // Layout: Auto-fit
            const sideMenuAutoFit = document.getElementById('sideMenuAutoFit');
            const mainAutoFit = document.getElementById('autoFitButton');
            if (sideMenuAutoFit && mainAutoFit) {
                sideMenuAutoFit.addEventListener('click', () => {
                    mainAutoFit.click();
                });
            }

            // Transpose: Key selector sync
            const sideMenuKey = document.getElementById('sideMenuKey');
            const mainKey = document.getElementById('keySelector');
            if (sideMenuKey && mainKey) {
                sideMenuKey.value = mainKey.value;

                sideMenuKey.addEventListener('change', () => {
                    mainKey.value = sideMenuKey.value;
                    mainKey.dispatchEvent(new Event('change'));
                });

                mainKey.addEventListener('change', () => {
                    sideMenuKey.value = mainKey.value;
                    // Update key grid active state
                    updateKeyGrid(mainKey.value);
                });
            }

            // Transpose: Key grid buttons
            const keyBtns = document.querySelectorAll('.key-btn');
            function updateKeyGrid(keyValue) {
                const keyLetter = keyValue.split(' ')[0];
                keyBtns.forEach(btn => {
                    if (btn.dataset.key === keyLetter) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }

            keyBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const keyLetter = btn.dataset.key;
                    // Find matching major key in selector
                    const mainKey = document.getElementById('keySelector');
                    if (mainKey) {
                        const majorKey = keyLetter + ' Major';
                        if ([...mainKey.options].some(opt => opt.value === majorKey)) {
                            mainKey.value = majorKey;
                            mainKey.dispatchEvent(new Event('change'));
                        }
                    }
                    updateKeyGrid(keyLetter + ' Major');
                });
            });

            // Transpose: Transpose buttons
            const sideMenuTransposeDown = document.getElementById('sideMenuTransposeDown');
            const sideMenuTransposeUp = document.getElementById('sideMenuTransposeUp');
            const sideMenuTransposeReset = document.getElementById('sideMenuTransposeReset');
            const sideMenuTransposeVal = document.getElementById('sideMenuTransposeVal');
            const mainTransposeDown = document.getElementById('transposeDown');
            const mainTransposeUp = document.getElementById('transposeUp');
            const mainTransposeReset = document.getElementById('transposeReset');
            const mainTransposeVal = document.getElementById('transposeValue');

            function syncTransposeValue() {
                if (mainTransposeVal && sideMenuTransposeVal) {
                    sideMenuTransposeVal.textContent = mainTransposeVal.textContent || '0';
                }
            }

            if (sideMenuTransposeDown && mainTransposeDown) {
                sideMenuTransposeDown.addEventListener('click', () => {
                    mainTransposeDown.click();
                    setTimeout(syncTransposeValue, 50);
                });
            }

            if (sideMenuTransposeUp && mainTransposeUp) {
                sideMenuTransposeUp.addEventListener('click', () => {
                    mainTransposeUp.click();
                    setTimeout(syncTransposeValue, 50);
                });
            }

            if (sideMenuTransposeReset && mainTransposeReset) {
                sideMenuTransposeReset.addEventListener('click', () => {
                    mainTransposeReset.click();
                    setTimeout(syncTransposeValue, 50);
                });
            }

            // Song Info: BPM sync
            const sideMenuBPM = document.getElementById('sideMenuBPM');
            const mainBPM = document.getElementById('bpmInput');
            if (sideMenuBPM && mainBPM) {
                sideMenuBPM.value = mainBPM.value;

                sideMenuBPM.addEventListener('input', () => {
                    mainBPM.value = sideMenuBPM.value;
                    mainBPM.dispatchEvent(new Event('input'));
                });

                mainBPM.addEventListener('input', () => {
                    sideMenuBPM.value = mainBPM.value;
                });
            }

            // Song Info: Time signature sync
            const sideMenuTime = document.getElementById('sideMenuTime');
            const mainTime = document.getElementById('timeSignature');
            if (sideMenuTime && mainTime) {
                sideMenuTime.value = mainTime.value;

                sideMenuTime.addEventListener('change', () => {
                    mainTime.value = sideMenuTime.value;
                    mainTime.dispatchEvent(new Event('change'));
                });

                mainTime.addEventListener('change', () => {
                    sideMenuTime.value = mainTime.value;
                });
            }

            // Library: Save Song
            const sideMenuSave = document.getElementById('sideMenuSave');
            const mainSave = document.getElementById('saveButton');
            if (sideMenuSave && mainSave) {
                sideMenuSave.addEventListener('click', () => {
                    closeMenu();
                    mainSave.click();
                });
            }

            // Library: Load Song
            const sideMenuLoad = document.getElementById('sideMenuLoad');
            const mainLoad = document.getElementById('loadButton');
            if (sideMenuLoad && mainLoad) {
                sideMenuLoad.addEventListener('click', () => {
                    closeMenu();
                    mainLoad.click();
                });
            }

            // Library: Bulk Import
            const sideMenuBulkImport = document.getElementById('sideMenuBulkImport');
            const mainBulkImport = document.getElementById('bulkImportButton');
            if (sideMenuBulkImport && mainBulkImport) {
                sideMenuBulkImport.addEventListener('click', () => {
                    closeMenu();
                    mainBulkImport.click();
                });
            }

            // Library: Update Song
            const sideMenuUpdate = document.getElementById('sideMenuUpdate');
            const mainUpdate = document.getElementById('updateButton');
            if (sideMenuUpdate && mainUpdate) {
                sideMenuUpdate.addEventListener('click', () => {
                    closeMenu();
                    mainUpdate.click();
                });
            }

            // Live Sessions: Create Session
            const sideMenuCreateSession = document.getElementById('sideMenuCreateSession');
            if (sideMenuCreateSession) {
                sideMenuCreateSession.addEventListener('click', () => {
                    closeMenu();
                    if (window.sessionUI) {
                        sessionUI.showCreateSessionModal();
                    }
                });
            }

            // Live Sessions: Join Session
            const sideMenuJoinSession = document.getElementById('sideMenuJoinSession');
            if (sideMenuJoinSession) {
                sideMenuJoinSession.addEventListener('click', () => {
                    closeMenu();
                    if (window.sessionUI) {
                        sessionUI.showJoinSessionModal();
                    }
                });
            }

            // Live Sessions: My Sessions
            const sideMenuMySessions = document.getElementById('sideMenuMySessions');
            if (sideMenuMySessions) {
                sideMenuMySessions.addEventListener('click', () => {
                    closeMenu();
                    if (window.sessionUI) {
                        sessionUI.showMySessionsModal();
                    }
                });
            }

            // Live Sessions: Go Live
            const sideMenuGoLive = document.getElementById('sideMenuGoLive');
            if (sideMenuGoLive) {
                sideMenuGoLive.addEventListener('click', () => {
                    closeMenu();
                    if (window.liveMode) {
                        liveMode.enter();
                    }
                });
            }

            // Header: Go Live button
            const headerGoLiveBtn = document.getElementById('headerGoLiveBtn');
            if (headerGoLiveBtn) {
                headerGoLiveBtn.addEventListener('click', () => {
                    if (window.liveMode) {
                        liveMode.enter();
                    }
                });
            }

            // Pads: Mini player keys in side menu
            const miniPadsGrid = document.getElementById('miniPadsGrid');
            if (miniPadsGrid) {
                miniPadsGrid.addEventListener('click', async (e) => {
                    const btn = e.target.closest('.mini-pad-key');
                    if (!btn) return;

                    const key = btn.dataset.key;
                    if (!key) return;

                    // Load sounds if not already loaded
                    if (window.padPlayer && Object.keys(padPlayer.buffers).length === 0) {
                        btn.textContent = '...';
                        await padPlayer.loadSounds();
                        btn.textContent = padPlayer.keyDisplayNames[key] || key;
                    }

                    padPlayer.toggle(key);
                });
            }

            // Pads: Mini player volume slider
            const miniPadVolume = document.getElementById('miniPadVolume');
            if (miniPadVolume) {
                miniPadVolume.addEventListener('input', () => {
                    padPlayer.setVolume(miniPadVolume.value / 100);
                    // Sync with modal volume slider
                    const modalVolume = document.getElementById('padsVolume');
                    if (modalVolume) modalVolume.value = miniPadVolume.value;
                });
            }

            // Pads: Open Pads Modal (Full Controls)
            const sideMenuOpenPads = document.getElementById('sideMenuOpenPads');
            if (sideMenuOpenPads) {
                sideMenuOpenPads.addEventListener('click', async () => {
                    closeMenu();
                    const padsModal = document.getElementById('padsModal');
                    if (padsModal) {
                        padsModal.style.display = 'flex';

                        // Load sounds if not already loaded
                        if (window.padPlayer && Object.keys(padPlayer.buffers).length === 0) {
                            const loadingDiv = document.getElementById('padsLoading');
                            const gridDiv = document.getElementById('padsGrid');
                            const progressDiv = document.getElementById('padsLoadingProgress');

                            if (loadingDiv) loadingDiv.style.display = 'block';
                            if (gridDiv) gridDiv.style.opacity = '0.3';

                            await padPlayer.loadSounds((loaded, total) => {
                                if (progressDiv) progressDiv.textContent = `${loaded}/${total}`;
                            });

                            if (loadingDiv) loadingDiv.style.display = 'none';
                            if (gridDiv) gridDiv.style.opacity = '1';
                        }
                    }
                });
            }

            // Metronome: Open Metronome Modal (Full Controls)
            const sideMenuOpenMetronome = document.getElementById('sideMenuOpenMetronome');
            if (sideMenuOpenMetronome) {
                sideMenuOpenMetronome.addEventListener('click', () => {
                    closeMenu();
                    const metronomeModal = document.getElementById('metronomeModal');
                    if (metronomeModal) {
                        metronomeModal.style.display = 'flex';
                    }
                });
            }

            // Pads Modal: Close button
            const padsModalClose = document.getElementById('padsModalClose');
            if (padsModalClose) {
                padsModalClose.addEventListener('click', () => {
                    const padsModal = document.getElementById('padsModal');
                    if (padsModal) padsModal.style.display = 'none';
                });
            }

            // Pads Modal: Click outside to close
            const padsModal = document.getElementById('padsModal');
            if (padsModal) {
                padsModal.addEventListener('click', (e) => {
                    if (e.target === padsModal) {
                        padsModal.style.display = 'none';
                    }
                });
            }

            // Metronome: Header button
            const headerMetronomeBtn = document.getElementById('headerMetronomeBtn');
            if (headerMetronomeBtn) {
                headerMetronomeBtn.addEventListener('click', () => {
                    const metronomeModal = document.getElementById('metronomeModal');
                    if (metronomeModal) {
                        metronomeModal.style.display = 'flex';
                    }
                });
            }

            // Metronome Modal: Close button
            const metronomeModalClose = document.getElementById('metronomeModalClose');
            if (metronomeModalClose) {
                metronomeModalClose.addEventListener('click', () => {
                    const metronomeModal = document.getElementById('metronomeModal');
                    if (metronomeModal) metronomeModal.style.display = 'none';
                });
            }

            // Metronome Modal: Click outside to close
            const metronomeModal = document.getElementById('metronomeModal');
            if (metronomeModal) {
                metronomeModal.addEventListener('click', (e) => {
                    if (e.target === metronomeModal) {
                        metronomeModal.style.display = 'none';
                    }
                });
            }

            // Pads Controls: Set up all sliders
            const padsCrossfade = document.getElementById('padsCrossfade');
            const padsLowPass = document.getElementById('padsLowPass');
            const padsHighPass = document.getElementById('padsHighPass');
            const padsReverb = document.getElementById('padsReverb');
            const padsPan = document.getElementById('padsPan');
            const padsVolume = document.getElementById('padsVolume');

            if (padsCrossfade) {
                padsCrossfade.addEventListener('input', () => {
                    // Convert 10-500 to 0.1-5 seconds
                    padPlayer.setCrossfade(padsCrossfade.value / 100);
                });
            }

            if (padsLowPass) {
                padsLowPass.addEventListener('input', () => {
                    // 0-100 maps to filter frequency
                    padPlayer.setLowPass(padsLowPass.value / 100);
                });
            }

            if (padsHighPass) {
                padsHighPass.addEventListener('input', () => {
                    // 0-100 maps to filter frequency
                    padPlayer.setHighPass(padsHighPass.value / 100);
                });
            }

            if (padsReverb) {
                padsReverb.addEventListener('input', () => {
                    // 0-100 maps to 0-1
                    padPlayer.setReverb(padsReverb.value / 100);
                });
            }

            if (padsPan) {
                padsPan.addEventListener('input', () => {
                    // -100 to 100 maps to -1 to 1
                    padPlayer.setPan(padsPan.value / 100);
                });
            }

            if (padsVolume) {
                padsVolume.addEventListener('input', () => {
                    padPlayer.setVolume(padsVolume.value / 100);
                    // Sync with mini player volume slider
                    const miniVolume = document.getElementById('miniPadVolume');
                    if (miniVolume) miniVolume.value = padsVolume.value;
                });
            }

            // Initialize key grid based on current key
            if (mainKey) {
                updateKeyGrid(mainKey.value);
            }

            // Display: Show Main Controls toggle
            const sideMenuShowControls = document.getElementById('sideMenuShowControls');
            const editorActionsSection = document.querySelector('.editor-actions-section');
            const sessionSection = document.querySelector('.session-section');
            const advancedControls = document.getElementById('advancedControls');

            function setMainControlsVisibility(visible) {
                if (visible) {
                    // Show all controls
                    if (editorActionsSection) editorActionsSection.style.display = '';
                    if (sessionSection) sessionSection.style.display = '';
                    if (advancedControls) advancedControls.style.display = 'flex';
                } else {
                    // Hide all controls
                    if (editorActionsSection) editorActionsSection.style.display = 'none';
                    if (sessionSection) sessionSection.style.display = 'none';
                    if (advancedControls) advancedControls.style.display = 'none';
                }
            }

            if (sideMenuShowControls) {
                // Load saved preference or use default (hidden)
                const savedShowControls = localStorage.getItem('chordsapp-show-controls');
                const showControls = savedShowControls !== null ? savedShowControls === 'true' : false;
                sideMenuShowControls.checked = showControls;
                // Always apply visibility on load
                setMainControlsVisibility(showControls);

                sideMenuShowControls.addEventListener('change', () => {
                    const show = sideMenuShowControls.checked;
                    setMainControlsVisibility(show);
                    localStorage.setItem('chordsapp-show-controls', show);
                });
            }

            // Display: Follow Arrangement toggle
            const followArrangementBtn = document.getElementById('followArrangementBtn');
            const followArrangementBtn2 = document.getElementById('followArrangementBtn2');

            if (followArrangementBtn) {
                // Load saved preference or use default (unchecked)
                const savedFollowArrangement = localStorage.getItem('chordsapp-follow-arrangement');
                const followArrangement = savedFollowArrangement === 'true';
                followArrangementBtn.checked = followArrangement;
                if (followArrangementBtn2) followArrangementBtn2.checked = followArrangement;

                // Initialize the state in app.js if toggle function exists
                if (followArrangement && window.toggleFollowArrangement) {
                    window.toggleFollowArrangement(true);
                }

                followArrangementBtn.addEventListener('change', () => {
                    const enabled = followArrangementBtn.checked;
                    localStorage.setItem('chordsapp-follow-arrangement', enabled);
                    if (followArrangementBtn2) followArrangementBtn2.checked = enabled;
                    if (window.toggleFollowArrangement) {
                        window.toggleFollowArrangement(enabled);
                    }
                });
            }

            // Sync second Follow Arrangement button (in Layout Customization)
            if (followArrangementBtn2) {
                followArrangementBtn2.addEventListener('change', () => {
                    const enabled = followArrangementBtn2.checked;
                    localStorage.setItem('chordsapp-follow-arrangement', enabled);
                    if (followArrangementBtn) followArrangementBtn.checked = enabled;
                    if (window.toggleFollowArrangement) {
                        window.toggleFollowArrangement(enabled);
                    }
                });
            }

            // Display: Show Edit Workspace toggle
            const sideMenuShowEditor = document.getElementById('sideMenuShowEditor');
            const editorSection = document.getElementById('editor');

            if (sideMenuShowEditor && editorSection) {
                // Load saved preference or use default (unchecked/hidden)
                const savedShowEditor = localStorage.getItem('chordsapp-show-editor');
                const showEditor = savedShowEditor === 'true';
                sideMenuShowEditor.checked = showEditor;
                editorSection.style.display = showEditor ? 'block' : 'none';

                sideMenuShowEditor.addEventListener('change', () => {
                    const show = sideMenuShowEditor.checked;
                    editorSection.style.display = show ? 'block' : 'none';
                    localStorage.setItem('chordsapp-show-editor', show);
                });
            }

            // Display: Show SongBook Format toggle
            const sideMenuShowSongbook = document.getElementById('sideMenuShowSongbook');
            const songbookSection = document.getElementById('songbookSection');

            if (sideMenuShowSongbook && songbookSection) {
                // Load saved preference or use default (unchecked/hidden)
                const savedShowSongbook = localStorage.getItem('chordsapp-show-songbook');
                const showSongbook = savedShowSongbook === 'true';
                sideMenuShowSongbook.checked = showSongbook;
                songbookSection.style.display = showSongbook ? 'block' : 'none';

                sideMenuShowSongbook.addEventListener('change', () => {
                    const show = sideMenuShowSongbook.checked;
                    songbookSection.style.display = show ? 'block' : 'none';
                    localStorage.setItem('chordsapp-show-songbook', show);
                    // Sync toggle button
                    const toggleBtn = document.getElementById('toggleSongbookBtn');
                    if (toggleBtn) toggleBtn.classList.toggle('active', show);
                });
            }

            // ============================================
            // DISPLAY TOGGLE BUTTONS (Controls & Editor)
            // ============================================

            // Helper to sync all toggle buttons with same function
            function syncToggleButtons(btn1Id, btn2Id, checkbox) {
                const btn1 = document.getElementById(btn1Id);
                const btn2 = document.getElementById(btn2Id);

                [btn1, btn2].forEach(btn => {
                    if (btn && checkbox) {
                        btn.classList.toggle('active', checkbox.checked);
                        btn.addEventListener('click', () => {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        });
                    }
                });

                // Sync when checkbox changes
                if (checkbox) {
                    checkbox.addEventListener('change', () => {
                        [btn1, btn2].forEach(btn => {
                            if (btn) btn.classList.toggle('active', checkbox.checked);
                        });
                    });
                }
            }

            // Connect toggle buttons to side menu checkboxes
            syncToggleButtons('toggleControlsBtn', 'toggleControlsBtn2', sideMenuShowControls);
            syncToggleButtons('toggleEditorBtn', 'toggleEditorBtn2', sideMenuShowEditor);
        })();

    </script>

    <!-- Navigation Tab Bar Logic -->
    <script>
    (function() {
        'use strict';

        const navTabs = document.querySelectorAll('.nav-tab');
        const mainContainer = document.querySelector('main.container');
        const liveSessionSubmenu = document.getElementById('liveSessionSubmenu');
        const toolsCombinedView = document.getElementById('toolsCombinedView');
        let currentTab = 'scanner';
        let toolsInitialized = false;

        // Saved references for DOM move approach
        let metronomeModalBody = null;
        let padsModalBody = null;
        let metronomeSavedChildren = null;
        let padsSavedChildren = null;

        navTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                if (targetTab === currentTab && targetTab === 'livesession') {
                    liveSessionSubmenu.style.display =
                        liveSessionSubmenu.style.display === 'none' ? 'flex' : 'none';
                    return;
                }
                switchTab(targetTab);
            });
        });

        function switchTab(targetTab) {
            // Move tools content back to modals before switching away
            if (currentTab === 'tools' && targetTab !== 'tools') {
                moveToolsBackToModals();
            }

            navTabs.forEach(t => t.classList.remove('active'));
            const activeTab = document.querySelector('.nav-tab[data-tab="' + targetTab + '"]');
            if (activeTab) activeTab.classList.add('active');

            liveSessionSubmenu.style.display = 'none';
            toolsCombinedView.style.display = 'none';
            mainContainer.style.display = '';

            switch (targetTab) {
                case 'scanner':
                    break;

                case 'songbook':
                    openSongBook();
                    break;

                case 'livesession':
                    liveSessionSubmenu.style.display = 'flex';
                    break;

                case 'tools':
                    mainContainer.style.display = 'none';
                    toolsCombinedView.style.display = 'block';
                    if (!toolsInitialized) {
                        initToolsPanelHeaders();
                        toolsInitialized = true;
                    }
                    moveToolsFromModals();
                    break;
            }

            currentTab = targetTab;
        }

        // --- Song Book ---
        function openSongBook() {
            const loadSongBtn = document.getElementById('loadSongButton');
            if (loadSongBtn) {
                loadSongBtn.click();
            } else {
                const modal = document.getElementById('loadSongModal');
                if (modal) modal.style.display = 'flex';
            }

            const modal = document.getElementById('loadSongModal');
            if (modal) {
                const observer = new MutationObserver(function(mutations) {
                    for (const m of mutations) {
                        if (m.attributeName === 'style' && modal.style.display === 'none') {
                            if (currentTab === 'songbook') {
                                switchTab('scanner');
                            }
                            observer.disconnect();
                            return;
                        }
                    }
                });
                observer.observe(modal, { attributes: true, attributeFilter: ['style'] });
            }
        }

        // --- Live Session sub-menu ---
        document.getElementById('navCreateSession').addEventListener('click', function() {
            if (window.sessionUI) sessionUI.showCreateSessionModal();
        });
        document.getElementById('navJoinSession').addEventListener('click', function() {
            if (window.sessionUI) sessionUI.showJoinSessionModal();
        });
        document.getElementById('navMySessions').addEventListener('click', function() {
            if (window.sessionUI) sessionUI.showMySessionsModal();
        });

        // --- Tools: DOM move approach ---
        function initToolsPanelHeaders() {
            var metroPanel = document.getElementById('toolsMetronomePanel');
            var padsPanel = document.getElementById('toolsPadsPanel');
            if (metroPanel) {
                var h = document.createElement('h3');
                h.className = 'tools-panel-header';
                h.setAttribute('data-i18n', 'nav.tools.metronome');
                h.textContent = 'Metronome';
                metroPanel.appendChild(h);
            }
            if (padsPanel) {
                var h = document.createElement('h3');
                h.className = 'tools-panel-header';
                h.setAttribute('data-i18n', 'nav.tools.pads');
                h.textContent = 'Worship Pads';
                padsPanel.appendChild(h);
            }
        }

        function moveToolsFromModals() {
            var metroPanel = document.getElementById('toolsMetronomePanel');
            var padsPanel = document.getElementById('toolsPadsPanel');

            // Move metronome content
            if (!metronomeModalBody) {
                var metroModal = document.getElementById('metronomeModal');
                if (metroModal) metronomeModalBody = metroModal.querySelector('.modal-body');
            }
            if (metronomeModalBody && metroPanel) {
                metronomeSavedChildren = Array.from(metronomeModalBody.children);
                metronomeSavedChildren.forEach(function(child) {
                    metroPanel.appendChild(child);
                });

                // Add Play/Stop button for metronome
                if (!document.getElementById('toolsMetronomePlayBtn')) {
                    var playBtn = document.createElement('button');
                    playBtn.id = 'toolsMetronomePlayBtn';
                    playBtn.textContent = 'Play';
                    playBtn.style.cssText = 'width: 100%; padding: 12px; margin-top: 12px; background: var(--text); color: var(--bg); border: 1px solid var(--border); cursor: pointer; font-size: 14px; font-weight: 600; font-family: inherit;';
                    playBtn.addEventListener('click', function() {
                        if (window.metronome) {
                            metronome.toggle();
                            playBtn.textContent = metronome.isPlaying ? 'Stop' : 'Play';
                        }
                    });
                    metroPanel.appendChild(playBtn);
                }
            }

            // Move pads content
            if (!padsModalBody) {
                var padsModal = document.getElementById('padsModal');
                if (padsModal) padsModalBody = padsModal.querySelector('.modal-body');
            }
            if (padsModalBody && padsPanel) {
                padsSavedChildren = Array.from(padsModalBody.children);
                padsSavedChildren.forEach(function(child) {
                    padsPanel.appendChild(child);
                });

                // Load pad sounds if needed
                if (window.padPlayer && Object.keys(padPlayer.buffers).length === 0) {
                    padPlayer.loadSounds();
                }

                // Add Stop All button for pads
                if (!document.getElementById('toolsPadsStopBtn')) {
                    var stopBtn = document.createElement('button');
                    stopBtn.id = 'toolsPadsStopBtn';
                    stopBtn.textContent = 'Stop All';
                    stopBtn.style.cssText = 'width: 100%; padding: 12px; margin-top: 12px; background: var(--text); color: var(--bg); border: 1px solid var(--border); cursor: pointer; font-size: 14px; font-weight: 600; font-family: inherit;';
                    stopBtn.addEventListener('click', function() {
                        if (window.padPlayer) padPlayer.stopAll();
                    });
                    padsPanel.appendChild(stopBtn);
                }
            }

            // Update translations for moved content
            if (window.localization) localization.updateUI();
        }

        function moveToolsBackToModals() {
            if (metronomeSavedChildren && metronomeModalBody) {
                metronomeSavedChildren.forEach(function(child) {
                    metronomeModalBody.appendChild(child);
                });
                metronomeSavedChildren = null;
            }
            if (padsSavedChildren && padsModalBody) {
                padsSavedChildren.forEach(function(child) {
                    padsModalBody.appendChild(child);
                });
                padsSavedChildren = null;
            }
        }

        window.navBar = { switchTab: switchTab };
    })();
    </script>

    <!-- PWA Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW registered:', reg.scope))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>

</body>

</html>