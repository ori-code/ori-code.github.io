<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChordsApp Claude | The Faith Sound</title>

    <link rel="icon" type="image/png" href="../images/FaithSoundLogo.png">
    <link rel="apple-touch-icon" href="../images/FaithSoundLogo.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css?v=8">
    <script src="https://www.paypal.com/sdk/js?client-id=AUjr_VTe9_mnojYbrv2wEhvIlYN3nXES7HG2hIfHpNhZchdcNGCh6WeHJtxwXkDBqS09gb2RjX-HAYEK&vault=true&intent=subscription&currency=USD"></script>

    <!-- PDF.js for PDF preview -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- html2canvas for Save as Image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- QRCode.js for session QR codes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <header class="app-header">
        <div class="header-container">
            <div style="display: flex; align-items: center; gap: 12px;">
                <button id="sideMenuToggle" class="hamburger-btn" title="Open Menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <a href="../index.html" class="nav-logo">THE FAITH <span>SOUND</span></a>
            </div>
            <div class="header-actions">
                <!-- Usage Indicator -->
                <div id="headerUsageIndicator" style="display: none; margin-right: 12px; padding: 6px 12px; background: rgba(59, 130, 246, 0.15); border-radius: 6px; font-size: 13px; color: #3b82f6; white-space: nowrap;">
                    <span id="headerUsageText">Loading...</span>
                </div>

                <!-- Upgrade Button (for free/basic users) -->
                <button class="ghost-button" id="upgradeButton" type="button" style="display: none; background: linear-gradient(135deg, var(--primary) 0%, #ff8fab 100%); color: white; font-weight: 600; border: none;">
                    ‚≠ê Upgrade
                </button>

                <div style="position: relative;">
                    <button class="ghost-button" id="signInButton" type="button">Sign In</button>
                    <div id="profileMenu" style="display: none; position: absolute; top: 45px; right: 0; background: var(--surface); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px; min-width: 150px; z-index: 1000;">
                        <button id="mySubscriptionBtn" style="width: 100%; padding: 8px 12px; background: transparent; color: var(--text); border: none; text-align: left; cursor: pointer; border-radius: 4px; transition: background 0.2s;">My Subscription</button>
                        <button id="signOutBtn" style="width: 100%; padding: 8px 12px; background: transparent; color: var(--text); border: none; text-align: left; cursor: pointer; border-radius: 4px; transition: background 0.2s;">Sign Out</button>
                    </div>
                </div>
                <button class="ghost-button" id="themeToggle" type="button" title="Toggle theme">
                    <svg id="themeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <!-- Moon icon (for dark mode) -->
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="hero" id="top">
            <div class="hero-text">
                <h1>Turn any chord sheet into a clean, printable chart.</h1>
                <p>Upload a handwritten sheet or photo, let AI extract the music, refine the result, transpose to any key, then print with confidence.</p>
            </div>
        </section>

        <section class="workflow" id="workflow">
            <h2>Three simple steps</h2>
            <div class="workflow-grid">
                <article class="step-card">
                    <span class="step-number">1</span>
                    <h3>Upload your chart</h3>
                    <p>Accepts images (JPG, PNG, HEIC) and PDFs. High contrast photos deliver the best recognition results.</p>
                    <input id="chartFileInput" class="sr-only" type="file" accept="image/*,.pdf">
                    <label class="primary-action" for="chartFileInput" style="width: 100%;">Upload</label>
                    <div class="preview-panel" id="uploadPreview">
                        <img id="previewImage" alt="Uploaded chart preview">
                        <p class="preview-placeholder">No file selected yet. Supported: JPG, PNG, HEIC, PDF.</p>
                    </div>
                </article>
                <article class="step-card">
                    <span class="step-number">2</span>
                    <h3>AI transcription ready!</h3>
                    <p>Edit visually in the bottom Editor.</p>
                    <label style="display: block; margin-top: 12px; font-size: 0.9rem; color: var(--text); cursor: pointer; user-select: none;">
                        <input type="checkbox" id="autoAnalyzeCheckbox" checked style="margin-right: 8px; cursor: pointer;">
                        ‚ö° Auto-analyze uploads <span style="color: var(--text-muted); font-size: 0.8rem;">(recommended)</span>
                    </label>
                    <button id="analyzeButton" class="primary-action" disabled>Analyze</button>
                    <label id="intenseScanOption" style="display: none; margin-top: 8px; font-size: 0.85rem; color: var(--text-muted); cursor: pointer; user-select: none;">
                        <input type="checkbox" id="intenseScanCheckbox" style="margin-right: 6px; cursor: pointer;">
                        <span style="color: #f59e0b;">‚ö°</span> Intense Scan <span style="color: var(--text-muted); font-size: 0.75rem;">(Pro - better for hard scans)</span>
                    </label>
                    <div class="status-panel" id="analysisStatus" role="status" aria-live="polite">
                        <span class="status-dot idle"></span>
                        <span class="status-text">Waiting for an upload‚Ä¶</span>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill"></div>
                        </div>
                    </div>
                    <small class="status-hint">Analysis typically takes 15-60 seconds. Supports all languages texts. If the result is not good, try to run analyze again. AI processing costs us money - please consider <a href="#support" style="color: var(--primary); text-decoration: underline;">donating</a> to keep this free tool running.</small>
                </article>
                <article class="step-card">
                    <span class="step-number">3</span>
                    <h3>Refine, transpose &amp; print</h3>
                    <p>Edit chords visually in the editor. The SongBook format (under the editor) updates automatically. AI original stays on the right for reference.</p>
                    <div class="ai-reference-preview" id="aiReferencePreview" style="flex: 1;">
                        <h4>AI Original (reference)</h4>
                        <div class="reference-content" id="aiReferenceContent">
                            <p class="preview-placeholder">AI transcription will appear here after analysis.</p>
                        </div>
                    </div>
                </article>
            </div>
        </section>

        <section class="preview-section" id="previewSection">
            <div class="preview-header">
                <div class="preview-header-row">
                    <h2 id="previewHeaderTitle">Print Preview</h2>
                    <button id="toggleControlsBtn2" class="header-btn display-toggle active">üéõÔ∏è Controls</button>
                    <button id="toggleEditorBtn2" class="header-btn display-toggle">‚úèÔ∏è Editor</button>
                    <div class="header-spacer"></div>
                    <button class="header-btn" id="headerSaveSong">üíæ Save</button>
                    <button class="header-btn" id="headerLoadSong">üìÇ Load</button>
                    <button class="header-btn" id="headerSaveAsImage">üì∑ Image</button>
                    <button class="header-btn" id="printButton">üñ®Ô∏è Print</button>
                    <button class="header-btn" id="headerAutoFit">üìê Auto Fit</button>
                    <button class="header-btn" id="headerPadsBtn" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(59, 130, 246, 0.2) 100%); border-color: rgba(139, 92, 246, 0.4);">üéπ Pads</button>
                    <button class="header-btn" id="headerLivePreview" style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; border: none;">üì∫ Live Preview</button>
                </div>
            </div>
        </section>

        <!-- Side Menu Overlay -->
        <div id="sideMenuOverlay" class="side-menu-overlay"></div>

        <!-- Side Menu Panel -->
        <aside id="sideMenuPanel" class="side-menu-panel">
            <div class="side-menu-header">
                <h3>Controls</h3>
                <button id="sideMenuClose" class="side-menu-close">&times;</button>
            </div>
            <div class="side-menu-content">
                <!-- Quick Actions -->
                <div class="side-menu-section">
                    <h4>Quick Actions</h4>
                    <div class="side-menu-buttons">
                        <button class="side-menu-btn primary" id="sideMenuPrint">üñ®Ô∏è Print Chart</button>
                        <button class="side-menu-btn orange" id="saveAsImageButton">üì∑ Save as Image</button>
                        <button class="side-menu-btn purple" id="livePreviewToggle">üì∫ Live Preview</button>
                        <button class="side-menu-btn" id="saveLayoutButton">üíæ Save Layout</button>
                    </div>
                </div>

                <!-- Display Mode -->
                <div class="side-menu-section">
                    <h4>Display</h4>
                    <div class="side-menu-row">
                        <label>Mode:</label>
                        <select id="sideMenuNashvilleMode" class="side-menu-select">
                            <option value="chords" selected>Chords</option>
                            <option value="both">Nashville + Chords</option>
                            <option value="numbers">Nashville Only</option>
                            <option value="lyrics">Lyrics Only</option>
                        </select>
                    </div>
                    <div class="side-menu-row">
                        <label>Font Size:</label>
                        <input type="range" id="sideMenuFontSize" min="8" max="28" value="11" step="0.5">
                        <span id="sideMenuFontSizeVal">11pt</span>
                    </div>
                    <div class="side-menu-row">
                        <label>Line Spacing:</label>
                        <input type="range" id="sideMenuLineHeight" min="1.0" max="2.0" value="1.2" step="0.1">
                        <span id="sideMenuLineHeightVal">1.2</span>
                    </div>
                    <div class="side-menu-row">
                        <label>Char Spacing:</label>
                        <input type="range" id="sideMenuCharSpacing" min="0" max="8" value="0" step="0.5">
                        <span id="sideMenuCharSpacingVal">0px</span>
                    </div>
                    <div class="side-menu-row">
                        <label class="side-menu-checkbox">
                            <input type="checkbox" id="sideMenuBadges" checked>
                            <span>Show Badges</span>
                        </label>
                    </div>
                    <div class="side-menu-row">
                        <label class="side-menu-checkbox">
                            <input type="checkbox" id="sideMenuShowControls" checked>
                            <span>Show Main Controls</span>
                        </label>
                    </div>
                    <div class="side-menu-row">
                        <label class="side-menu-checkbox">
                            <input type="checkbox" id="sideMenuShowEditor">
                            <span>Show Edit Workspace</span>
                        </label>
                    </div>
                    <div class="side-menu-row">
                        <label class="side-menu-checkbox">
                            <input type="checkbox" id="sideMenuShowSongbook">
                            <span>Show SongBook Format</span>
                        </label>
                    </div>
                </div>

                <!-- Layout -->
                <div class="side-menu-section">
                    <h4>Layout</h4>
                    <div class="side-menu-row">
                        <label>Columns:</label>
                        <select id="sideMenuColumns" class="side-menu-select">
                            <option value="1">1 Column</option>
                            <option value="2" selected>2 Columns</option>
                            <option value="3">3 Columns</option>
                            <option value="4">4 Columns</option>
                        </select>
                    </div>
                    <div class="side-menu-row">
                        <label>Pages:</label>
                        <select id="sideMenuPages" class="side-menu-select">
                            <option value="1" selected>1 Page</option>
                            <option value="2">2 Pages</option>
                            <option value="3">3 Pages</option>
                            <option value="4">4 Pages</option>
                        </select>
                    </div>
                    <button class="side-menu-btn purple full-width" id="sideMenuAutoFit">‚ú® Auto-fit to 1 Page</button>
                </div>

                <!-- Transpose -->
                <div class="side-menu-section">
                    <h4>Transpose</h4>
                    <div class="side-menu-row">
                        <label>Key:</label>
                        <select id="sideMenuKey" class="side-menu-select">
                            <optgroup label="Major Keys">
                                <option value="C Major">C Major</option>
                                <option value="D Major">D Major</option>
                                <option value="E Major">E Major</option>
                                <option value="F Major">F Major</option>
                                <option value="G Major">G Major</option>
                                <option value="A Major">A Major</option>
                                <option value="B Major">B Major</option>
                            </optgroup>
                            <optgroup label="Minor Keys">
                                <option value="A Minor">A Minor</option>
                                <option value="B Minor">B Minor</option>
                                <option value="C Minor">C Minor</option>
                                <option value="D Minor">D Minor</option>
                                <option value="E Minor">E Minor</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="side-menu-key-grid">
                        <button class="key-btn" data-key="C">C</button>
                        <button class="key-btn" data-key="D">D</button>
                        <button class="key-btn" data-key="E">E</button>
                        <button class="key-btn" data-key="F">F</button>
                        <button class="key-btn" data-key="G">G</button>
                        <button class="key-btn" data-key="A">A</button>
                        <button class="key-btn" data-key="B">B</button>
                    </div>
                    <div class="side-menu-transpose-btns">
                        <button class="side-menu-btn" id="sideMenuTransposeDown">‚àí1</button>
                        <span id="sideMenuTransposeVal">0</span>
                        <button class="side-menu-btn" id="sideMenuTransposeUp">+1</button>
                        <button class="side-menu-btn" id="sideMenuTransposeReset">Reset</button>
                    </div>
                </div>

                <!-- Song Info -->
                <div class="side-menu-section">
                    <h4>Song Info</h4>
                    <div class="side-menu-row">
                        <label>BPM:</label>
                        <input type="number" id="sideMenuBPM" value="120" min="40" max="240" class="side-menu-input">
                    </div>
                    <div class="side-menu-row">
                        <label>Time:</label>
                        <select id="sideMenuTime" class="side-menu-select">
                            <option value="4/4" selected>4/4</option>
                            <option value="3/4">3/4</option>
                            <option value="6/8">6/8</option>
                            <option value="2/4">2/4</option>
                        </select>
                    </div>
                </div>

                <!-- Library -->
                <div class="side-menu-section">
                    <h4>Library</h4>
                    <div class="side-menu-buttons">
                        <button class="side-menu-btn" id="sideMenuSave">üíæ Save Song</button>
                        <button class="side-menu-btn" id="sideMenuLoad">üìÇ Load Song</button>
                        <button class="side-menu-btn" id="sideMenuBulkImport">üì• Bulk Import</button>
                        <button class="side-menu-btn" id="sideMenuUpdate">üîÑ Update Song</button>
                    </div>
                </div>

                <!-- Live Sessions -->
                <div class="side-menu-section">
                    <h4>Live Sessions</h4>
                    <div class="side-menu-buttons">
                        <button class="side-menu-btn green" id="sideMenuCreateSession">üì° Create Session</button>
                        <button class="side-menu-btn blue" id="sideMenuJoinSession">üìª Join Session</button>
                        <button class="side-menu-btn" id="sideMenuMySessions">üìã My Sessions</button>
                        <button class="side-menu-btn purple" id="sideMenuGoLive">üì∫ Go Live</button>
                    </div>
                </div>

                <!-- Pads Mini Player -->
                <div class="side-menu-section">
                    <h4>Worship Pads</h4>
                    <!-- Mini 12-key grid -->
                    <div id="miniPadsGrid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; margin-bottom: 10px;">
                        <button class="mini-pad-key" data-key="C">C</button>
                        <button class="mini-pad-key" data-key="Csharp">C#</button>
                        <button class="mini-pad-key" data-key="D">D</button>
                        <button class="mini-pad-key" data-key="Dsharp">D#</button>
                        <button class="mini-pad-key" data-key="E">E</button>
                        <button class="mini-pad-key" data-key="F">F</button>
                        <button class="mini-pad-key" data-key="Fsharp">F#</button>
                        <button class="mini-pad-key" data-key="G">G</button>
                        <button class="mini-pad-key" data-key="Gsharp">G#</button>
                        <button class="mini-pad-key" data-key="A">A</button>
                        <button class="mini-pad-key" data-key="Asharp">A#</button>
                        <button class="mini-pad-key" data-key="B">B</button>
                    </div>
                    <!-- Volume slider -->
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <span style="font-size: 12px; opacity: 0.7;">üîä</span>
                        <input type="range" id="miniPadVolume" min="0" max="100" value="70" style="flex: 1; height: 4px; accent-color: #8b5cf6;">
                        <span id="miniPadNowPlaying" style="font-size: 11px; color: #10b981; font-weight: 600; min-width: 24px;"></span>
                    </div>
                    <!-- Full controls button -->
                    <div class="side-menu-buttons">
                        <button class="side-menu-btn" id="sideMenuOpenPads" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(59, 130, 246, 0.2) 100%); border-color: rgba(139, 92, 246, 0.4); font-size: 12px;">
                            üéõÔ∏è Full Controls
                        </button>
                    </div>
                </div>

                <!-- Active Session Info (shown when broadcasting) -->
                <div id="sideMenuActiveSession" class="side-menu-section" style="display: none; border-top: 2px solid #10b981;">
                    <h4 style="color: #10b981;">Active Session</h4>
                    <div style="text-align: center; padding: 12px 0;">
                        <div id="sideMenuSessionCode" style="font-family: monospace; font-size: 28px; font-weight: bold; color: #10b981; margin-bottom: 12px; letter-spacing: 2px;"></div>
                        <div id="sideMenuQRCode" style="display: flex; justify-content: center; margin-bottom: 12px; background: white; padding: 8px; border-radius: 8px; width: fit-content; margin-left: auto; margin-right: auto;"></div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Scan QR or share link:</div>
                        <input type="text" id="sideMenuSessionLink" readonly style="width: 100%; padding: 8px; font-size: 11px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: var(--text); text-align: center; cursor: pointer;">
                        <button id="sideMenuCopyLink" class="side-menu-btn green" style="margin-top: 8px; width: 100%;">üìã Copy Link</button>
                    </div>
                </div>

                <!-- User Profile Section (shown when logged in) -->
                <div id="sideMenuUserProfile" class="side-menu-section" style="display: none; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto; padding-top: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary) 0%, #ff8fab 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; font-weight: 600;">
                            <span id="sideMenuUserAvatar">?</span>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div id="sideMenuUserName" style="font-weight: 600; font-size: 14px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">User</div>
                            <div id="sideMenuTierBadge" style="display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-top: 4px; background: rgba(59, 130, 246, 0.15); color: #3b82f6;">Free</div>
                        </div>
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                        <button id="sideMenuMySubscription" class="side-menu-btn" style="flex: 1; font-size: 12px;">My Subscription</button>
                        <button id="sideMenuSignOut" class="side-menu-btn" style="flex: 1; font-size: 12px; background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: #ef4444;">Sign Out</button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Editor actions -->
        <section class="editor-actions-section">
            <div class="editor-actions" style="margin: 20px 0; padding: 16px 20px; background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; display: flex; flex-wrap: wrap; gap: 12px; align-items: stretch; width: 100%; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                <div style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(139, 92, 246, 0.08); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 8px; flex: 1 1 auto; min-width: 200px;">
                    <span style="font-size: 0.85rem; opacity: 0.8;">üî¢</span>
                    <select id="nashvilleMode" style="padding: 5px 10px; background: rgba(255, 255, 255, 0.05); color: var(--text); border: 1px solid rgba(139, 92, 246, 0.25); border-radius: 6px; font-size: 0.875rem; cursor: pointer; font-weight: 500;">
                        <option value="chords" selected>Chords</option>
                        <option value="both">Nashville + Chords</option>
                        <option value="numbers">Nashville Only</option>
                        <option value="lyrics">Lyrics Only</option>
                    </select>
                </div>
                <div id="keyDetection" style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(255, 59, 92, 0.08); border: 1px solid rgba(255, 59, 92, 0.2); border-radius: 8px; flex: 1 1 auto; min-width: 200px;">
                    <span style="font-size: 0.85rem; opacity: 0.8;">üéπ</span>
                    <select id="keySelector" style="padding: 5px 10px; background: rgba(255, 255, 255, 0.05); color: var(--primary); border: 1px solid rgba(255, 59, 92, 0.25); border-radius: 6px; font-size: 0.875rem; font-weight: 500; cursor: pointer;">
                        <optgroup label="Major Keys">
                            <option value="C Major" selected>C Major</option>
                            <option value="C# Major">C# Major</option>
                            <option value="D Major">D Major</option>
                            <option value="D# Major">D# Major</option>
                            <option value="E Major">E Major</option>
                            <option value="F Major">F Major</option>
                            <option value="F# Major">F# Major</option>
                            <option value="G Major">G Major</option>
                            <option value="G# Major">G# Major</option>
                            <option value="A Major">A Major</option>
                            <option value="A# Major">A# Major</option>
                            <option value="B Major">B Major</option>
                        </optgroup>
                        <optgroup label="Minor Keys">
                            <option value="C Minor">C Minor</option>
                            <option value="C# Minor">C# Minor</option>
                            <option value="D Minor">D Minor</option>
                            <option value="D# Minor">D# Minor</option>
                            <option value="E Minor">E Minor</option>
                            <option value="F Minor">F Minor</option>
                            <option value="F# Minor">F# Minor</option>
                            <option value="G Minor">G Minor</option>
                            <option value="G# Minor">G# Minor</option>
                            <option value="A Minor">A Minor</option>
                            <option value="A# Minor">A# Minor</option>
                            <option value="B Minor">B Minor</option>
                        </optgroup>
                    </select>
                    <span id="detectedKey" style="display: none;"></span>
                </div>
                <div style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(249, 115, 22, 0.08); border: 1px solid rgba(249, 115, 22, 0.2); border-radius: 8px; flex: 1 1 auto; min-width: 120px;">
                    <span style="font-size: 0.85rem; opacity: 0.8;">üéµ</span>
                    <input type="number" id="bpmInput" value="120" min="40" max="240" style="width: 70px; padding: 5px 8px; background: rgba(255, 255, 255, 0.05); color: var(--text); border: 1px solid rgba(249, 115, 22, 0.25); border-radius: 6px; font-size: 0.875rem; text-align: center; font-weight: 500;" required>
                </div>
                <div style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(34, 211, 238, 0.08); border: 1px solid rgba(34, 211, 238, 0.2); border-radius: 8px; flex: 1 1 auto; min-width: 120px;">
                    <span style="font-size: 0.85rem; opacity: 0.8;">‚è±Ô∏è</span>
                    <select id="timeSignature" style="padding: 5px 10px; background: rgba(255, 255, 255, 0.05); color: var(--text); border: 1px solid rgba(34, 211, 238, 0.25); border-radius: 6px; font-size: 0.875rem; cursor: pointer; font-weight: 500;">
                        <option value="4/4" selected>4/4</option>
                        <option value="3/4">3/4</option>
                        <option value="6/8">6/8</option>
                        <option value="2/4">2/4</option>
                        <option value="5/4">5/4</option>
                        <option value="7/8">7/8</option>
                        <option value="12/8">12/8</option>
                    </select>
                </div>
                <label style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(168, 85, 247, 0.08); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 8px; cursor: pointer; font-size: 0.8rem; color: var(--text); user-select: none;">
                    <input type="checkbox" id="showBadges" checked style="accent-color: #a855f7; cursor: pointer;">
                    <span>Badges</span>
                </label>
                <button class="ghost-button" id="saveSongButton" style="flex: 1 1 auto; min-width: 120px; padding: 6px 14px; font-size: 0.875rem;">üíæ Save</button>
                <button class="ghost-button" id="loadSongButton" style="flex: 1 1 auto; min-width: 120px; padding: 6px 14px; font-size: 0.875rem;">üìÇ Load</button>
                <button class="ghost-button" id="bulkImportButton" style="flex: 1 1 auto; min-width: 120px; padding: 6px 14px; font-size: 0.875rem;">üì• Bulk Import</button>
                <input type="file" id="bulkImportInput" multiple accept=".txt,.cho,.chordpro,.chopro" style="display: none;">
                <button class="ghost-button" id="updateSongButton" style="flex: 1 1 auto; min-width: 120px; padding: 6px 14px; font-size: 0.875rem;">üîÑ Update</button>
                <button class="ghost-button" id="copyToClipboard" style="display: none;">Copy text</button>
            </div>
        </section>

        <!-- Live Session Controls -->
        <section class="session-section">
            <div class="session-controls" style="margin: 20px 0; padding: 16px; background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 12px;">
                <!-- Session Status Indicator (shown when in session) -->
                <div id="sessionStatusIndicator" style="display: none; margin-bottom: 12px;"></div>

                <!-- Now Playing Banner (shown when in session) -->
                <div id="liveSessionBanner" style="display: none; margin-bottom: 12px; padding: 12px 16px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(59, 130, 246, 0.15) 100%); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; align-items: center; justify-content: space-between; gap: 12px;">
                    <span id="nowPlayingLabel" style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                        <span style="animation: pulse 2s infinite;">üéµ</span>
                        <span>Now Playing: <strong id="nowPlayingSong" style="color: var(--primary);">-</strong></span>
                    </span>
                    <button id="returnToLiveBtn" onclick="window.returnToLeaderSong()" style="display: none; padding: 6px 12px; background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                        ‚Ü© Return to Live
                    </button>
                </div>

                <!-- Session Action Buttons (shown when not in session) -->
                <div id="sessionActionButtons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    <button class="ghost-button" id="createSessionBtn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; display: none;">
                        üì° Create Live Session (PRO)
                    </button>
                    <button class="ghost-button" id="joinSessionBtn" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; display: none;">
                        üìª Join Session (Basic)
                    </button>
                    <button class="ghost-button" id="mySessionsBtn" style="display: none;">
                        üìã My Sessions
                    </button>
                    <button class="ghost-button" id="goLiveButton" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; border: none; display: none;">
                        üì∫ Go Live
                    </button>
                </div>
            </div>
        </section>

        <section class="preview-section-content">
            <!-- Advanced Layout Controls (Collapsible) -->
            <div id="advancedControls" class="preview-controls-row" style="display: none; flex-direction: column; gap: 12px; margin-bottom: 20px; overflow: hidden; transition: all 0.3s ease;">
                <div style="background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 8px; padding: 16px;">
                    <h4 style="margin: 0 0 12px 0; color: var(--primary); font-size: 0.9rem; font-weight: 600;">Layout Customization</h4>
                    <!-- Row 1: Sliders + Layout + Pages (all in same line) -->
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 12px;">
                        <label class="font-size-control" style="flex: 1 1 120px; min-width: 120px;">
                            Font Size: <span id="fontSizeValue">11</span>pt
                            <input type="range" id="fontSizeSlider" min="8" max="28" value="11" step="0.5">
                        </label>
                        <label class="line-height-control" style="flex: 1 1 130px; min-width: 130px;">
                            Line Spacing: <span id="lineHeightValue">1.2</span>
                            <input type="range" id="lineHeightSlider" min="1.0" max="2.0" value="1.2" step="0.1">
                        </label>
                        <label class="char-spacing-control" style="flex: 1 1 130px; min-width: 130px;">
                            Char Spacing: <span id="charSpacingValue">0</span>px
                            <input type="range" id="charSpacingSlider" min="0" max="8" value="0" step="0.5">
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; white-space: nowrap; flex: 0 0 auto;">
                            <span style="font-size: 0.9rem; color: var(--text-muted); font-weight: 500;">Layout:</span>
                            <select id="columnCount" class="layout-select ghost-button" style="min-width: 105px;">
                                <option value="1">1 Column</option>
                                <option value="2" selected>2 Columns</option>
                                <option value="3">3 Columns</option>
                                <option value="4">4 Columns</option>
                            </select>
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; white-space: nowrap; flex: 0 0 auto;">
                            <span style="font-size: 0.9rem; color: var(--text-muted); font-weight: 500;">Pages:</span>
                            <select id="pageCount" class="layout-select ghost-button" style="min-width: 88px;">
                                <option value="1" selected>1 Page</option>
                                <option value="2">2 Pages</option>
                                <option value="3">3 Pages</option>
                                <option value="4">4 Pages</option>
                            </select>
                        </label>
                    </div>
                    <!-- Display Toggle Buttons -->
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                        <button id="toggleControlsBtn" class="ghost-button display-toggle active" style="flex: 1; min-width: 120px; padding: 8px 12px; font-size: 12px; font-weight: 500;">
                            <span style="margin-right: 4px;">üéõÔ∏è</span> Main Controls
                        </button>
                        <button id="toggleEditorBtn" class="ghost-button display-toggle" style="flex: 1; min-width: 120px; padding: 8px 12px; font-size: 12px; font-weight: 500;">
                            <span style="margin-right: 4px;">‚úèÔ∏è</span> Edit Workspace
                        </button>
                    </div>
                    <button class="ghost-button" id="autoOptimizeButton" style="width: 100%; background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; border: none; padding: 10px; font-weight: 600;">‚ú® Auto-fit to 1 Page</button>
                </div>

                <!-- Transpose Controls -->
                <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; padding: 16px;">
                    <h4 style="margin: 0 0 12px 0; color: #3b82f6; font-size: 0.9rem; font-weight: 600;">Transpose</h4>

                    <!-- Quick Key Transpose -->
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 0.85rem; color: var(--text-muted); display: block; margin-bottom: 6px;">Quick Transpose to Key:</label>
                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                            <button class="ghost-button quick-key-transpose" data-target-key="C" style="flex: 1; min-width: 50px; padding: 8px; font-weight: 600; background: rgba(59, 130, 246, 0.1);">C</button>
                            <button class="ghost-button quick-key-transpose" data-target-key="D" style="flex: 1; min-width: 50px; padding: 8px; font-weight: 600; background: rgba(59, 130, 246, 0.1);">D</button>
                            <button class="ghost-button quick-key-transpose" data-target-key="E" style="flex: 1; min-width: 50px; padding: 8px; font-weight: 600; background: rgba(59, 130, 246, 0.1);">E</button>
                            <button class="ghost-button quick-key-transpose" data-target-key="F" style="flex: 1; min-width: 50px; padding: 8px; font-weight: 600; background: rgba(59, 130, 246, 0.1);">F</button>
                            <button class="ghost-button quick-key-transpose" data-target-key="G" style="flex: 1; min-width: 50px; padding: 8px; font-weight: 600; background: rgba(59, 130, 246, 0.1);">G</button>
                            <button class="ghost-button quick-key-transpose" data-target-key="A" style="flex: 1; min-width: 50px; padding: 8px; font-weight: 600; background: rgba(59, 130, 246, 0.1);">A</button>
                            <button class="ghost-button quick-key-transpose" data-target-key="B" style="flex: 1; min-width: 50px; padding: 8px; font-weight: 600; background: rgba(59, 130, 246, 0.1);">B</button>
                        </div>
                    </div>

                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                        <div style="display: flex; gap: 8px; flex: 1 1 100px; min-width: 100px;">
                            <button class="ghost-button" data-shift="-1" style="flex: 1; padding: 10px; min-width: 44px;">‚Äì1</button>
                            <button class="ghost-button" data-shift="1" style="flex: 1; padding: 10px; min-width: 44px;">+1</button>
                        </div>
                        <label class="transpose-label" style="display: flex; align-items: center; gap: 6px; white-space: nowrap; justify-content: center; flex: 1 1 100px; min-width: 100px;">
                            <span style="font-size: 0.9rem; color: var(--text-muted); font-weight: 500;">Steps</span>
                            <input type="number" id="transposeStepInput" value="0" min="-11" max="11" style="width: 50px; padding: 8px;">
                        </label>
                        <div style="display: flex; gap: 8px; flex: 1 1 150px; min-width: 150px;">
                            <button class="ghost-button" id="applyTranspose" style="flex: 1; padding: 10px 12px;">Apply</button>
                            <button class="ghost-button" id="resetTranspose" style="flex: 1; padding: 10px 12px;">Reset</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Workspace (right before preview) -->
            <section id="editor" class="editor" style="display: none;">
                <div class="editor-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0;">Edit workspace</h2>
                    <button id="toggleChordWorkspace" class="ghost-button" style="padding: 8px 16px; font-size: 0.9rem; background: rgba(139, 92, 246, 0.1); color: var(--primary); border: 1px solid rgba(139, 92, 246, 0.3);">
                        ‚ñº Expand
                    </button>
                </div>
                <div id="chordWorkspaceContent" style="display: none;">
                    <div id="keyAnalysis" style="margin: 20px 0; padding: 16px; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; display: none;">
                        <h4 style="margin: 0 0 12px 0; color: var(--primary); font-size: 0.95rem; font-weight: 600;">üéµ Key Analysis</h4>
                        <p id="keyAnalysisText" style="margin: 0; color: var(--text-muted); font-size: 0.9rem; line-height: 1.6;"></p>
                    </div>
                    <div class="editor-panel">
                        <header class="visual-editor-header">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 style="margin: 0;">Visual Editor (edit here)</h3>
                            </div>
                            <div class="mini-preview" id="miniWorkspacePreview">
                                <img id="miniWorkspacePreviewImage" alt="Uploaded chart preview">
                                <span class="mini-preview-placeholder">Preview appears here after upload.</span>
                            </div>
                            <div class="reanalyze-block">
                                <label for="reanalyzeFeedback">Need a better pass? Tell the AI what to fix.</label>
                                <textarea id="reanalyzeFeedback" placeholder="Example: Verse 1 chords drift left; please align with lyrics and double-check key."></textarea>
                                <button class="ghost-button" id="reanalyzeButton" disabled>Re-analyze with feedback</button>
                            </div>
                            <small class="visual-editor-subtitle">Chords above lyrics - adjust spacing freely</small>
                        </header>
                        <div style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: rgba(139, 92, 246, 0.08); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 8px; margin-bottom: 12px;">
                            <label style="flex: 1; display: flex; align-items: center; gap: 8px; margin: 0;">
                                <span style="font-size: 0.9rem; color: var(--text-muted); font-weight: 500; white-space: nowrap;">Edit Font Size:</span>
                                <span id="editorFontSizeValue" style="font-size: 0.9rem; color: var(--primary); font-weight: 600; min-width: 40px;">10px</span>
                                <input type="range" id="editorFontSizeSlider" min="8" max="24" value="10" step="1" style="flex: 1; min-width: 120px;">
                            </label>
                        </div>
                        <textarea id="visualEditor" placeholder="Edit chords and lyrics with visual spacing..."></textarea>
                    </div>
                </div>
            </section>

            <div class="preview-container" style="position: relative; padding: 0; overflow: hidden;">
                <div id="pageCounter" style="position: absolute; top: -24px; right: 0; font-size: 11px; color: var(--text-muted); font-weight: 500;">Page 1 of 1 (A4)</div>
                <div id="pagesWrapper" style="display: flex; flex-direction: column; gap: 20px;">
                    <div class="preview-page" data-page="1">
                        <div id="livePreview" class="live-preview" style="min-height: 1123px; border: none; padding: 20px 20px 20px 20px; width: 100%; max-width: 210mm;"></div>
                    </div>
                </div>
            </div>
        </section>

        <section class="editor" id="songbookSection" style="display: none;">
            <div class="editor-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h2>SongBook Format (auto-updated)</h2>
                <button id="toggleSongbookFormat" class="ghost-button" style="padding: 8px 16px; font-size: 0.9rem; background: rgba(139, 92, 246, 0.1); color: var(--primary); border: 1px solid rgba(139, 92, 246, 0.3);">
                    ‚ñº Expand
                </button>
            </div>
            <div id="songbookFormatContent" style="display: none;">
                <div class="editor-panel">
                    <small style="display: block; margin-bottom: 12px; color: var(--text-muted);">Copy this to SongBook app</small>
                    <!-- Font Size Control -->
                    <div style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: rgba(139, 92, 246, 0.08); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 8px; margin-bottom: 12px;">
                        <label style="flex: 1; display: flex; align-items: center; gap: 8px; margin: 0;">
                            <span style="font-size: 0.9rem; color: var(--text-muted); font-weight: 500; white-space: nowrap;">Font Size:</span>
                            <span id="songbookFontSizeValue" style="font-size: 0.9rem; color: var(--primary); font-weight: 600; min-width: 40px;">14px</span>
                            <input type="range" id="songbookFontSizeSlider" min="10" max="24" value="14" step="1" style="flex: 1; min-width: 120px;">
                        </label>
                    </div>
                    <textarea id="songbookOutput" readonly placeholder="SongBook format with [C] brackets will appear here..."></textarea>
                </div>
            </div>
        </section>

        <section class="support-section" id="support" style="max-width: 1100px; margin: 60px auto 80px; padding: 40px 30px; text-align: center; background: linear-gradient(135deg, rgba(255, 59, 92, 0.15) 0%, rgba(139, 92, 246, 0.15) 50%, rgba(59, 130, 246, 0.15) 100%); border-radius: 24px; border: 1px solid rgba(255, 59, 92, 0.2); position: relative; overflow: hidden;">
            <!-- Decorative elements -->
            <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: radial-gradient(circle, rgba(255, 59, 92, 0.3) 0%, transparent 70%); pointer-events: none;"></div>
            <div style="position: absolute; bottom: -30px; left: -30px; width: 100px; height: 100px; background: radial-gradient(circle, rgba(139, 92, 246, 0.3) 0%, transparent 70%); pointer-events: none;"></div>

            <div style="position: relative; z-index: 1;">
                <div style="display: inline-block; background: linear-gradient(135deg, #ff3b5c, #8b5cf6); padding: 8px 20px; border-radius: 20px; margin-bottom: 20px;">
                    <span style="color: white; font-weight: 600; font-size: 0.9rem; letter-spacing: 0.5px;">UNLOCK FULL POWER</span>
                </div>

                <h2 style="font-size: 2.2rem; margin-bottom: 16px; background: linear-gradient(135deg, #ff3b5c 0%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Support ChordsApp</h2>

                <p style="font-size: 1.15rem; color: var(--text-muted, #999); margin-bottom: 28px; line-height: 1.7; max-width: 550px; margin-left: auto; margin-right: auto;">
                    Join thousands of worship leaders using ChordsApp to transform their music ministry
                </p>

                <!-- Feature highlights -->
                <div style="display: flex; justify-content: center; gap: 24px; flex-wrap: wrap; margin-bottom: 32px;">
                    <div style="display: flex; align-items: center; gap: 8px; color: var(--text);">
                        <span style="font-size: 1.3rem;">üéµ</span>
                        <span style="font-size: 0.95rem;">Unlimited AI Scans</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; color: var(--text);">
                        <span style="font-size: 1.3rem;">‚ö°</span>
                        <span style="font-size: 0.95rem;">Priority Processing</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; color: var(--text);">
                        <span style="font-size: 1.3rem;">üíæ</span>
                        <span style="font-size: 0.95rem;">Cloud Sync</span>
                    </div>
                </div>

                <!-- Pricing badges -->
                <div style="display: flex; justify-content: center; gap: 16px; margin-bottom: 28px; flex-wrap: wrap;">
                    <!-- Free tier -->
                    <div style="background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px; padding: 16px 20px; min-width: 140px;">
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">Free</div>
                        <div style="font-size: 1.4rem; font-weight: 700; color: var(--text);">$0</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px; line-height: 1.4;">3 analyses/day<br>Basic features</div>
                    </div>
                    <!-- Basic tier -->
                    <div style="background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px; padding: 16px 20px; min-width: 140px;">
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">Basic</div>
                        <div style="font-size: 1.4rem; font-weight: 700; color: var(--text);">$0.99<span style="font-size: 0.8rem; font-weight: 400; color: var(--text-muted);">/mo</span></div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px; line-height: 1.4;">15 analyses/day<br>Song library</div>
                    </div>
                    <!-- Pro tier -->
                    <div style="background: linear-gradient(135deg, rgba(255, 59, 92, 0.2), rgba(139, 92, 246, 0.2)); border: 2px solid var(--primary); border-radius: 12px; padding: 16px 20px; position: relative; min-width: 140px;">
                        <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; font-size: 0.7rem; padding: 2px 10px; border-radius: 10px; font-weight: 600;">POPULAR</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">Pro</div>
                        <div style="font-size: 1.4rem; font-weight: 700; color: var(--text);">$1.99<span style="font-size: 0.8rem; font-weight: 400; color: var(--text-muted);">/mo</span></div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px; line-height: 1.4;">Unlimited analyses<br>Priority + Cloud sync</div>
                    </div>
                </div>

                <button class="primary-action" onclick="window.showSubscriptionModal()" style="padding: 16px 40px; font-size: 1.15rem; background: linear-gradient(135deg, #ff3b5c 0%, #ff6b8a 100%); box-shadow: 0 8px 30px rgba(255, 59, 92, 0.4); border-radius: 12px; transition: all 0.3s ease;">
                    üöÄ Get Started Now
                </button>

                <p style="margin-top: 16px; font-size: 0.85rem; color: var(--text-muted);">Cancel anytime ‚Ä¢ Secure payment via PayPal</p>
            </div>
        </section>
    </main>

    <footer class="app-footer">
        <p>&copy; <span id="year"></span> The Faith Sound. Built with love for worship leaders and musicians. <span style="opacity: 0.7;">| v1.7 - 26/12/2025</span></p>
        <p style="margin-top: 8px; font-size: 0.85rem;">
            <a href="privacy.html" style="color: var(--text-muted);">Privacy Policy</a> ¬∑
            <a href="terms.html" style="color: var(--text-muted);">Terms of Service</a>
        </p>
    </footer>

    <!-- Hidden print-only formatted version -->
    <div id="printPreview" class="print-only" style="display: none;"></div>

    <!-- Custom Modal -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="modalTitle">Modal Title</h3>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modalMessage">Modal message goes here.</p>
                <input type="number" id="modalInput" class="modal-input" placeholder="10" min="1" step="0.01" style="display: none;">
            </div>
            <div class="modal-footer">
                <button class="ghost-button" id="modalCancel">Cancel</button>
                <button class="primary-action" id="modalConfirm">OK</button>
            </div>
        </div>
    </div>

    <!-- Auth Message Display -->
    <div id="authMessage" style="position: fixed; top: 80px; right: 20px; max-width: 400px; padding: 16px 20px; border-radius: 8px; display: none; z-index: 10000; font-weight: 500;"></div>

    <!-- Authentication Modal -->
    <div id="authModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: var(--surface); border-radius: 20px; padding: 40px; max-width: 450px; width: 90%; position: relative; border: 1px solid rgba(255,255,255,0.1);">
            <button id="closeAuthModal" style="position: absolute; top: 20px; right: 20px; background: transparent; border: none; color: var(--text-muted); font-size: 28px; cursor: pointer; line-height: 1; padding: 0;">&times;</button>

            <!-- Login Form -->
            <div id="loginFormContainer">
                <h2 style="margin-bottom: 10px; color: var(--text); font-size: 1.8rem;">Welcome Back</h2>
                <p style="color: var(--text-muted); margin-bottom: 30px;">Sign in to continue to ChordsApp</p>

                <form id="loginForm">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">Email Address</label>
                        <input type="email" id="loginEmail" placeholder="you@example.com" required style="width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text); font-size: 1rem;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" required style="width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text); font-size: 1rem;">
                    </div>

                    <button type="submit" style="width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px;">Sign In</button>

                    <button type="button" class="google-signin-btn" style="width: 100%; padding: 14px; background: white; color: #333; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M17.6 9.2l-.1-1.8H9v3.4h4.8C13.6 12 13 13 12 13.6v2.2h3a8.8 8.8 0 0 0 2.6-6.6z" fill="#4285F4"/><path d="M9 18c2.4 0 4.5-.8 6-2.2l-3-2.2a5.4 5.4 0 0 1-8-2.9H1V13a9 9 0 0 0 8 5z" fill="#34A853"/><path d="M4 10.7a5.4 5.4 0 0 1 0-3.4V5H1a9 9 0 0 0 0 8l3-2.3z" fill="#FBBC05"/><path d="M9 3.6c1.3 0 2.5.4 3.4 1.3L15 2.3A9 9 0 0 0 1 5l3 2.4a5.4 5.4 0 0 1 5-3.7z" fill="#EA4335"/></g></svg>
                        Continue with Google
                    </button>

                    <div style="text-align: center; margin-top: 20px; color: var(--text-muted);">
                        Don't have an account? <a href="#" id="switchToSignup" style="color: var(--primary); text-decoration: none; font-weight: 500;">Sign up</a>
                        <br><a href="#" id="switchToReset" style="color: var(--primary); text-decoration: none; font-weight: 500;">Forgot password?</a>
                    </div>
                </form>
            </div>

            <!-- Signup Form -->
            <div id="signupFormContainer" style="display: none;">
                <h2 style="margin-bottom: 10px; color: var(--text); font-size: 1.8rem;">Create Account</h2>
                <p style="color: var(--text-muted); margin-bottom: 30px;">Join ChordsApp community</p>

                <form id="signupForm">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">Full Name</label>
                        <input type="text" id="signupName" placeholder="John Doe" required style="width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text); font-size: 1rem;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">Email Address</label>
                        <input type="email" id="signupEmail" placeholder="you@example.com" required style="width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text); font-size: 1rem;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">Password</label>
                        <input type="password" id="signupPassword" placeholder="At least 6 characters" required style="width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text); font-size: 1rem;">
                    </div>

                    <button type="submit" style="width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px;">Create Account</button>

                    <button type="button" class="google-signin-btn" style="width: 100%; padding: 14px; background: white; color: #333; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M17.6 9.2l-.1-1.8H9v3.4h4.8C13.6 12 13 13 12 13.6v2.2h3a8.8 8.8 0 0 0 2.6-6.6z" fill="#4285F4"/><path d="M9 18c2.4 0 4.5-.8 6-2.2l-3-2.2a5.4 5.4 0 0 1-8-2.9H1V13a9 9 0 0 0 8 5z" fill="#34A853"/><path d="M4 10.7a5.4 5.4 0 0 1 0-3.4V5H1a9 9 0 0 0 0 8l3-2.3z" fill="#FBBC05"/><path d="M9 3.6c1.3 0 2.5.4 3.4 1.3L15 2.3A9 9 0 0 0 1 5l3 2.4a5.4 5.4 0 0 1 5-3.7z" fill="#EA4335"/></g></svg>
                        Sign up with Google
                    </button>

                    <div style="text-align: center; margin-top: 20px; color: var(--text-muted);">
                        Already have an account? <a href="#" class="switchToLogin" style="color: var(--primary); text-decoration: none; font-weight: 500;">Sign in</a>
                    </div>
                </form>
            </div>

            <!-- Reset Password Form -->
            <div id="resetFormContainer" style="display: none;">
                <h2 style="margin-bottom: 10px; color: var(--text); font-size: 1.8rem;">Reset Password</h2>
                <p style="color: var(--text-muted); margin-bottom: 30px;">Enter your email to receive a reset link</p>

                <form id="resetForm">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 500;">Email Address</label>
                        <input type="email" id="resetEmail" placeholder="you@example.com" required style="width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text); font-size: 1rem;">
                    </div>

                    <button type="submit" style="width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px;">Send Reset Link</button>

                    <div style="text-align: center; margin-top: 20px; color: var(--text-muted);">
                        Remember your password? <a href="#" class="switchToLogin" style="color: var(--primary); text-decoration: none; font-weight: 500;">Sign in</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Save Song Modal -->
    <div id="saveSongModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3>üíæ Save Song to Library</h3>
                <button class="modal-close" id="saveSongClose">&times;</button>
            </div>
            <div class="modal-body">
                <p>Enter a name for this song:</p>
                <input type="text" id="songNameInput" class="modal-input" placeholder="Song name (e.g., Amazing Grace)" style="display: block;">
            </div>
            <div class="modal-footer">
                <button class="ghost-button" id="saveSongCancel">Cancel</button>
                <button class="primary-action" id="saveSongConfirm">Save</button>
            </div>
        </div>
    </div>

    <!-- Generic Styled Prompt Modal -->
    <div id="styledPromptModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 450px;">
            <div class="modal-header">
                <h3 id="styledPromptTitle">Enter value</h3>
                <button class="modal-close" id="styledPromptClose">&times;</button>
            </div>
            <div class="modal-body">
                <p id="styledPromptMessage">Please enter a value:</p>
                <input type="text" id="styledPromptInput" class="modal-input" placeholder="" style="display: block; width: 100%;">
            </div>
            <div class="modal-footer">
                <button class="ghost-button" id="styledPromptCancel">Cancel</button>
                <button class="primary-action" id="styledPromptConfirm">OK</button>
            </div>
        </div>
    </div>

    <!-- Load Song Modal -->
    <div id="loadSongModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 700px;">
            <div class="modal-header">
                <h3>üìÇ Load Song from Library</h3>
                <button class="modal-close" id="loadSongClose">&times;</button>
            </div>
            <div class="modal-body">
                <p>Select a song from your library:</p>

                <!-- Search and Filters -->
                <div style="display: flex; gap: 12px; margin: 16px 0; flex-wrap: wrap; align-items: center;">
                    <input type="text" id="songSearchInput" class="modal-input" placeholder="üîç Search songs..." style="flex: 1; min-width: 200px;">
                    <button id="bulkSelectToggle" class="ghost-button" style="padding: 8px 14px; font-size: 0.9rem;" title="Select multiple songs">‚òëÔ∏è Select</button>
                    <select id="songKeyFilter" class="modal-input" style="flex: 0 0 auto; min-width: 120px;">
                        <option value="">All Keys</option>
                        <option value="C">C Major</option>
                        <option value="C#">C# Major</option>
                        <option value="Db">Db Major</option>
                        <option value="D">D Major</option>
                        <option value="Eb">Eb Major</option>
                        <option value="E">E Major</option>
                        <option value="F">F Major</option>
                        <option value="F#">F# Major</option>
                        <option value="Gb">Gb Major</option>
                        <option value="G">G Major</option>
                        <option value="Ab">Ab Major</option>
                        <option value="A">A Major</option>
                        <option value="Bb">Bb Major</option>
                        <option value="B">B Major</option>
                        <option value="Am">A Minor</option>
                        <option value="Bm">B Minor</option>
                        <option value="Cm">C Minor</option>
                        <option value="Dm">D Minor</option>
                        <option value="Em">E Minor</option>
                        <option value="Fm">F Minor</option>
                        <option value="Gm">G Minor</option>
                    </select>
                    <select id="songSortBy" class="modal-input" style="flex: 0 0 auto; min-width: 120px;">
                        <option value="date">Latest First</option>
                        <option value="name">A-Z</option>
                        <option value="bpm">BPM</option>
                        <option value="key">Key</option>
                    </select>
                </div>

                <div id="songList" style="max-height: 400px; overflow-y: auto; margin-top: 16px;">
                    <!-- Songs will be loaded here -->
                </div>

                <!-- Bulk Action Bar (hidden by default) -->
                <div id="bulkActionBar" style="display: none; position: sticky; bottom: 0; background: linear-gradient(to top, var(--surface) 80%, transparent); padding: 16px 0 0 0; margin-top: 12px; border-top: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <span id="bulkSelectedCount" style="color: var(--text-muted); font-size: 0.9rem;">0 selected</span>
                        <div style="display: flex; gap: 8px;">
                            <button id="bulkSelectAll" class="ghost-button" style="padding: 8px 14px; font-size: 0.85rem;">Select All</button>
                            <button id="bulkAddToSession" class="primary-button" style="padding: 8px 14px; font-size: 0.85rem; background: #10b981;">‚ûï Add to Session</button>
                            <button id="bulkDeleteBtn" class="primary-button" style="padding: 8px 14px; font-size: 0.85rem; background: #ef4444;">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="ghost-button" id="loadSongCancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Subscription Modal -->
    <div id="subscriptionModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Choose Your Plan</h3>
                <button class="modal-close" id="subscriptionModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Usage Indicator (for logged-in users) -->
                <div id="usageIndicator" style="display: none; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                    <p id="usageText" style="margin: 0; color: #3b82f6; font-size: 14px;"></p>
                </div>

                <!-- Pricing Tiers -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <!-- Free Tier -->
                    <div id="pricing-card-free" class="pricing-card" style="border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 24px; background: var(--surface);">
                        <h3 style="margin: 0 0 8px 0; color: var(--text);">Free</h3>
                        <div style="font-size: 32px; font-weight: 700; color: var(--text); margin-bottom: 16px;">$0</div>
                        <ul style="list-style: none; padding: 0; margin: 0 0 20px 0; font-size: 14px; line-height: 1.8;">
                            <li>‚úì 3 AI analyses/month</li>
                            <li>‚úì Transpose</li>
                            <li>‚úì Print/Export</li>
                            <li style="opacity: 0.5;">‚úó Save to Library</li>
                            <li style="opacity: 0.5;">‚úó Nashville Numbers</li>
                        </ul>
                        <div id="pricing-free-action"></div>
                    </div>

                    <!-- Basic Tier -->
                    <div id="pricing-card-basic" class="pricing-card" style="border: 2px solid rgba(59, 130, 246, 0.5); border-radius: 12px; padding: 24px; background: var(--surface);">
                        <h3 style="margin: 0 0 8px 0; color: #3b82f6;">Basic</h3>
                        <div style="font-size: 32px; font-weight: 700; color: var(--text); margin-bottom: 4px;">$0.99<span style="font-size: 16px; font-weight: 400; color: var(--text-secondary);">/mo</span></div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 16px;">3-day free trial</div>
                        <ul style="list-style: none; padding: 0; margin: 0 0 20px 0; font-size: 14px; line-height: 1.8;">
                            <li>‚úì 20 AI analyses/month</li>
                            <li>‚úì Save to Library</li>
                            <li>‚úì Transpose</li>
                            <li>‚úì Print/Export</li>
                            <li style="opacity: 0.5;">‚úó Nashville Numbers</li>
                        </ul>
                        <div id="pricing-basic-action">
                            <div id="paypal-basic-button" style="min-height: 45px;"></div>
                        </div>
                    </div>

                    <!-- Pro Tier -->
                    <div id="pricing-card-pro" class="pricing-card" style="border: 2px solid var(--primary); border-radius: 12px; padding: 24px; background: var(--surface); position: relative;">
                        <div style="position: absolute; top: -12px; right: 20px; background: var(--primary); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">POPULAR</div>
                        <h3 style="margin: 0 0 8px 0; color: var(--primary);">Pro</h3>
                        <div style="font-size: 32px; font-weight: 700; color: var(--text); margin-bottom: 4px;">$1.99<span style="font-size: 16px; font-weight: 400; color: var(--text-secondary);">/mo</span></div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 16px;">3-day free trial</div>
                        <ul style="list-style: none; padding: 0; margin: 0 0 20px 0; font-size: 14px; line-height: 1.8;">
                            <li>‚úì Unlimited AI analyses</li>
                            <li>‚úì Save to Library</li>
                            <li>‚úì Nashville Numbers</li>
                            <li>‚úì Transpose</li>
                            <li>‚úì Print/Export</li>
                        </ul>
                        <div id="pricing-pro-action">
                            <div id="paypal-pro-button" style="min-height: 45px;"></div>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; font-size: 12px; color: var(--text-secondary);">
                    <p>All plans include 3-day free trial. Cancel anytime. Secure payment via PayPal.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Session Modal -->
    <div id="createSessionModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 500px;">
            <div class="modal-header">
                <h3>üì° Create Live Session</h3>
                <button class="modal-close" onclick="sessionUI.hideCreateSessionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--text-muted);">Create a live session to broadcast songs to your band in real-time.</p>
                <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 600;">Session Title</label>
                <input type="text" id="sessionTitleInput" class="modal-input" placeholder="e.g., Sunday Worship Set 14.11.25" style="display: block; margin-bottom: 16px;">
                <p style="font-size: 13px; color: var(--text-muted);">üí° Tip: Share the session code with your band members so they can join and follow along.</p>
            </div>
            <div class="modal-footer">
                <button class="ghost-button" onclick="sessionUI.hideCreateSessionModal()">Cancel</button>
                <button class="primary-action" onclick="sessionUI.handleCreateSession()">Create Session</button>
            </div>
        </div>
    </div>

    <!-- Join Session Modal -->
    <div id="joinSessionModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 500px;">
            <div class="modal-header">
                <h3>üìª Join Session</h3>
                <button class="modal-close" onclick="sessionUI.hideJoinSessionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--text-muted);">Enter the session code provided by your worship leader.</p>
                <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 600;">Session Code</label>
                <input type="text" id="sessionCodeInput" class="modal-input" placeholder="e.g., A3F-7K2" maxlength="7" style="display: block; margin-bottom: 16px; text-transform: uppercase; font-family: monospace; font-size: 18px; letter-spacing: 2px; text-align: center;">
                <p style="font-size: 13px; color: var(--text-muted);">üí° Tip: You'll be able to adjust font size and transpose locally while following the leader's song selection.</p>
            </div>
            <div class="modal-footer">
                <button class="ghost-button" onclick="sessionUI.hideJoinSessionModal()">Cancel</button>
                <button class="primary-action" onclick="sessionUI.handleJoinSession()">Join Session</button>
            </div>
        </div>
    </div>

    <!-- My Sessions Modal -->
    <div id="mySessionsModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 700px;">
            <div class="modal-header">
                <h3>üìã My Sessions</h3>
                <button class="modal-close" onclick="sessionUI.hideMySessionsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--text-muted);">Your saved and recent sessions</p>
                <div id="sessionsList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Sessions will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="ghost-button" onclick="sessionUI.hideMySessionsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Session Controls Modal -->
    <div id="sessionControlsModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Session Controls</h3>
                <button class="modal-close" onclick="sessionUI.hideSessionControls()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- Participants Panel -->
                    <div>
                        <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px;">
                            üë• Participants
                        </h4>
                        <div id="participantsList" style="max-height: 300px; overflow-y: auto;">
                            <!-- Participants will be loaded here -->
                        </div>
                    </div>

                    <!-- Playlist Panel -->
                    <div>
                        <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px;">
                            üéµ Playlist
                        </h4>
                        <div id="sessionPlaylist" style="max-height: 300px; overflow-y: auto;">
                            <!-- Playlist will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Player Controls (BASIC users) -->
                <div class="player-only" style="padding: 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; margin-bottom: 12px; display: none;">
                    <button class="ghost-button" id="toggleLiveModeBtn" onclick="sessionUI.toggleLiveMode()" style="width: 100%;">
                        üìª Follow Leader: ON
                    </button>
                    <p style="margin: 8px 0 0 0; font-size: 12px; color: var(--text-muted); text-align: center;">
                        Transpose to your key - it's saved per song!
                    </p>
                </div>

                <!-- Leader Controls (PRO users) -->
                <div class="leader-only" style="padding: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; display: none;">
                    <p style="margin: 0; font-size: 13px; color: var(--text-muted); text-align: center;">
                        üí° Change songs in the editor to broadcast to all participants
                    </p>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between;">
                <button class="ghost-button leader-only" onclick="sessionUI.endSession()" style="background: var(--primary); color: white; display: none;">
                    üõë End Session
                </button>
                <button class="ghost-button player-only" onclick="sessionUI.leaveSession()" style="display: none;">
                    üëã Leave Session
                </button>
                <button class="ghost-button" onclick="sessionUI.hideSessionControls()">Close</button>
            </div>
        </div>
    </div>

    <!-- Pads Modal -->
    <div id="padsModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 500px; padding: 0;">
            <div class="modal-header" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(59, 130, 246, 0.2) 100%); border-bottom: 1px solid rgba(139, 92, 246, 0.3);">
                <h3 style="display: flex; align-items: center; gap: 8px;">
                    <span>üéπ</span> Worship Pads
                </h3>
                <button class="modal-close" id="padsModalClose">&times;</button>
            </div>
            <div class="modal-body" style="padding: 16px;">
                <!-- Loading indicator -->
                <div id="padsLoading" style="text-align: center; padding: 40px; display: none;">
                    <div style="font-size: 32px; margin-bottom: 12px;">üéµ</div>
                    <div style="color: var(--text-muted);">Loading pad sounds...</div>
                    <div id="padsLoadingProgress" style="margin-top: 8px; color: var(--primary);">0/12</div>
                </div>

                <!-- Pad Grid -->
                <div id="padsGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                    <button id="pad-key-C" class="pad-key-btn" onclick="padPlayer.toggle('C')">C</button>
                    <button id="pad-key-Csharp" class="pad-key-btn" onclick="padPlayer.toggle('Csharp')">C#</button>
                    <button id="pad-key-D" class="pad-key-btn" onclick="padPlayer.toggle('D')">D</button>
                    <button id="pad-key-Dsharp" class="pad-key-btn" onclick="padPlayer.toggle('Dsharp')">D#</button>
                    <button id="pad-key-E" class="pad-key-btn" onclick="padPlayer.toggle('E')">E</button>
                    <button id="pad-key-F" class="pad-key-btn" onclick="padPlayer.toggle('F')">F</button>
                    <button id="pad-key-Fsharp" class="pad-key-btn" onclick="padPlayer.toggle('Fsharp')">F#</button>
                    <button id="pad-key-G" class="pad-key-btn" onclick="padPlayer.toggle('G')">G</button>
                    <button id="pad-key-Gsharp" class="pad-key-btn" onclick="padPlayer.toggle('Gsharp')">G#</button>
                    <button id="pad-key-A" class="pad-key-btn" onclick="padPlayer.toggle('A')">A</button>
                    <button id="pad-key-Asharp" class="pad-key-btn" onclick="padPlayer.toggle('Asharp')">A#</button>
                    <button id="pad-key-B" class="pad-key-btn" onclick="padPlayer.toggle('B')">B</button>
                </div>

                <!-- Audio Controls -->
                <div style="margin-top: 20px; padding: 16px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">Pads</div>

                    <!-- Crossfade -->
                    <div class="pad-control-row">
                        <span class="pad-control-label">Crossfade</span>
                        <input type="range" id="padsCrossfade" min="10" max="500" value="150" class="pad-slider">
                    </div>

                    <!-- Low Pass -->
                    <div class="pad-control-row">
                        <span class="pad-control-label">Low Pass</span>
                        <input type="range" id="padsLowPass" min="0" max="100" value="100" class="pad-slider">
                    </div>

                    <!-- High Pass -->
                    <div class="pad-control-row">
                        <span class="pad-control-label">High Pass</span>
                        <input type="range" id="padsHighPass" min="0" max="100" value="0" class="pad-slider">
                    </div>

                    <!-- Reverb -->
                    <div class="pad-control-row">
                        <span class="pad-control-label">Reverb</span>
                        <input type="range" id="padsReverb" min="0" max="100" value="30" class="pad-slider">
                    </div>

                    <!-- Pan -->
                    <div class="pad-control-row">
                        <span class="pad-control-label">Pan</span>
                        <input type="range" id="padsPan" min="-100" max="100" value="0" class="pad-slider">
                    </div>

                    <!-- Volume -->
                    <div class="pad-control-row">
                        <span class="pad-control-label">Volume</span>
                        <input type="range" id="padsVolume" min="0" max="100" value="70" class="pad-slider">
                    </div>
                </div>

                <!-- Currently Playing -->
                <div id="padsNowPlaying" style="margin-top: 16px; text-align: center; display: none;">
                    <span style="color: var(--text-muted); font-size: 12px;">Now playing: </span>
                    <span id="padsNowPlayingKey" style="color: #8b5cf6; font-weight: 600;"></span>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid rgba(255,255,255,0.1);">
                <button class="ghost-button" id="padsStopAll" onclick="padPlayer.stopAll()">‚èπÔ∏è Stop All</button>
                <button class="ghost-button" onclick="document.getElementById('padsModal').style.display='none'">Close</button>
            </div>
        </div>
    </div>

    <!-- Pad Key Button Styles -->
    <style>
        .pad-key-btn {
            aspect-ratio: 1;
            border: 2px solid rgba(139, 92, 246, 0.3);
            background: rgba(139, 92, 246, 0.1);
            color: var(--text);
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pad-key-btn:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.5);
            transform: scale(1.02);
        }

        .pad-key-btn:active {
            transform: scale(0.98);
        }

        .pad-key-btn.playing {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.4) 0%, rgba(59, 130, 246, 0.4) 100%);
            border-color: #8b5cf6;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
            animation: padPulse 2s ease-in-out infinite;
        }

        @keyframes padPulse {
            0%, 100% { box-shadow: 0 0 15px rgba(139, 92, 246, 0.3); }
            50% { box-shadow: 0 0 25px rgba(139, 92, 246, 0.5); }
        }

        /* Sharp keys slightly different color */
        .pad-key-btn[id*="sharp"] {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .pad-key-btn[id*="sharp"]:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .pad-key-btn[id*="sharp"].playing {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.4) 0%, rgba(139, 92, 246, 0.4) 100%);
            border-color: #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
        }

        /* Mini pad keys in side menu */
        .mini-pad-key {
            padding: 6px 2px;
            font-size: 10px;
            font-weight: 600;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 4px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mini-pad-key:hover {
            background: rgba(139, 92, 246, 0.25);
            border-color: rgba(139, 92, 246, 0.5);
        }

        .mini-pad-key.playing {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.4) 0%, rgba(59, 130, 246, 0.4) 100%);
            border-color: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
            animation: miniPadPulse 2s ease-in-out infinite;
        }

        @keyframes miniPadPulse {
            0%, 100% { box-shadow: 0 0 8px rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 0 12px rgba(16, 185, 129, 0.6); }
        }

        .mini-pad-key[data-key*="sharp"] {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .mini-pad-key[data-key*="sharp"]:hover {
            background: rgba(59, 130, 246, 0.25);
        }

        .mini-pad-key[data-key*="sharp"].playing {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.4) 0%, rgba(139, 92, 246, 0.4) 100%);
            border-color: #3b82f6;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.4);
        }

        /* Pad control rows */
        .pad-control-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .pad-control-row:last-child {
            margin-bottom: 0;
        }

        .pad-control-label {
            color: var(--text);
            font-size: 14px;
            min-width: 80px;
        }

        .pad-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        .pad-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #8b5cf6;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }

        .pad-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }

        .pad-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #8b5cf6;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }
    </style>

    <!-- Live Mode Full-Screen Overlay -->
    <div id="liveModeOverlay" style="display: none; position: fixed; inset: 0; background: var(--background); z-index: 10000; overflow: hidden;">
        <!-- Main Container with Sidebar Layout -->
        <div style="display: flex; height: 100%; width: 100%;">
            <!-- Song Display Area (tap to toggle sidebar) -->
            <div id="liveModeContent" style="flex: 1; height: 100%; overflow-y: auto; padding: 60px 20px 140px 20px; box-sizing: border-box; cursor: pointer; display: flex; justify-content: center; transition: margin-right 0.3s ease;">
                <div id="liveModeChartDisplay" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; font-size: 14px; line-height: 1.5; white-space: pre-wrap; color: var(--text); margin: 0; max-width: 800px; text-align: left;"></div>
            </div>

            <!-- Playlist Sidebar (slide in from right) -->
            <div id="liveModePlaylistSidebar" style="position: absolute; top: 0; right: -300px; width: 300px; height: 100%; background: var(--card-bg); border-left: 1px solid var(--border); overflow-y: auto; padding: 60px 12px 140px 12px; box-sizing: border-box; transition: right 0.3s ease; z-index: 10002;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0; color: var(--text); font-size: 18px;">Playlist</h3>
                    <button onclick="liveMode.hidePlaylist()" style="background: var(--button-bg); border: none; color: var(--text); width: 32px; height: 32px; border-radius: 6px; cursor: pointer; font-size: 18px;">&times;</button>
                </div>
                <div id="liveModePlaylistContent">
                    <!-- Playlist items will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Top Bar (song info) - auto-hides -->
        <div id="liveModeTopBar" style="position: absolute; top: 0; left: 0; right: 0; padding: 12px 20px; background: var(--card-bg); display: flex; justify-content: space-between; align-items: center; z-index: 10003; border-bottom: 1px solid var(--border); transition: opacity 0.3s ease;">
            <div>
                <div id="liveModeSongName" style="font-size: 18px; font-weight: 600; color: var(--text);"></div>
                <div id="liveModeSongKey" style="font-size: 14px; color: var(--text-muted);"></div>
            </div>
            <button id="liveModeCloseBtn" onclick="liveMode.exit()" style="background: rgba(239, 68, 68, 0.9); border: none; color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                Exit
            </button>
        </div>

        <!-- Bottom Controls Bar - auto-hides -->
        <div id="liveModeBottomBar" style="position: absolute; bottom: 0; left: 0; right: 0; padding: 12px 16px; background: var(--card-bg); z-index: 10003; transition: opacity 0.3s ease;">
            <!-- Transpose Controls -->
            <div style="display: flex; justify-content: center; gap: 8px; margin-bottom: 8px;">
                <button onclick="liveMode.transpose(-1)" style="padding: 8px 16px; background: var(--button-bg); border: 1px solid var(--border); color: var(--text); border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                    -1
                </button>
                <div id="liveModeCurrentKey" style="padding: 8px 18px; background: var(--primary); color: white; border-radius: 6px; font-weight: 600; font-size: 15px; min-width: 40px; text-align: center;">
                    C
                </div>
                <button onclick="liveMode.transpose(1)" style="padding: 8px 16px; background: var(--button-bg); border: 1px solid var(--border); color: var(--text); border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                    +1
                </button>
            </div>

            <!-- Display Options -->
            <div style="display: flex; justify-content: center; gap: 8px; margin-bottom: 8px; align-items: center; flex-wrap: wrap;">
                <select id="liveModeDisplayMode" onchange="liveMode.setDisplayMode(this.value)" style="padding: 7px 12px; background: var(--button-bg); border: 1px solid var(--border); color: var(--text); border-radius: 6px; cursor: pointer; font-size: 13px;">
                    <option value="chords" selected>Chords</option>
                    <option value="both">Nash + Chords</option>
                    <option value="numbers">Nashville</option>
                    <option value="lyrics">Lyrics</option>
                </select>
                <label style="display: flex; align-items: center; gap: 5px; padding: 7px 10px; background: var(--button-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 13px; color: var(--text); user-select: none;">
                    <input type="checkbox" id="liveModeBadges" checked onchange="liveMode.toggleBadges(this.checked)" style="accent-color: var(--primary); cursor: pointer; width: 16px; height: 16px;">
                    <span>Badges</span>
                </label>
                <button id="liveModeFullOverview" onclick="liveMode.toggleFullOverview()" style="padding: 7px 12px; background: var(--button-bg); border: 1px solid var(--border); color: var(--text); border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s ease;">
                    üìÑ Full Overview
                </button>
            </div>

            <!-- Session Info & Playlist Button (if in session) -->
            <div id="liveModeSessionControls" style="display: none; text-align: center;">
                <div style="display: flex; justify-content: center; gap: 12px; align-items: center;">
                    <button id="liveModePlaylistToggle" onclick="liveMode.togglePlaylist()" style="padding: 10px 20px; background: rgba(59, 130, 246, 0.3); border: 1px solid rgba(59, 130, 246, 0.5); color: var(--text); border-radius: 6px; cursor: pointer; font-size: 14px;">
                        Show Playlist
                    </button>
                    <!-- Follow Leader toggle (players only) -->
                    <label id="liveModeFollowLeader" style="display: none; cursor: pointer; padding: 10px 16px; background: rgba(16, 185, 129, 0.3); border: 1px solid rgba(16, 185, 129, 0.5); border-radius: 6px; font-size: 13px; color: var(--text);">
                        <input type="checkbox" id="followLeaderCheckbox" checked onchange="liveMode.toggleFollowLeader(this.checked)" style="margin-right: 6px;">
                        Follow Leader
                    </label>
                </div>
                <div id="liveModeSessionInfo" style="margin-top: 8px; font-size: 12px; color: var(--text-muted);"></div>
            </div>
        </div>
    </div>

    <!-- Theme Toggle -->
    <script src="theme.js?v=4"></script>

    <!-- Firebase Configuration and Auth -->
    <script src="firebase-config.js"></script>
    <script src="auth.js"></script>

    <!-- Subscription System -->
    <script src="subscription.js"></script>
    <script src="paypal-subscription.js"></script>

    <!-- Song Library -->
    <script src="song-library.js"></script>
    <script src="song-search-filter.js"></script>

    <!-- Live Sessions -->
    <script src="session-manager.js"></script>
    <script src="session-ui.js"></script>

    <!-- Live Mode (full-screen performance view) -->
    <script src="live-mode.js"></script>

    <!-- Pad Player -->
    <script src="pad-player.js"></script>

    <script src="app.js?v=42"></script>

    <style>
        /* Auth message states */
        #authMessage.success {
            background: rgba(52, 199, 89, 0.1);
            color: #34c759;
            border: 1px solid rgba(52, 199, 89, 0.2);
        }
        #authMessage.error {
            background: rgba(255, 59, 48, 0.1);
            color: #ff3b30;
            border: 1px solid rgba(255, 59, 48, 0.2);
        }
        #authMessage.info {
            background: rgba(0, 122, 255, 0.1);
            color: #007aff;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }
        #profileMenu button:hover {
            background: var(--background-secondary);
        }

        /* Live Mode theme-aware solid backgrounds */
        [data-theme="dark"] #liveModeOverlay {
            background: #000000 !important;
        }
        [data-theme="light"] #liveModeOverlay {
            background: #ffffff !important;
        }
        [data-theme="dark"] #liveModeContent {
            background: #000000 !important;
        }
        [data-theme="light"] #liveModeContent {
            background: #ffffff !important;
        }
        [data-theme="dark"] #liveModeBottomBar {
            background: #000000 !important;
        }
        [data-theme="light"] #liveModeBottomBar {
            background: #ffffff !important;
        }
        [data-theme="dark"] #liveModeTopBar {
            background: #000000 !important;
        }
        [data-theme="light"] #liveModeTopBar {
            background: #ffffff !important;
        }
        [data-theme="dark"] #liveModePlaylistSidebar {
            background: #000000 !important;
        }
        [data-theme="light"] #liveModePlaylistSidebar {
            background: #ffffff !important;
        }

        /* Hide song header in live mode (title/key shown in top bar) */
        #liveModeChartDisplay .song-header {
            display: none;
        }
        /* Show song header in Full Overview mode */
        #liveModeChartDisplay.full-overview-active .song-header {
            display: block;
            margin-bottom: 16px;
        }
        /* Force single column in Full Overview mode */
        #liveModeChartDisplay.full-overview-active {
            column-count: 1 !important;
            columns: auto !important;
            column-width: auto !important;
            height: auto !important;
            max-width: 100% !important;
            column-gap: 0 !important;
        }
    </style>

    <script>
        // Custom Modal System
        const modal = {
            overlay: document.getElementById('customModal'),
            title: document.getElementById('modalTitle'),
            message: document.getElementById('modalMessage'),
            input: document.getElementById('modalInput'),
            confirmBtn: document.getElementById('modalConfirm'),
            cancelBtn: document.getElementById('modalCancel'),
            closeBtn: document.getElementById('modalClose'),

            show: function(title, message, showInput = false) {
                return new Promise((resolve, reject) => {
                    this.title.textContent = title;
                    this.message.textContent = message;
                    this.input.style.display = showInput ? 'block' : 'none';
                    if (showInput) this.input.value = '10';
                    this.overlay.style.display = 'flex';

                    const handleConfirm = () => {
                        if (showInput) {
                            const value = parseFloat(this.input.value);
                            if (!value || value <= 0) {
                                this.input.style.borderColor = 'var(--primary)';
                                setTimeout(() => {
                                    this.input.style.borderColor = '';
                                }, 500);
                                return;
                            }
                            this.close();
                            resolve(value);
                        } else {
                            this.close();
                            resolve(true);
                        }
                    };

                    const handleCancel = () => {
                        this.close();
                        resolve(null);
                    };

                    this.confirmBtn.onclick = handleConfirm;
                    this.cancelBtn.onclick = handleCancel;
                    this.closeBtn.onclick = handleCancel;
                    this.overlay.onclick = (e) => {
                        if (e.target === this.overlay) handleCancel();
                    };

                    // Enter key support
                    const handleEnter = (e) => {
                        if (e.key === 'Enter') {
                            handleConfirm();
                            document.removeEventListener('keydown', handleEnter);
                        }
                    };
                    document.addEventListener('keydown', handleEnter);
                });
            },

            close: function() {
                this.overlay.style.display = 'none';
                this.input.style.borderColor = '';
            }
        };

        // Save as Image functionality
        (function() {
            const saveAsImageBtn = document.getElementById('saveAsImageButton');
            if (saveAsImageBtn) {
                saveAsImageBtn.addEventListener('click', async function() {
                    const livePreview = document.getElementById('livePreview');
                    if (!livePreview || !livePreview.innerHTML.trim()) {
                        alert('Nothing to save. Please load or create a chord sheet first.');
                        return;
                    }

                    // Show loading state
                    const originalText = saveAsImageBtn.innerHTML;
                    saveAsImageBtn.innerHTML = '‚è≥ Saving...';
                    saveAsImageBtn.disabled = true;

                    try {
                        // Get song title for filename
                        const titleEl = livePreview.querySelector('.song-title');
                        const songTitle = titleEl ? titleEl.textContent.trim().replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '_') : 'chord_sheet';

                        // Create a clone of the preview for capturing
                        const previewContainer = document.querySelector('.preview-container');

                        // Capture the preview
                        const canvas = await html2canvas(previewContainer, {
                            backgroundColor: '#ffffff',
                            scale: 2, // Higher resolution for better quality
                            useCORS: true,
                            logging: false,
                            width: previewContainer.scrollWidth,
                            height: previewContainer.scrollHeight,
                            windowWidth: previewContainer.scrollWidth,
                            windowHeight: previewContainer.scrollHeight
                        });

                        // Convert to image
                        const imageData = canvas.toDataURL('image/png', 1.0);

                        // Check if on mobile (for different save behavior)
                        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

                        if (isMobile) {
                            // On mobile, open image in new tab so user can long-press to save
                            const newTab = window.open();
                            if (newTab) {
                                newTab.document.write(`
                                    <html>
                                    <head>
                                        <title>${songTitle}</title>
                                        <meta name="viewport" content="width=device-width, initial-scale=1">
                                        <style>
                                            body { margin: 0; padding: 20px; background: #f0f0f0; text-align: center; font-family: -apple-system, sans-serif; }
                                            img { max-width: 100%; height: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.2); border-radius: 8px; }
                                            p { color: #666; margin-top: 20px; font-size: 14px; }
                                        </style>
                                    </head>
                                    <body>
                                        <img src="${imageData}" alt="${songTitle}">
                                        <p>üì± Long-press the image to save to your Photos</p>
                                    </body>
                                    </html>
                                `);
                                newTab.document.close();
                            } else {
                                // Fallback: direct download
                                downloadImage(imageData, songTitle);
                            }
                        } else {
                            // On desktop, trigger download
                            downloadImage(imageData, songTitle);
                        }

                        saveAsImageBtn.innerHTML = '‚úÖ Saved!';
                        setTimeout(() => {
                            saveAsImageBtn.innerHTML = originalText;
                            saveAsImageBtn.disabled = false;
                        }, 2000);

                    } catch (error) {
                        console.error('Error saving image:', error);
                        alert('Failed to save image. Please try again.');
                        saveAsImageBtn.innerHTML = originalText;
                        saveAsImageBtn.disabled = false;
                    }
                });
            }

            // Header Save as Image button - triggers the same functionality
            const headerSaveAsImage = document.getElementById('headerSaveAsImage');
            if (headerSaveAsImage && saveAsImageBtn) {
                headerSaveAsImage.addEventListener('click', () => {
                    saveAsImageBtn.click();
                });
            }

            // Header Save Song button
            const headerSaveSong = document.getElementById('headerSaveSong');
            const mainSaveSongBtn = document.getElementById('saveSongButton');
            if (headerSaveSong && mainSaveSongBtn) {
                headerSaveSong.addEventListener('click', () => {
                    mainSaveSongBtn.click();
                });
            }

            // Header Load Song button
            const headerLoadSong = document.getElementById('headerLoadSong');
            const mainLoadSongBtn = document.getElementById('loadSongButton');
            if (headerLoadSong && mainLoadSongBtn) {
                headerLoadSong.addEventListener('click', () => {
                    mainLoadSongBtn.click();
                });
            }

            // Header Pads button
            const headerPadsBtn = document.getElementById('headerPadsBtn');
            if (headerPadsBtn) {
                headerPadsBtn.addEventListener('click', async () => {
                    const padsModal = document.getElementById('padsModal');
                    if (padsModal) {
                        padsModal.style.display = 'flex';

                        // Load sounds if not already loaded
                        if (window.padPlayer && Object.keys(padPlayer.buffers).length === 0) {
                            const loadingDiv = document.getElementById('padsLoading');
                            const gridDiv = document.getElementById('padsGrid');
                            const progressDiv = document.getElementById('padsLoadingProgress');

                            if (loadingDiv) loadingDiv.style.display = 'block';
                            if (gridDiv) gridDiv.style.opacity = '0.3';

                            await padPlayer.loadSounds((loaded, total) => {
                                if (progressDiv) progressDiv.textContent = `${loaded}/${total}`;
                            });

                            if (loadingDiv) loadingDiv.style.display = 'none';
                            if (gridDiv) gridDiv.style.opacity = '1';
                        }
                    }
                });
            }

            function downloadImage(dataUrl, filename) {
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = `${filename}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        })();

        // Hide header on scroll
        (function() {
            const header = document.querySelector('.app-header');
            let lastScrollTop = 0;
            let isScrolling;

            window.addEventListener('scroll', function() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

                // Clear timeout if scrolling
                clearTimeout(isScrolling);

                if (scrollTop > lastScrollTop && scrollTop > 100) {
                    // Scrolling down - hide header
                    header.style.transform = 'translateY(-100%)';
                    header.style.transition = 'transform 0.3s ease-in-out';
                } else {
                    // Scrolling up - show header
                    header.style.transform = 'translateY(0)';
                    header.style.transition = 'transform 0.3s ease-in-out';
                }

                lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
            }, false);
        })();

        // ============================================
        // SIDE MENU - Toggle & Control Sync
        // ============================================
        (function() {
            const hamburgerBtn = document.getElementById('sideMenuToggle');
            const sideMenuPanel = document.getElementById('sideMenuPanel');
            const sideMenuOverlay = document.getElementById('sideMenuOverlay');
            const sideMenuClose = document.getElementById('sideMenuClose');

            // Toggle menu
            function openMenu() {
                hamburgerBtn.classList.add('active');
                sideMenuPanel.classList.add('active');
                sideMenuOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            function closeMenu() {
                hamburgerBtn.classList.remove('active');
                sideMenuPanel.classList.remove('active');
                sideMenuOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }

            if (hamburgerBtn) {
                hamburgerBtn.addEventListener('click', () => {
                    if (sideMenuPanel.classList.contains('active')) {
                        closeMenu();
                    } else {
                        openMenu();
                    }
                });
            }

            if (sideMenuOverlay) {
                sideMenuOverlay.addEventListener('click', closeMenu);
            }

            if (sideMenuClose) {
                sideMenuClose.addEventListener('click', closeMenu);
            }

            // Close on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && sideMenuPanel.classList.contains('active')) {
                    closeMenu();
                }
            });

            // ---- SYNC SIDEBAR CONTROLS WITH MAIN CONTROLS ----

            // Quick Actions: Print
            const sideMenuPrint = document.getElementById('sideMenuPrint');
            const mainPrintBtn = document.getElementById('printButton');
            if (sideMenuPrint && mainPrintBtn) {
                sideMenuPrint.addEventListener('click', () => {
                    closeMenu();
                    mainPrintBtn.click();
                });
            }

            // Quick Actions: Save as Image (use existing saveAsImageButton)
            const sideMenuSaveImage = document.getElementById('saveAsImageButton');
            // Already has its own event listener

            // Quick Actions: Live Preview toggle
            const sideMenuLivePreview = document.getElementById('livePreviewToggle');
            const mainLivePreviewBtn = document.getElementById('livePreviewBtn');
            if (sideMenuLivePreview && mainLivePreviewBtn) {
                sideMenuLivePreview.addEventListener('click', () => {
                    closeMenu();
                    mainLivePreviewBtn.click();
                });
            }

            // Quick Actions: Save Layout
            const sideMenuSaveLayout = document.getElementById('saveLayoutButton');
            const mainSaveLayoutBtn = document.getElementById('saveLayoutBtn');
            if (sideMenuSaveLayout && mainSaveLayoutBtn) {
                sideMenuSaveLayout.addEventListener('click', () => {
                    closeMenu();
                    mainSaveLayoutBtn.click();
                });
            }

            // Display: Nashville Mode sync
            const sideMenuNashvilleMode = document.getElementById('sideMenuNashvilleMode');
            const mainNashvilleMode = document.getElementById('nashvilleMode');
            if (sideMenuNashvilleMode && mainNashvilleMode) {
                // Sync initial value
                sideMenuNashvilleMode.value = mainNashvilleMode.value;

                // Side menu changes main
                sideMenuNashvilleMode.addEventListener('change', () => {
                    mainNashvilleMode.value = sideMenuNashvilleMode.value;
                    mainNashvilleMode.dispatchEvent(new Event('change'));
                });

                // Main changes side menu
                mainNashvilleMode.addEventListener('change', () => {
                    sideMenuNashvilleMode.value = mainNashvilleMode.value;
                });
            }

            // Display: Font Size sync
            const sideMenuFontSize = document.getElementById('sideMenuFontSize');
            const sideMenuFontSizeVal = document.getElementById('sideMenuFontSizeVal');
            const mainFontSize = document.getElementById('fontSizeSlider');
            const mainFontSizeVal = document.getElementById('fontSizeValue');
            if (sideMenuFontSize && mainFontSize) {
                // Sync initial value
                sideMenuFontSize.value = mainFontSize.value;
                if (sideMenuFontSizeVal) sideMenuFontSizeVal.textContent = mainFontSize.value + 'pt';

                sideMenuFontSize.addEventListener('input', () => {
                    mainFontSize.value = sideMenuFontSize.value;
                    mainFontSize.dispatchEvent(new Event('input'));
                    if (sideMenuFontSizeVal) sideMenuFontSizeVal.textContent = sideMenuFontSize.value + 'pt';
                });

                mainFontSize.addEventListener('input', () => {
                    sideMenuFontSize.value = mainFontSize.value;
                    if (sideMenuFontSizeVal) sideMenuFontSizeVal.textContent = mainFontSize.value + 'pt';
                });
            }

            // Display: Line Height sync
            const sideMenuLineHeight = document.getElementById('sideMenuLineHeight');
            const sideMenuLineHeightVal = document.getElementById('sideMenuLineHeightVal');
            const mainLineHeight = document.getElementById('lineHeightSlider');
            if (sideMenuLineHeight && mainLineHeight) {
                sideMenuLineHeight.value = mainLineHeight.value;
                if (sideMenuLineHeightVal) sideMenuLineHeightVal.textContent = mainLineHeight.value;

                sideMenuLineHeight.addEventListener('input', () => {
                    mainLineHeight.value = sideMenuLineHeight.value;
                    mainLineHeight.dispatchEvent(new Event('input'));
                    if (sideMenuLineHeightVal) sideMenuLineHeightVal.textContent = sideMenuLineHeight.value;
                });

                mainLineHeight.addEventListener('input', () => {
                    sideMenuLineHeight.value = mainLineHeight.value;
                    if (sideMenuLineHeightVal) sideMenuLineHeightVal.textContent = mainLineHeight.value;
                });
            }

            // Display: Char Spacing sync
            const sideMenuCharSpacing = document.getElementById('sideMenuCharSpacing');
            const sideMenuCharSpacingVal = document.getElementById('sideMenuCharSpacingVal');
            const mainCharSpacing = document.getElementById('charSpacingSlider');
            if (sideMenuCharSpacing && mainCharSpacing) {
                sideMenuCharSpacing.value = mainCharSpacing.value;
                if (sideMenuCharSpacingVal) sideMenuCharSpacingVal.textContent = mainCharSpacing.value + 'px';

                sideMenuCharSpacing.addEventListener('input', () => {
                    mainCharSpacing.value = sideMenuCharSpacing.value;
                    mainCharSpacing.dispatchEvent(new Event('input'));
                    if (sideMenuCharSpacingVal) sideMenuCharSpacingVal.textContent = sideMenuCharSpacing.value + 'px';
                });

                mainCharSpacing.addEventListener('input', () => {
                    sideMenuCharSpacing.value = mainCharSpacing.value;
                    if (sideMenuCharSpacingVal) sideMenuCharSpacingVal.textContent = mainCharSpacing.value + 'px';
                });
            }

            // Display: Badges sync
            const sideMenuBadges = document.getElementById('sideMenuBadges');
            const mainBadges = document.getElementById('showBadges');
            if (sideMenuBadges && mainBadges) {
                sideMenuBadges.checked = mainBadges.checked;

                sideMenuBadges.addEventListener('change', () => {
                    mainBadges.checked = sideMenuBadges.checked;
                    mainBadges.dispatchEvent(new Event('change'));
                });

                mainBadges.addEventListener('change', () => {
                    sideMenuBadges.checked = mainBadges.checked;
                });
            }

            // Layout: Columns sync
            const sideMenuColumns = document.getElementById('sideMenuColumns');
            const mainColumns = document.getElementById('columnCount');
            if (sideMenuColumns && mainColumns) {
                sideMenuColumns.value = mainColumns.value;

                sideMenuColumns.addEventListener('change', () => {
                    mainColumns.value = sideMenuColumns.value;
                    mainColumns.dispatchEvent(new Event('change'));
                });

                mainColumns.addEventListener('change', () => {
                    sideMenuColumns.value = mainColumns.value;
                });
            }

            // Layout: Pages sync
            const sideMenuPages = document.getElementById('sideMenuPages');
            const mainPages = document.getElementById('pageCount');
            if (sideMenuPages && mainPages) {
                sideMenuPages.value = mainPages.value;

                sideMenuPages.addEventListener('change', () => {
                    mainPages.value = sideMenuPages.value;
                    mainPages.dispatchEvent(new Event('change'));
                });

                mainPages.addEventListener('change', () => {
                    sideMenuPages.value = mainPages.value;
                });
            }

            // Layout: Auto-fit
            const sideMenuAutoFit = document.getElementById('sideMenuAutoFit');
            const mainAutoFit = document.getElementById('autoFitButton');
            if (sideMenuAutoFit && mainAutoFit) {
                sideMenuAutoFit.addEventListener('click', () => {
                    mainAutoFit.click();
                });
            }

            // Transpose: Key selector sync
            const sideMenuKey = document.getElementById('sideMenuKey');
            const mainKey = document.getElementById('keySelector');
            if (sideMenuKey && mainKey) {
                sideMenuKey.value = mainKey.value;

                sideMenuKey.addEventListener('change', () => {
                    mainKey.value = sideMenuKey.value;
                    mainKey.dispatchEvent(new Event('change'));
                });

                mainKey.addEventListener('change', () => {
                    sideMenuKey.value = mainKey.value;
                    // Update key grid active state
                    updateKeyGrid(mainKey.value);
                });
            }

            // Transpose: Key grid buttons
            const keyBtns = document.querySelectorAll('.key-btn');
            function updateKeyGrid(keyValue) {
                const keyLetter = keyValue.split(' ')[0];
                keyBtns.forEach(btn => {
                    if (btn.dataset.key === keyLetter) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }

            keyBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const keyLetter = btn.dataset.key;
                    // Find matching major key in selector
                    const mainKey = document.getElementById('keySelector');
                    if (mainKey) {
                        const majorKey = keyLetter + ' Major';
                        if ([...mainKey.options].some(opt => opt.value === majorKey)) {
                            mainKey.value = majorKey;
                            mainKey.dispatchEvent(new Event('change'));
                        }
                    }
                    updateKeyGrid(keyLetter + ' Major');
                });
            });

            // Transpose: Transpose buttons
            const sideMenuTransposeDown = document.getElementById('sideMenuTransposeDown');
            const sideMenuTransposeUp = document.getElementById('sideMenuTransposeUp');
            const sideMenuTransposeReset = document.getElementById('sideMenuTransposeReset');
            const sideMenuTransposeVal = document.getElementById('sideMenuTransposeVal');
            const mainTransposeDown = document.getElementById('transposeDown');
            const mainTransposeUp = document.getElementById('transposeUp');
            const mainTransposeReset = document.getElementById('transposeReset');
            const mainTransposeVal = document.getElementById('transposeValue');

            function syncTransposeValue() {
                if (mainTransposeVal && sideMenuTransposeVal) {
                    sideMenuTransposeVal.textContent = mainTransposeVal.textContent || '0';
                }
            }

            if (sideMenuTransposeDown && mainTransposeDown) {
                sideMenuTransposeDown.addEventListener('click', () => {
                    mainTransposeDown.click();
                    setTimeout(syncTransposeValue, 50);
                });
            }

            if (sideMenuTransposeUp && mainTransposeUp) {
                sideMenuTransposeUp.addEventListener('click', () => {
                    mainTransposeUp.click();
                    setTimeout(syncTransposeValue, 50);
                });
            }

            if (sideMenuTransposeReset && mainTransposeReset) {
                sideMenuTransposeReset.addEventListener('click', () => {
                    mainTransposeReset.click();
                    setTimeout(syncTransposeValue, 50);
                });
            }

            // Song Info: BPM sync
            const sideMenuBPM = document.getElementById('sideMenuBPM');
            const mainBPM = document.getElementById('bpmInput');
            if (sideMenuBPM && mainBPM) {
                sideMenuBPM.value = mainBPM.value;

                sideMenuBPM.addEventListener('input', () => {
                    mainBPM.value = sideMenuBPM.value;
                    mainBPM.dispatchEvent(new Event('input'));
                });

                mainBPM.addEventListener('input', () => {
                    sideMenuBPM.value = mainBPM.value;
                });
            }

            // Song Info: Time signature sync
            const sideMenuTime = document.getElementById('sideMenuTime');
            const mainTime = document.getElementById('timeSignature');
            if (sideMenuTime && mainTime) {
                sideMenuTime.value = mainTime.value;

                sideMenuTime.addEventListener('change', () => {
                    mainTime.value = sideMenuTime.value;
                    mainTime.dispatchEvent(new Event('change'));
                });

                mainTime.addEventListener('change', () => {
                    sideMenuTime.value = mainTime.value;
                });
            }

            // Library: Save Song
            const sideMenuSave = document.getElementById('sideMenuSave');
            const mainSave = document.getElementById('saveButton');
            if (sideMenuSave && mainSave) {
                sideMenuSave.addEventListener('click', () => {
                    closeMenu();
                    mainSave.click();
                });
            }

            // Library: Load Song
            const sideMenuLoad = document.getElementById('sideMenuLoad');
            const mainLoad = document.getElementById('loadButton');
            if (sideMenuLoad && mainLoad) {
                sideMenuLoad.addEventListener('click', () => {
                    closeMenu();
                    mainLoad.click();
                });
            }

            // Library: Bulk Import
            const sideMenuBulkImport = document.getElementById('sideMenuBulkImport');
            const mainBulkImport = document.getElementById('bulkImportButton');
            if (sideMenuBulkImport && mainBulkImport) {
                sideMenuBulkImport.addEventListener('click', () => {
                    closeMenu();
                    mainBulkImport.click();
                });
            }

            // Library: Update Song
            const sideMenuUpdate = document.getElementById('sideMenuUpdate');
            const mainUpdate = document.getElementById('updateButton');
            if (sideMenuUpdate && mainUpdate) {
                sideMenuUpdate.addEventListener('click', () => {
                    closeMenu();
                    mainUpdate.click();
                });
            }

            // Live Sessions: Create Session
            const sideMenuCreateSession = document.getElementById('sideMenuCreateSession');
            if (sideMenuCreateSession) {
                sideMenuCreateSession.addEventListener('click', () => {
                    closeMenu();
                    if (window.sessionUI) {
                        sessionUI.showCreateSessionModal();
                    }
                });
            }

            // Live Sessions: Join Session
            const sideMenuJoinSession = document.getElementById('sideMenuJoinSession');
            if (sideMenuJoinSession) {
                sideMenuJoinSession.addEventListener('click', () => {
                    closeMenu();
                    if (window.sessionUI) {
                        sessionUI.showJoinSessionModal();
                    }
                });
            }

            // Live Sessions: My Sessions
            const sideMenuMySessions = document.getElementById('sideMenuMySessions');
            if (sideMenuMySessions) {
                sideMenuMySessions.addEventListener('click', () => {
                    closeMenu();
                    if (window.sessionUI) {
                        sessionUI.showMySessionsModal();
                    }
                });
            }

            // Live Sessions: Go Live
            const sideMenuGoLive = document.getElementById('sideMenuGoLive');
            if (sideMenuGoLive) {
                sideMenuGoLive.addEventListener('click', () => {
                    closeMenu();
                    if (window.liveMode) {
                        liveMode.enter();
                    }
                });
            }

            // Pads: Mini player keys in side menu
            const miniPadsGrid = document.getElementById('miniPadsGrid');
            if (miniPadsGrid) {
                miniPadsGrid.addEventListener('click', async (e) => {
                    const btn = e.target.closest('.mini-pad-key');
                    if (!btn) return;

                    const key = btn.dataset.key;
                    if (!key) return;

                    // Load sounds if not already loaded
                    if (window.padPlayer && Object.keys(padPlayer.buffers).length === 0) {
                        btn.textContent = '...';
                        await padPlayer.loadSounds();
                        btn.textContent = padPlayer.keyDisplayNames[key] || key;
                    }

                    padPlayer.toggle(key);
                });
            }

            // Pads: Mini player volume slider
            const miniPadVolume = document.getElementById('miniPadVolume');
            if (miniPadVolume) {
                miniPadVolume.addEventListener('input', () => {
                    padPlayer.setVolume(miniPadVolume.value / 100);
                    // Sync with modal volume slider
                    const modalVolume = document.getElementById('padsVolume');
                    if (modalVolume) modalVolume.value = miniPadVolume.value;
                });
            }

            // Pads: Open Pads Modal (Full Controls)
            const sideMenuOpenPads = document.getElementById('sideMenuOpenPads');
            if (sideMenuOpenPads) {
                sideMenuOpenPads.addEventListener('click', async () => {
                    closeMenu();
                    const padsModal = document.getElementById('padsModal');
                    if (padsModal) {
                        padsModal.style.display = 'flex';

                        // Load sounds if not already loaded
                        if (window.padPlayer && Object.keys(padPlayer.buffers).length === 0) {
                            const loadingDiv = document.getElementById('padsLoading');
                            const gridDiv = document.getElementById('padsGrid');
                            const progressDiv = document.getElementById('padsLoadingProgress');

                            if (loadingDiv) loadingDiv.style.display = 'block';
                            if (gridDiv) gridDiv.style.opacity = '0.3';

                            await padPlayer.loadSounds((loaded, total) => {
                                if (progressDiv) progressDiv.textContent = `${loaded}/${total}`;
                            });

                            if (loadingDiv) loadingDiv.style.display = 'none';
                            if (gridDiv) gridDiv.style.opacity = '1';
                        }
                    }
                });
            }

            // Pads Modal: Close button
            const padsModalClose = document.getElementById('padsModalClose');
            if (padsModalClose) {
                padsModalClose.addEventListener('click', () => {
                    const padsModal = document.getElementById('padsModal');
                    if (padsModal) padsModal.style.display = 'none';
                });
            }

            // Pads Modal: Click outside to close
            const padsModal = document.getElementById('padsModal');
            if (padsModal) {
                padsModal.addEventListener('click', (e) => {
                    if (e.target === padsModal) {
                        padsModal.style.display = 'none';
                    }
                });
            }

            // Pads Controls: Set up all sliders
            const padsCrossfade = document.getElementById('padsCrossfade');
            const padsLowPass = document.getElementById('padsLowPass');
            const padsHighPass = document.getElementById('padsHighPass');
            const padsReverb = document.getElementById('padsReverb');
            const padsPan = document.getElementById('padsPan');
            const padsVolume = document.getElementById('padsVolume');

            if (padsCrossfade) {
                padsCrossfade.addEventListener('input', () => {
                    // Convert 10-500 to 0.1-5 seconds
                    padPlayer.setCrossfade(padsCrossfade.value / 100);
                });
            }

            if (padsLowPass) {
                padsLowPass.addEventListener('input', () => {
                    // 0-100 maps to filter frequency
                    padPlayer.setLowPass(padsLowPass.value / 100);
                });
            }

            if (padsHighPass) {
                padsHighPass.addEventListener('input', () => {
                    // 0-100 maps to filter frequency
                    padPlayer.setHighPass(padsHighPass.value / 100);
                });
            }

            if (padsReverb) {
                padsReverb.addEventListener('input', () => {
                    // 0-100 maps to 0-1
                    padPlayer.setReverb(padsReverb.value / 100);
                });
            }

            if (padsPan) {
                padsPan.addEventListener('input', () => {
                    // -100 to 100 maps to -1 to 1
                    padPlayer.setPan(padsPan.value / 100);
                });
            }

            if (padsVolume) {
                padsVolume.addEventListener('input', () => {
                    padPlayer.setVolume(padsVolume.value / 100);
                    // Sync with mini player volume slider
                    const miniVolume = document.getElementById('miniPadVolume');
                    if (miniVolume) miniVolume.value = padsVolume.value;
                });
            }

            // Initialize key grid based on current key
            if (mainKey) {
                updateKeyGrid(mainKey.value);
            }

            // Display: Show Main Controls toggle
            const sideMenuShowControls = document.getElementById('sideMenuShowControls');
            const editorActionsSection = document.querySelector('.editor-actions-section');
            const sessionSection = document.querySelector('.session-section');
            const advancedControls = document.getElementById('advancedControls');

            function setMainControlsVisibility(visible) {
                if (visible) {
                    // Show all controls
                    if (editorActionsSection) editorActionsSection.style.display = '';
                    if (sessionSection) sessionSection.style.display = '';
                    if (advancedControls) advancedControls.style.display = 'flex';
                } else {
                    // Hide all controls
                    if (editorActionsSection) editorActionsSection.style.display = 'none';
                    if (sessionSection) sessionSection.style.display = 'none';
                    if (advancedControls) advancedControls.style.display = 'none';
                }
            }

            if (sideMenuShowControls) {
                // Load saved preference or use default (checked)
                const savedShowControls = localStorage.getItem('chordsapp-show-controls');
                const showControls = savedShowControls !== null ? savedShowControls === 'true' : true;
                sideMenuShowControls.checked = showControls;
                // Always apply visibility on load
                setMainControlsVisibility(showControls);

                sideMenuShowControls.addEventListener('change', () => {
                    const show = sideMenuShowControls.checked;
                    setMainControlsVisibility(show);
                    localStorage.setItem('chordsapp-show-controls', show);
                });
            }

            // Display: Show Edit Workspace toggle
            const sideMenuShowEditor = document.getElementById('sideMenuShowEditor');
            const editorSection = document.getElementById('editor');

            if (sideMenuShowEditor && editorSection) {
                // Load saved preference or use default (unchecked/hidden)
                const savedShowEditor = localStorage.getItem('chordsapp-show-editor');
                const showEditor = savedShowEditor === 'true';
                sideMenuShowEditor.checked = showEditor;
                editorSection.style.display = showEditor ? 'block' : 'none';

                sideMenuShowEditor.addEventListener('change', () => {
                    const show = sideMenuShowEditor.checked;
                    editorSection.style.display = show ? 'block' : 'none';
                    localStorage.setItem('chordsapp-show-editor', show);
                });
            }

            // Display: Show SongBook Format toggle
            const sideMenuShowSongbook = document.getElementById('sideMenuShowSongbook');
            const songbookSection = document.getElementById('songbookSection');

            if (sideMenuShowSongbook && songbookSection) {
                // Load saved preference or use default (unchecked/hidden)
                const savedShowSongbook = localStorage.getItem('chordsapp-show-songbook');
                const showSongbook = savedShowSongbook === 'true';
                sideMenuShowSongbook.checked = showSongbook;
                songbookSection.style.display = showSongbook ? 'block' : 'none';

                sideMenuShowSongbook.addEventListener('change', () => {
                    const show = sideMenuShowSongbook.checked;
                    songbookSection.style.display = show ? 'block' : 'none';
                    localStorage.setItem('chordsapp-show-songbook', show);
                    // Sync toggle button
                    const toggleBtn = document.getElementById('toggleSongbookBtn');
                    if (toggleBtn) toggleBtn.classList.toggle('active', show);
                });
            }

            // ============================================
            // DISPLAY TOGGLE BUTTONS (Controls & Editor)
            // ============================================

            // Helper to sync all toggle buttons with same function
            function syncToggleButtons(btn1Id, btn2Id, checkbox) {
                const btn1 = document.getElementById(btn1Id);
                const btn2 = document.getElementById(btn2Id);

                [btn1, btn2].forEach(btn => {
                    if (btn && checkbox) {
                        btn.classList.toggle('active', checkbox.checked);
                        btn.addEventListener('click', () => {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        });
                    }
                });

                // Sync when checkbox changes
                if (checkbox) {
                    checkbox.addEventListener('change', () => {
                        [btn1, btn2].forEach(btn => {
                            if (btn) btn.classList.toggle('active', checkbox.checked);
                        });
                    });
                }
            }

            // Connect toggle buttons to side menu checkboxes
            syncToggleButtons('toggleControlsBtn', 'toggleControlsBtn2', sideMenuShowControls);
            syncToggleButtons('toggleEditorBtn', 'toggleEditorBtn2', sideMenuShowEditor);
        })();

    </script>

</body>
</html>
