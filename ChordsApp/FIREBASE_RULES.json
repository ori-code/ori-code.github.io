{
  "rules": {
    "users": {
      "$uid": {
        // Subscription data - Can CREATE if doesn't exist, but can't UPDATE
        "subscription": {
          ".read": "$uid === auth.uid",
          ".write": "$uid === auth.uid && !data.exists()"
        },

        // Usage data - Can CREATE if doesn't exist, but can't UPDATE
        "usage": {
          ".read": "$uid === auth.uid",
          ".write": "$uid === auth.uid && !data.exists()"
        },

        // Bonus analyses - Server only (for giving away free analyses)
        "bonusAnalyses": {
          ".read": "$uid === auth.uid",
          ".write": false
        },

        // Songs - Users can read/write their own songs
        "songs": {
          ".read": "$uid === auth.uid",
          ".write": "$uid === auth.uid",
          "$songId": {
            ".validate": "newData.hasChildren(['name', 'content', 'createdAt'])"
          }
        },

        // User's saved sessions - Users can read/write their own session list
        "sessions": {
          ".read": "$uid === auth.uid",
          ".write": "$uid === auth.uid"
        }
      }
    },

    // Live Sessions - Public read for participants, leader can write
    "sessions": {
      "$sessionId": {
        ".read": "auth != null",

        "metadata": {
          ".write": "auth.uid === data.child('leaderId').val() || !data.exists()"
        },

        "currentSong": {
          ".write": "root.child('sessions').child($sessionId).child('metadata').child('leaderId').val() === auth.uid"
        },

        "playlist": {
          ".write": "root.child('sessions').child($sessionId).child('metadata').child('leaderId').val() === auth.uid"
        },

        "participants": {
          "$participantUid": {
            ".write": "$participantUid === auth.uid"
          }
        }
      }
    }
  }
}
